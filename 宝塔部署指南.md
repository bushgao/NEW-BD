# Zilo 系统宝塔部署指南

## 服务器信息
- **公网 IP**: 101.43.69.38
- **域名**: zilohq.com（已审核通过）
- **服务器配置**: 4核4GB 轻量应用服务器
- **操作系统**: 宝塔Linux面板 11.4.0

---

## 第一步：登录宝塔面板（5分钟）

### 1.1 获取宝塔面板信息

在服务器终端（TAT 本地连接）中运行：

```bash
bt default
```

这会显示：
- 宝塔面板地址（例如：http://101.43.69.38:8888/xxxxxxxx）
- 用户名
- 密码

### 1.2 访问宝塔面板

1. 在浏览器中打开宝塔面板地址
2. 输入用户名和密码登录
3. 首次登录可能需要绑定宝塔账号（可以跳过）

---

## 第二步：安装必要软件（15分钟）

在宝塔面板左侧菜单，点击"软件商店"，搜索并安装以下软件：

### 2.1 安装 Nginx（Web 服务器）
- 搜索 "Nginx"
- 点击"安装"
- 选择"编译安装"或"极速安装"（推荐极速安装，更快）
- 等待安装完成（约3分钟）

### 2.2 安装 PostgreSQL 14（数据库）
- 搜索 "PostgreSQL"
- 选择版本 14.x
- 点击"安装"
- 等待安装完成（约5分钟）

### 2.3 安装 PM2 管理器（进程管理）
- 搜索 "PM2"
- 点击"安装"
- 等待安装完成（约2分钟）

### 2.4 安装 Node.js 18
- 搜索 "Node.js"
- 选择版本 18.x
- 点击"安装"
- 等待安装完成（约3分钟）

**安装完成后，点击左侧菜单"首页"，确认所有软件都显示"运行中"状态。**

---

## 第三步：配置防火墙（2分钟）

在宝塔面板左侧菜单，点击"安全"：

### 3.1 开放必要端口
确保以下端口已开放：
- ✅ 80（HTTP）
- ✅ 443（HTTPS）
- ✅ 8888（宝塔面板）

### 3.2 关闭不必要的端口
- ❌ 3000（后端端口，仅内网访问）
- ❌ 5432（PostgreSQL，仅内网访问）

---

## 第四步：配置数据库（5分钟）

### 4.1 创建数据库

1. 在宝塔面板左侧菜单，点击"数据库"
2. 点击"PostgreSQL"标签
3. 点击"添加数据库"按钮
4. 填写信息：
   - **数据库名**: `zilo_production`
   - **用户名**: `zilo`
   - **密码**: 点击"随机密码"生成强密码（**请保存这个密码！**）
5. 点击"提交"

### 4.2 记录数据库信息

**请把以下信息记录下来（稍后配置时需要）：**
- 数据库名: `zilo_production`
- 用户名: `zilo`
- 密码: `[刚才生成的密码]`
- 主机: `localhost`
- 端口: `5432`

---

## 第五步：克隆代码（5分钟）

### 5.1 使用宝塔终端

1. 在宝塔面板左侧菜单，点击"终端"
2. 点击"打开终端"按钮

### 5.2 克隆 GitHub 代码

在终端中依次运行以下命令：

```bash
# 进入网站根目录
cd /www/wwwroot

# 克隆代码
git clone https://github.com/bushgao/NEW-BD.git zilo

# 进入项目目录
cd zilo

# 查看项目结构
ls -la
```

**如果克隆成功，你会看到 `packages` 文件夹和其他项目文件。**

---

## 第六步：生成安全密钥（3分钟）

在宝塔终端中运行以下命令生成强随机密钥：

```bash
# 生成 JWT 密钥（64位）
openssl rand -base64 64

# 再运行一次，生成 JWT Refresh 密钥
openssl rand -base64 64
```

**请保存这两个密钥！稍后配置环境变量时需要。**

---

## 第七步：配置环境变量（5分钟）

### 7.1 创建后端环境变量文件

在宝塔终端中运行：

```bash
cd /www/wwwroot/zilo/packages/backend
cp .env.example .env
```

### 7.2 编辑环境变量

在宝塔面板左侧菜单，点击"文件"，导航到：
`/www/wwwroot/zilo/packages/backend/.env`

点击文件，选择"编辑"，替换为以下内容：

```env
# 生产环境
NODE_ENV=production
PORT=3000

# 数据库配置（PostgreSQL）
DATABASE_URL="postgresql://zilo:[数据库密码]@localhost:5432/zilo_production?schema=public"

# JWT 密钥（使用刚才生成的密钥）
JWT_SECRET="[第一个生成的密钥]"
JWT_EXPIRES_IN="7d"
JWT_REFRESH_SECRET="[第二个生成的密钥]"
JWT_REFRESH_EXPIRES_IN="30d"

# CORS 配置（允许域名访问）
CORS_ORIGIN="https://zilohq.com,http://zilohq.com,http://101.43.69.38"
```

**重要提示：**
- 把 `[数据库密码]` 替换为第四步记录的数据库密码
- 把 `[第一个生成的密钥]` 和 `[第二个生成的密钥]` 替换为第六步生成的密钥
- 保存文件

---

## 第八步：安装依赖和构建（15分钟）

在宝塔终端中依次运行以下命令：

### 8.1 安装根目录依赖

```bash
cd /www/wwwroot/zilo
npm install
```

### 8.2 构建后端

```bash
cd packages/backend
npm install
npx prisma generate
npx prisma migrate deploy
npm run build
```

### 8.3 构建前端

```bash
cd ../frontend
npm install
npm run build
```

**构建完成后，你会在 `packages/frontend/dist` 目录下看到构建好的静态文件。**

---

## 第九步：配置 Nginx（10分钟）

### 9.1 创建网站

1. 在宝塔面板左侧菜单，点击"网站"
2. 点击"添加站点"按钮
3. 填写信息：
   - **域名**: `zilohq.com` 和 `www.zilohq.com`（用逗号分隔）
   - **根目录**: `/www/wwwroot/zilo/packages/frontend/dist`
   - **PHP版本**: 选择"纯静态"
   - **数据库**: 不创建
   - **FTP**: 不创建
4. 点击"提交"

### 9.2 配置反向代理

1. 在网站列表中，找到 `zilohq.com`，点击"设置"
2. 点击"反向代理"标签
3. 点击"添加反向代理"
4. 填写信息：
   - **代理名称**: `backend-api`
   - **目标URL**: `http://127.0.0.1:3000`
   - **发送域名**: `$host`
   - **代理目录**: `/api`
5. 点击"保存"

### 9.3 配置 SPA 路由

1. 在网站设置中，点击"配置文件"标签
2. 找到 `location / {` 这一段
3. 在 `location / {` 内部添加以下内容：

```nginx
location / {
    root /www/wwwroot/zilo/packages/frontend/dist;
    try_files $uri $uri/ /index.html;
    index index.html;
}
```

4. 点击"保存"

---

## 第十步：启动后端服务（5分钟）

### 10.1 使用 PM2 启动

在宝塔终端中运行：

```bash
cd /www/wwwroot/zilo/packages/backend

# 启动后端服务
pm2 start dist/index.js --name zilo-backend

# 保存 PM2 配置
pm2 save

# 设置开机自启
pm2 startup
```

### 10.2 查看服务状态

```bash
pm2 status
pm2 logs zilo-backend
```

**如果看到 "Server is running on port 3000"，说明后端启动成功！**

---

## 第十一步：配置域名解析（5分钟）

### 11.1 添加 DNS 记录

1. 登录腾讯云控制台
2. 进入"域名注册" → "我的域名"
3. 找到 `zilohq.com`，点击"解析"
4. 添加以下记录：

**记录1（主域名）：**
- 记录类型: `A`
- 主机记录: `@`
- 记录值: `101.43.69.38`
- TTL: `600`

**记录2（www子域名）：**
- 记录类型: `A`
- 主机记录: `www`
- 记录值: `101.43.69.38`
- TTL: `600`

5. 点击"保存"

**DNS 解析生效需要 5-10 分钟。**

---

## 第十二步：申请 SSL 证书（10分钟）

### 12.1 使用宝塔申请免费证书

1. 在宝塔面板"网站"列表中，找到 `zilohq.com`
2. 点击"设置" → "SSL"标签
3. 选择"Let's Encrypt"
4. 勾选域名：
   - ✅ zilohq.com
   - ✅ www.zilohq.com
5. 点击"申请"
6. 等待证书申请完成（约1-2分钟）
7. 申请成功后，点击右上角"强制HTTPS"开关

**现在你的网站已经支持 HTTPS 了！**

---

## 第十三步：测试访问（5分钟）

### 13.1 测试前端

在浏览器中访问：
- http://zilohq.com
- https://zilohq.com

**应该能看到你的着陆页！**

### 13.2 测试后端 API

在浏览器中访问：
- https://zilohq.com/api/health

**应该返回 JSON 数据，表示后端正常运行。**

### 13.3 测试完整功能

1. 访问 https://zilohq.com
2. 点击"立即开始"或"免费试用"按钮
3. 进入注册页面
4. 尝试注册一个账号
5. 登录系统

**如果能成功注册和登录，说明前后端都正常工作！**

---

## 第十四步：初始化数据（可选，5分钟）

如果你想添加一些测试数据，可以运行种子脚本：

```bash
cd /www/wwwroot/zilo/packages/backend
npm run db:seed
```

这会创建：
- 一个平台管理员账号
- 一个工厂账号
- 一些测试达人和样品数据

---

## 🎉 部署完成！

你的 Zilo 系统现在已经成功部署到生产环境了！

### 访问地址
- **前端**: https://zilohq.com
- **后端 API**: https://zilohq.com/api

### 管理地址
- **宝塔面板**: http://101.43.69.38:8888
- **PM2 进程管理**: 在宝塔终端运行 `pm2 status`

---

## 常用运维命令

### 查看后端日志
```bash
pm2 logs zilo-backend
```

### 重启后端服务
```bash
pm2 restart zilo-backend
```

### 停止后端服务
```bash
pm2 stop zilo-backend
```

### 查看服务状态
```bash
pm2 status
```

### 更新代码
```bash
cd /www/wwwroot/zilo
git pull
cd packages/backend
npm install
npm run build
pm2 restart zilo-backend
cd ../frontend
npm install
npm run build
```

---

## 安全建议

### 1. 修改宝塔面板端口
```bash
# 在宝塔终端运行
bt
# 选择 14. 修改面板端口
# 输入新端口（例如：18888）
```

### 2. 修改 SSH 端口
1. 在宝塔面板，点击"安全"
2. 找到 SSH 端口设置
3. 修改为非标准端口（例如：22022）

### 3. 启用防火墙
1. 在宝塔面板，点击"安全"
2. 确保防火墙已启用
3. 只开放必要的端口

### 4. 定期备份
1. 在宝塔面板，点击"计划任务"
2. 添加"备份数据库"任务（每天凌晨3点）
3. 添加"备份网站"任务（每周一次）

### 5. 监控服务器
1. 在宝塔面板，点击"监控"
2. 查看 CPU、内存、磁盘使用情况
3. 设置告警通知

---

## 故障排查

### 问题1：前端页面打不开
**解决方案**：
1. 检查 Nginx 是否运行：`systemctl status nginx`
2. 检查网站配置是否正确
3. 查看 Nginx 错误日志：`/www/wwwlogs/zilohq.com.error.log`

### 问题2：后端 API 无响应
**解决方案**：
1. 检查 PM2 状态：`pm2 status`
2. 查看后端日志：`pm2 logs zilo-backend`
3. 检查数据库连接：`psql -U zilo -d zilo_production`

### 问题3：数据库连接失败
**解决方案**：
1. 检查 PostgreSQL 是否运行
2. 检查 `.env` 文件中的数据库配置
3. 检查数据库密码是否正确

### 问题4：SSL 证书申请失败
**解决方案**：
1. 确保域名已正确解析到服务器 IP
2. 确保 80 和 443 端口已开放
3. 等待 DNS 解析生效（5-10分钟）后重试

---

## 下一步：微信小程序开发

部署完成后，你可以开始开发微信小程序了！

参考文档：`部署和小程序开发计划.md` 第四部分

---

## 需要帮助？

如果遇到任何问题，请提供：
1. 错误信息截图
2. 后端日志（`pm2 logs zilo-backend`）
3. Nginx 错误日志
4. 具体的操作步骤

我会帮你快速解决！
