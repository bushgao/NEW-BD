# 数据库连接问题排查报告

## 问题描述

后端服务报错：`Can't reach database server at localhost:5432`

## 排查过程

### 1. 检查 PostgreSQL 服务
- ❌ Windows 服务中没有找到 PostgreSQL
- ❌ 系统 PATH 中没有 psql 命令
- ❌ 常规安装路径中没有 PostgreSQL

### 2. 检查 Docker 容器
- ✅ 发现项目使用 Docker 运行 PostgreSQL
- ✅ 容器 `ics-postgres` 正在运行
- ✅ 容器状态：`Up 20 hours (healthy)`
- ✅ 端口映射：`0.0.0.0:5432->5432/tcp`

### 3. 检查数据库连接
```bash
docker exec ics-postgres pg_isready -U postgres
# 输出: /var/run/postgresql:5432 - accepting connections
```
✅ 数据库正在接受连接

### 4. 检查数据库配置
- Docker Compose 配置的数据库：`influencer_collab`
- 后端 .env 配置的数据库：`zilo_dev`
- ✅ 两个数据库都存在于 PostgreSQL 中

### 5. 检查后端配置
**文件**: `packages/backend/.env`
```env
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/zilo_dev"
```
✅ 配置正确

## 问题原因

后端服务之前可能遇到了临时的数据库连接问题，但数据库本身一直在正常运行。

## 解决方案

重启后端服务后，问题已解决。

### 操作步骤
1. 停止后端服务（processId: 4）
2. 启动新的后端服务（processId: 5）
3. 验证服务正常运行

### 验证结果
```bash
curl http://localhost:3000/health
# 返回: {"status":"ok","timestamp":"2026-01-05T07:54:06.517Z"}
```
✅ 后端 API 正常工作

## 当前服务状态

### Docker 容器
- **容器名**: ics-postgres
- **镜像**: postgres:15-alpine
- **状态**: Up 20 hours (healthy)
- **端口**: 0.0.0.0:5432->5432/tcp

### 数据库
- **用户**: postgres
- **密码**: postgres
- **数据库**: zilo_dev（后端使用）
- **备用数据库**: influencer_collab

### 后端服务
- **进程 ID**: 5
- **状态**: running
- **端口**: http://localhost:3000
- **健康检查**: ✅ 通过

### 前端服务
- **进程 ID**: 3
- **状态**: running
- **端口**: http://localhost:5173
- **HMR**: ✅ 已更新 Dashboard 组件

## Docker Compose 配置

**文件**: `docker-compose.yml`
```yaml
services:
  postgres:
    image: postgres:15-alpine
    container_name: ics-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: influencer_collab
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
```

## 常用 Docker 命令

### 启动数据库
```bash
docker-compose up -d postgres
```

### 停止数据库
```bash
docker-compose down
```

### 查看容器状态
```bash
docker ps
```

### 查看容器日志
```bash
docker logs ics-postgres
```

### 进入数据库容器
```bash
docker exec -it ics-postgres psql -U postgres -d zilo_dev
```

### 检查数据库连接
```bash
docker exec ics-postgres pg_isready -U postgres
```

### 查看所有数据库
```bash
docker exec ics-postgres psql -U postgres -c "\l"
```

## 后续建议

1. **监控数据库连接**: 如果再次出现连接问题，检查：
   - Docker 容器是否正在运行
   - 端口 5432 是否被占用
   - 防火墙设置

2. **数据库备份**: 定期备份数据库数据
   ```bash
   docker exec ics-postgres pg_dump -U postgres zilo_dev > backup.sql
   ```

3. **环境变量管理**: 确保 `.env` 文件配置正确，不要提交到版本控制

4. **健康检查**: 后端服务可以添加数据库连接健康检查，在启动时验证连接

## 完成时间

2026-01-05 15:54
