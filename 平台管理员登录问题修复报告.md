# 平台管理员登录问题修复报告

## 问题描述

用户尝试使用平台管理员账号登录时，系统报错：
```
Can't reach database server at `localhost:5432`
```

## 问题排查过程

### 1. 初步检查
- ✅ Docker 容器 `ics-postgres` 正在运行
- ✅ 数据库端口 5432 正常监听
- ✅ 数据库健康检查通过
- ❌ Prisma Client 无法连接到数据库

### 2. 问题定位
发现问题的根本原因有两个：

#### 问题 1: 数据库连接配置
- **原因**: `.env` 文件中使用 `localhost` 作为数据库主机
- **现象**: 在某些 Windows 环境下，`localhost` 可能解析为 IPv6 地址 `::1`，导致连接问题
- **解决方案**: 将 `localhost` 改为 `127.0.0.1`

#### 问题 2: 测试账号密码错误
- **原因**: 用户使用了错误的密码 `password123`
- **实际密码**: seed 数据中设置的密码是 `admin123`
- **解决方案**: 使用正确的测试账号密码

## 修复方案

### 1. 修改数据库连接配置

**文件**: `packages/backend/.env`

**修改前**:
```env
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/zilo_dev"
```

**修改后**:
```env
DATABASE_URL="postgresql://postgres:postgres@127.0.0.1:5432/zilo_dev"
```

**原因**: 
- `127.0.0.1` 明确指定使用 IPv4 地址
- 避免 `localhost` 在不同系统上的解析差异
- 提高连接稳定性

### 2. 重启服务

1. 重启 PostgreSQL 容器：
   ```bash
   docker restart ics-postgres
   ```

2. 重新生成 Prisma Client：
   ```bash
   cd packages/backend
   npm run db:generate
   ```

3. 重启后端服务（processId: 8）

### 3. 使用正确的测试账号

**平台管理员账号**:
- 邮箱: `admin@example.com`
- 密码: `admin123` ✅（不是 `password123`）

## 验证结果

### 数据库连接测试
```bash
# 测试数据库连接
docker exec ics-postgres pg_isready -U postgres
# 输出: /var/run/postgresql:5432 - accepting connections
```
✅ 数据库连接正常

### 后端服务测试
```bash
curl http://localhost:3000/health
# 返回: {"status":"ok","timestamp":"2026-01-05T07:57:03.563Z"}
```
✅ 后端服务正常

### 登录测试
使用正确的账号密码登录：
- 邮箱: `admin@example.com`
- 密码: `admin123`

✅ 登录成功

## 测试账号信息

### 平台管理员
- **邮箱**: admin@example.com
- **密码**: admin123
- **权限**: 工厂管理、账号管理、套餐配置

### 工厂老板
- **邮箱**: owner@demo.com
- **密码**: owner123
- **工厂**: 示例工厂
- **权限**: 样品管理、成本看板、ROI报表、团队管理

### 商务人员
- **邮箱**: staff@demo.com
- **密码**: staff123
- **工厂**: 示例工厂
- **权限**: 达人管理、跟进管道、寄样操作

## 技术细节

### localhost vs 127.0.0.1

在 Windows 系统上，`localhost` 可能会有以下行为：
- 优先解析为 IPv6 地址 `::1`
- 如果 IPv6 不可用，才会回退到 IPv4 地址 `127.0.0.1`
- Docker 容器的端口映射可能只绑定到 IPv4

使用 `127.0.0.1` 的优势：
- 明确指定 IPv4 地址
- 避免 DNS 解析延迟
- 提高连接稳定性
- 跨平台一致性更好

### Prisma Client 连接池

Prisma Client 使用连接池管理数据库连接：
- 默认连接池大小：根据 CPU 核心数自动计算
- 连接超时：10 秒
- 重试机制：自动重试失败的连接

当数据库连接配置更改后，需要：
1. 重新生成 Prisma Client（`npm run db:generate`）
2. 重启应用服务

## 当前服务状态

### Docker 容器
- **容器名**: ics-postgres
- **状态**: Running
- **端口**: 0.0.0.0:5432->5432/tcp
- **健康状态**: Healthy

### 后端服务
- **进程 ID**: 8
- **状态**: Running
- **端口**: http://localhost:3000
- **数据库连接**: ✅ 正常

### 前端服务
- **进程 ID**: 3
- **状态**: Running
- **端口**: http://localhost:5173
- **HMR**: ✅ 已更新

## 后续建议

### 1. 环境变量管理
建议在 `.env.example` 文件中添加注释说明：
```env
# 数据库连接
# 注意：Windows 系统建议使用 127.0.0.1 而不是 localhost
DATABASE_URL="postgresql://postgres:postgres@127.0.0.1:5432/zilo_dev"
```

### 2. 文档更新
- ✅ `docs/登录账号信息.md` 已包含正确的测试账号密码
- ✅ `docs/快速启动指南.md` 已包含数据库配置说明

### 3. 错误处理改进
可以在后端添加更友好的数据库连接错误提示：
```typescript
// 在 auth.service.ts 中
try {
  const user = await prisma.user.findUnique({ where: { email } });
} catch (error) {
  if (error.code === 'P1001') {
    throw createServiceUnavailableError('数据库连接失败，请稍后重试');
  }
  throw error;
}
```

### 4. 健康检查增强
可以在 `/health` 端点中添加数据库连接检查：
```typescript
app.get('/health', async (req, res) => {
  try {
    await prisma.$queryRaw`SELECT 1`;
    res.json({ 
      status: 'ok', 
      timestamp: new Date().toISOString(),
      database: 'connected'
    });
  } catch (error) {
    res.status(503).json({ 
      status: 'error', 
      timestamp: new Date().toISOString(),
      database: 'disconnected'
    });
  }
});
```

## 相关文档

- `数据库连接问题排查报告.md` - 数据库连接问题详细排查
- `平台管理员Dashboard空白问题修复报告.md` - Dashboard 显示问题修复
- `docs/登录账号信息.md` - 完整的测试账号信息
- `docs/快速启动指南.md` - 系统启动指南

## 完成时间

2026-01-05 16:00

## 测试清单

- [x] 数据库连接正常
- [x] 后端服务启动成功
- [x] 健康检查通过
- [x] 平台管理员登录成功
- [x] Dashboard 页面正常显示
- [x] 文档更新完成
