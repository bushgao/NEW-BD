# 问题修复报告 - 合作创建和工厂状态同步

## 修复时间
2025-01-05

## 问题描述

### 问题 1：工厂管理员创建的达人无法新建合作
**现象**：工厂管理员创建达人后，点击"创建合作"按钮时显示"商务人员不存在"错误

**原因**：
- 在 `collaboration.service.ts` 的 `createCollaboration` 函数中，验证商务人员时使用了 `factoryId` 字段
- 工厂管理员（FACTORY_OWNER）的 `factoryId` 字段为 null，因为他们通过 `ownedFactory` 关联工厂
- 查询条件 `{ id: businessStaffId, factoryId }` 无法匹配工厂管理员

### 问题 2：工厂审核状态不同步
**现象**：平台管理员已审核通过工厂，但工厂管理员登录后仍显示"审核中"状态

**原因**：
- 工厂状态信息在用户登录时获取并存储在前端 store 中
- 登录后不会自动刷新用户信息
- 需要重新登录才能看到最新的工厂状态

## 修复方案

### 修复 1：支持工厂管理员创建合作

**文件**：`packages/backend/src/services/collaboration.service.ts`

**修改内容**：
```typescript
// 修改前
const staff = await prisma.user.findFirst({
  where: { id: businessStaffId, factoryId },
});

// 修改后
const staff = await prisma.user.findFirst({
  where: { 
    id: businessStaffId,
    OR: [
      { factoryId },
      { ownedFactory: { id: factoryId } }
    ]
  },
});
```

**说明**：
- 使用 `OR` 条件同时支持两种情况：
  1. 商务人员：`factoryId` 字段直接关联工厂
  2. 工厂管理员：通过 `ownedFactory` 关联工厂
- 这样工厂管理员也可以作为"商务人员"创建合作记录

### 修复 2：自动刷新用户信息

**文件 1**：`packages/frontend/src/stores/authStore.ts`

**修改内容**：
- 添加 `setUser` 方法，用于更新用户信息而不影响 token

```typescript
interface AuthState {
  // ... 其他字段
  setUser: (user: User) => void;
}

// 实现
setUser: (user) => set({ user }),
```

**文件 2**：`packages/frontend/src/pages/Dashboard/index.tsx`

**修改内容**：
- 添加 `refreshUserInfo` 函数，在 Dashboard 加载时自动刷新用户信息
- 导入 `api` 服务

```typescript
// 刷新用户信息（获取最新的工厂状态）
const refreshUserInfo = async () => {
  try {
    const response = await api.get('/auth/me');
    if (response.data) {
      useAuthStore.getState().setUser(response.data);
    }
  } catch (error) {
    console.error('Failed to refresh user info:', error);
  }
};

useEffect(() => {
  loadDashboard();
  refreshUserInfo(); // 刷新用户信息以获取最新的工厂状态
}, [period, isFactoryOwner, isBusinessStaff]);
```

**说明**：
- 每次进入 Dashboard 时自动调用 `/auth/me` 接口获取最新用户信息
- 更新 store 中的用户数据，包括最新的工厂状态
- 不影响 token，避免重新登录

## 测试建议

### 测试 1：工厂管理员创建合作

1. 以工厂管理员身份登录
2. 进入"达人管理"页面
3. 创建一个新达人
4. 进入"合作管道"页面
5. 点击"创建合作"按钮
6. 选择刚创建的达人
7. 商务人员选择自己（工厂管理员）
8. 提交表单
9. **预期结果**：合作创建成功，不再显示"商务人员不存在"错误

### 测试 2：工厂状态自动同步

1. 以工厂管理员身份登录（工厂状态为"审核中"）
2. 不要退出登录
3. 以平台管理员身份在另一个浏览器/无痕窗口登录
4. 进入"平台管理"页面
5. 审核通过该工厂
6. 回到工厂管理员的浏览器窗口
7. 刷新页面或进入 Dashboard
8. **预期结果**：侧边栏显示工厂状态为"运营中"，不再显示"审核中"

### 测试 3：商务人员创建合作（回归测试）

1. 以工厂管理员身份登录
2. 进入"团队管理"页面
3. 创建一个商务账号
4. 退出登录
5. 以新创建的商务账号登录
6. 进入"合作管道"页面
7. 创建一个新合作
8. **预期结果**：合作创建成功，功能正常

## 影响范围

### 后端
- ✅ `packages/backend/src/services/collaboration.service.ts` - 修改商务人员验证逻辑

### 前端
- ✅ `packages/frontend/src/stores/authStore.ts` - 添加 `setUser` 方法
- ✅ `packages/frontend/src/pages/Dashboard/index.tsx` - 添加自动刷新用户信息

## 注意事项

1. **性能影响**：每次进入 Dashboard 都会调用 `/auth/me` 接口，增加了一次 API 请求。但这是必要的，以确保用户看到最新的工厂状态。

2. **缓存策略**：可以考虑添加缓存机制，例如：
   - 只在工厂状态为 PENDING 时才刷新
   - 添加刷新间隔限制（例如 5 分钟内只刷新一次）
   - 使用 WebSocket 推送状态变更

3. **向后兼容**：修改后的代码完全向后兼容，不影响现有的商务人员创建合作功能。

4. **数据一致性**：工厂管理员创建的合作记录，`businessStaffId` 字段指向工厂管理员自己的用户 ID，这在业务逻辑上是合理的。

## 后续优化建议

1. **实时状态推送**：
   - 使用 WebSocket 或 Server-Sent Events 推送工厂状态变更
   - 避免轮询，减少服务器压力

2. **缓存优化**：
   - 在前端添加刷新间隔限制
   - 只在必要时刷新用户信息

3. **用户体验优化**：
   - 当工厂状态变更时，显示通知提示用户
   - 添加手动刷新按钮

## 总结

两个问题已全部修复：
- ✅ 工厂管理员可以正常创建合作
- ✅ 工厂状态会自动同步更新

修改已通过语法检查，可以进行功能测试。
