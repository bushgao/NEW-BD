# ä¾§è¾¹æ èœå•åªæ˜¾ç¤º"å·¥ä½œå°"é—®é¢˜è¯Šæ–­

## é—®é¢˜æè¿°

å•†åŠ¡äººå‘˜ç™»å½•åï¼Œä¾§è¾¹æ åªæ˜¾ç¤º"å·¥ä½œå°"ä¸€ä¸ªèœå•é¡¹ï¼Œå…¶ä»–èœå•é¡¹ï¼ˆè¾¾äººç®¡ç†ã€åˆä½œç®¡é“ã€åˆä½œç»“æœï¼‰éƒ½æ¶ˆå¤±äº†ã€‚

## å¯èƒ½çš„åŸå› 

1. **ç”¨æˆ·è§’è‰²ä¿¡æ¯ä¸¢å¤±**ï¼šlocalStorage ä¸­å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯å¯èƒ½ä¸å®Œæ•´
2. **è§’è‰²å­—æ®µæ ¼å¼é”™è¯¯**ï¼šrole å­—æ®µå¯èƒ½æ˜¯ undefined æˆ–æ ¼å¼ä¸æ­£ç¡®
3. **æµè§ˆå™¨ç¼“å­˜é—®é¢˜**ï¼šæ—§çš„ä»£ç ç¼“å­˜å¯¼è‡´èœå•æ¸²æŸ“é”™è¯¯

## è¯Šæ–­æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ£€æŸ¥æµè§ˆå™¨ localStorage

è¯·åœ¨æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```javascript
// 1. æŸ¥çœ‹å­˜å‚¨çš„è®¤è¯ä¿¡æ¯
const authData = localStorage.getItem('auth-storage');
console.log('Auth Storage:', authData);

// 2. è§£æå¹¶æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯
if (authData) {
  const parsed = JSON.parse(authData);
  console.log('User Info:', parsed.state.user);
  console.log('User Role:', parsed.state.user?.role);
  console.log('Is Authenticated:', parsed.state.isAuthenticated);
}

// 3. æŸ¥çœ‹å½“å‰ç”¨æˆ·è§’è‰²
console.log('Current Role:', parsed.state.user?.role);
```

**é¢„æœŸç»“æœ**ï¼š
- `user.role` åº”è¯¥æ˜¯ `"BUSINESS_STAFF"`
- `isAuthenticated` åº”è¯¥æ˜¯ `true`

**å¦‚æœ role æ˜¯ undefined æˆ–å…¶ä»–å€¼**ï¼š
```javascript
// æ¸…é™¤å¹¶é‡æ–°ç™»å½•
localStorage.clear();
location.reload();
```

### æ­¥éª¤ 2ï¼šæ£€æŸ¥ MainLayout èœå•é…ç½®

MainLayout çš„ `getMenuItems` å‡½æ•°æ ¹æ®è§’è‰²è¿”å›ä¸åŒçš„èœå•é¡¹ï¼š

```typescript
switch (role) {
  case 'PLATFORM_ADMIN':
    return [...commonItems, ...adminItems];
  case 'FACTORY_OWNER':
    return [...commonItems, ...businessItems, ...ownerItems];
  case 'BUSINESS_STAFF':
    return [...commonItems, ...businessItems];  // åº”è¯¥è¿”å› 4 ä¸ªèœå•é¡¹
  default:
    return commonItems;  // åªè¿”å›"å·¥ä½œå°"
}
```

**å¦‚æœè¿›å…¥äº† default åˆ†æ”¯**ï¼Œè¯´æ˜ `role` çš„å€¼ä¸æ˜¯é¢„æœŸçš„å­—ç¬¦ä¸²ã€‚

### æ­¥éª¤ 3ï¼šæ£€æŸ¥ç½‘ç»œè¯·æ±‚

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. åˆ‡æ¢åˆ° Network æ ‡ç­¾
3. åˆ·æ–°é¡µé¢
4. æŸ¥æ‰¾ `/auth/login` æˆ– `/auth/me` è¯·æ±‚
5. æŸ¥çœ‹å“åº”æ•°æ®ä¸­çš„ `user.role` å­—æ®µ

**é¢„æœŸå“åº”**ï¼š
```json
{
  "user": {
    "id": "...",
    "email": "staff@demo.com",
    "name": "å•†åŠ¡ä¸“å‘˜",
    "role": "BUSINESS_STAFF",  // å¿…é¡»æ˜¯è¿™ä¸ªå€¼
    "factoryId": "...",
    "factory": { ... }
  },
  "tokens": { ... }
}
```

### æ­¥éª¤ 4ï¼šå¼ºåˆ¶æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°ç™»å½•

å¦‚æœä¸Šè¿°æ£€æŸ¥éƒ½æ­£å¸¸ï¼Œä½†èœå•ä»ç„¶ä¸æ˜¾ç¤ºï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. **å®Œå…¨æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**ï¼š
   ```javascript
   // åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
   localStorage.clear();
   sessionStorage.clear();
   
   // æ¸…é™¤æ‰€æœ‰ cookies
   document.cookie.split(";").forEach(function(c) { 
     document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
   });
   
   // åˆ·æ–°é¡µé¢
   location.reload();
   ```

2. **ä½¿ç”¨æ— ç—•æ¨¡å¼æµ‹è¯•**ï¼š
   - æ‰“å¼€æµè§ˆå™¨çš„æ— ç—•/éšç§æ¨¡å¼
   - è®¿é—® http://localhost:5173
   - ç™»å½•å•†åŠ¡äººå‘˜è´¦å·
   - æŸ¥çœ‹èœå•æ˜¯å¦æ­£å¸¸æ˜¾ç¤º

3. **ç¡¬åˆ·æ–°é¡µé¢**ï¼š
   - Windows: Ctrl + Shift + R
   - Mac: Cmd + Shift + R

## ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œå¯ä»¥æ‰‹åŠ¨ä¿®å¤ localStorage ä¸­çš„ç”¨æˆ·ä¿¡æ¯ï¼š

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
const authData = JSON.parse(localStorage.getItem('auth-storage'));
authData.state.user.role = 'BUSINESS_STAFF';
localStorage.setItem('auth-storage', JSON.stringify(authData));
location.reload();
```

## éœ€è¦æä¾›çš„ä¿¡æ¯

å¦‚æœé—®é¢˜ä»æœªè§£å†³ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **localStorage ä¸­çš„ auth-storage å†…å®¹**ï¼ˆæ‰§è¡Œæ­¥éª¤ 1 çš„å‘½ä»¤ï¼‰
2. **æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯**ï¼ˆå¦‚æœæœ‰ï¼‰
3. **Network æ ‡ç­¾ä¸­ /auth/login çš„å“åº”æ•°æ®**
4. **æµè§ˆå™¨ç‰ˆæœ¬å’Œæ“ä½œç³»ç»Ÿ**

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

æ ¹æ®è¯Šæ–­ç»“æœï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ï¼š

1. ä¿®å¤åç«¯ç™»å½•æ¥å£ï¼Œç¡®ä¿è¿”å›æ­£ç¡®çš„ role å­—æ®µ
2. ä¿®å¤å‰ç«¯ authStoreï¼Œç¡®ä¿æ­£ç¡®å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
3. ä¿®å¤ MainLayout çš„èœå•æ¸²æŸ“é€»è¾‘

---

## å¿«é€Ÿæµ‹è¯•å‘½ä»¤

å¤åˆ¶ä»¥ä¸‹ä»£ç åˆ°æµè§ˆå™¨æ§åˆ¶å°ï¼Œä¸€é”®æ‰§è¡Œæ‰€æœ‰è¯Šæ–­ï¼š

```javascript
console.log('=== ä¾§è¾¹æ èœå•è¯Šæ–­ ===');

// 1. æ£€æŸ¥ localStorage
const authData = localStorage.getItem('auth-storage');
console.log('\n1. Auth Storage å­˜åœ¨:', !!authData);

if (authData) {
  const parsed = JSON.parse(authData);
  console.log('2. ç”¨æˆ·ä¿¡æ¯:', parsed.state.user);
  console.log('3. ç”¨æˆ·è§’è‰²:', parsed.state.user?.role);
  console.log('4. è§’è‰²ç±»å‹:', typeof parsed.state.user?.role);
  console.log('5. æ˜¯å¦è®¤è¯:', parsed.state.isAuthenticated);
  
  // æ£€æŸ¥è§’è‰²æ˜¯å¦æ­£ç¡®
  const role = parsed.state.user?.role;
  if (role === 'BUSINESS_STAFF') {
    console.log('âœ… è§’è‰²æ­£ç¡®: BUSINESS_STAFF');
    console.log('âš ï¸ ä½†èœå•æœªæ˜¾ç¤ºï¼Œå¯èƒ½æ˜¯æ¸²æŸ“é—®é¢˜');
  } else if (role) {
    console.log('âŒ è§’è‰²é”™è¯¯:', role);
    console.log('ğŸ’¡ åº”è¯¥æ˜¯: BUSINESS_STAFF');
  } else {
    console.log('âŒ è§’è‰²æœªå®šä¹‰');
    console.log('ğŸ’¡ éœ€è¦é‡æ–°ç™»å½•');
  }
} else {
  console.log('âŒ æœªæ‰¾åˆ°è®¤è¯ä¿¡æ¯');
  console.log('ğŸ’¡ éœ€è¦ç™»å½•');
}

console.log('\n=== è¯Šæ–­å®Œæˆ ===');
```


---

## æœ€æ–°è°ƒè¯•ä»£ç ï¼ˆå·²æ·»åŠ ï¼‰

### ä¿®æ”¹å†…å®¹

æˆ‘å·²ç»åœ¨ä»£ç ä¸­æ·»åŠ äº†è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—ï¼Œå¸®åŠ©å®šä½é—®é¢˜ï¼š

#### 1. MainLayout.tsx
- âœ… ä¿®å¤äº† Spin ç»„ä»¶çš„å¯¼å…¥é—®é¢˜
- âœ… æ·»åŠ äº†è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—ï¼Œåœ¨ç»„ä»¶æ¸²æŸ“æ—¶è¾“å‡ºï¼š
  - `isAuthenticated` çŠ¶æ€
  - `user` å¯¹è±¡çš„å®Œæ•´å†…å®¹
  - `user.role` çš„å€¼å’Œç±»å‹
  - localStorage ä¸­çš„åŸå§‹æ•°æ®

#### 2. authStore.ts
- âœ… æ·»åŠ äº† `onRehydrateStorage` å›è°ƒ
- âœ… åœ¨ zustand ä» localStorage æ¢å¤æ•°æ®æ—¶è¾“å‡ºè°ƒè¯•ä¿¡æ¯
- è¿™å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç¡®è®¤æ•°æ®æ˜¯å¦æ­£ç¡®ä» localStorage åŠ è½½åˆ° store

### æ“ä½œæ­¥éª¤

è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

1. **åˆ·æ–°æµè§ˆå™¨é¡µé¢**ï¼ˆCtrl+R æˆ– F5ï¼‰
2. **æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°**ï¼ˆF12ï¼‰
3. **æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º**ï¼Œåº”è¯¥ä¼šçœ‹åˆ°ä¸¤ç»„æ—¥å¿—ï¼š
   - `=== Zustand Rehydration ===` - zustand æ¢å¤æ•°æ®æ—¶çš„è¾“å‡º
   - `=== MainLayout Debug ===` - MainLayout ç»„ä»¶æ¸²æŸ“æ—¶çš„è¾“å‡º

4. **æˆªå›¾å‘ç»™æˆ‘**ï¼ŒåŒ…å«ï¼š
   - æ§åˆ¶å°çš„å®Œæ•´è¾“å‡ºï¼ˆåŒ…æ‹¬ä¸Šè¿°ä¸¤ç»„æ—¥å¿—ï¼‰
   - å·¦ä¾§èœå•çš„æ˜¾ç¤ºæƒ…å†µ

### é¢„æœŸç»“æœ

**å¦‚æœä¸€åˆ‡æ­£å¸¸**ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
```
=== Zustand Rehydration ===
Rehydrated state: { user: {...}, token: {...}, isAuthenticated: true }
User: { id: "...", email: "staff@demo.com", name: "å•†åŠ¡ä¸“å‘˜", role: "BUSINESS_STAFF", ... }
User role: BUSINESS_STAFF
isAuthenticated: true
===========================

=== MainLayout Debug ===
isAuthenticated: true
user: { id: "...", email: "staff@demo.com", name: "å•†åŠ¡ä¸“å‘˜", role: "BUSINESS_STAFF", ... }
user?.role: BUSINESS_STAFF
typeof user?.role: string
localStorage user: {"state":{"user":{...,"role":"BUSINESS_STAFF"},...},...}
========================
```

èœå•åº”è¯¥æ˜¾ç¤º 4 ä¸ªé¡¹ç›®ï¼š
- å·¥ä½œå°
- è¾¾äººç®¡ç†
- åˆä½œç®¡é“
- åˆä½œç»“æœ

**å¦‚æœä¸æ­£å¸¸**ï¼Œå¯èƒ½ä¼šçœ‹åˆ°ï¼š
- `user.role` ä¸º `undefined`
- `user` å¯¹è±¡ä¸º `null`
- è¿™å°†å¸®åŠ©æˆ‘ä»¬ç²¾ç¡®å®šä½é—®é¢˜æ‰€åœ¨

### é¢å¤–è¯Šæ–­è„šæœ¬

å¦‚æœéœ€è¦æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Œè¯·åœ¨æ§åˆ¶å°æ‰§è¡Œï¼ˆè§ `è¯Šæ–­è„šæœ¬-èœå•é—®é¢˜.txt`ï¼‰ï¼š

```javascript
// æŸ¥çœ‹ localStorage åŸå§‹æ•°æ®
const authData = localStorage.getItem('auth-storage');
console.log('=== localStorage åŸå§‹æ•°æ® ===');
console.log(authData);

if (authData) {
  const parsed = JSON.parse(authData);
  console.log('=== è§£æåçš„æ•°æ® ===');
  console.log(parsed);
  console.log('=== state.user ===');
  console.log(parsed.state?.user);
  console.log('=== state.user.role ===');
  console.log(parsed.state?.user?.role);
}
```

### ä¸‹ä¸€æ­¥

æ ¹æ®æ§åˆ¶å°è¾“å‡ºçš„ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥ï¼š
1. å¦‚æœ role åœ¨ localStorage ä¸­å­˜åœ¨ä½†åœ¨ç»„ä»¶ä¸­æ˜¯ undefined â†’ ä¿®å¤ zustand çš„ hydration é€»è¾‘
2. å¦‚æœ role åœ¨ localStorage ä¸­å°±æ˜¯ undefined â†’ ä¿®å¤ç™»å½•æ¥å£æˆ– setAuth é€»è¾‘
3. å¦‚æœ role æ­£ç¡®ä½†èœå•ä¸æ˜¾ç¤º â†’ ä¿®å¤ getMenuItems å‡½æ•°æˆ–èœå•æ¸²æŸ“é€»è¾‘
