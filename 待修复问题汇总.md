# 待修复问题汇总

## 问题 1：工厂老板看不到审核状态

### 需求描述
工厂老板登录后，应该能清楚地看到自己工厂的审核状态。

### 具体要求
1. **Dashboard 顶部横幅显示**
   - PENDING（待审核）：橙色提示 "您的工厂正在审核中，请耐心等待"
   - REJECTED（已拒绝）：红色提示 "您的工厂申请未通过审核，原因：XXX"
   - SUSPENDED（已暂停）：灰色提示 "您的工厂已被暂停"
   - APPROVED（已通过）：不显示横幅（正常状态）

2. **侧边栏底部显示**
   - 工厂状态标签
   - 当前套餐类型

### 影响范围
- `packages/frontend/src/pages/Dashboard/index.tsx`
- `packages/frontend/src/layouts/MainLayout.tsx`

---

## 问题 2：套餐限制没有准确隔离

### 需求描述
不同套餐应该有明确的配额限制，并在前后端都进行验证。

### 具体要求

#### 后端配额检查
1. **创建商务账号时检查配额**
   - 位置：`packages/backend/src/routes/auth.routes.ts`
   - 在注册商务账号前调用 `validateQuota(factoryId, 'staff')`
   - 超出配额时返回错误："已达到商务账号上限（X/Y），请升级套餐"

2. **创建达人时检查配额**
   - 位置：`packages/backend/src/services/influencer.service.ts`
   - 在创建达人前调用 `validateQuota(factoryId, 'influencer')`
   - 超出配额时返回错误："已达到达人数量上限（X/Y），请升级套餐"

#### 前端配额显示
1. **Dashboard 显示配额使用情况**
   - 商务账号：3/10（使用进度条）
   - 达人数量：45/200（使用进度条）
   - 当前套餐：专业版

2. **按钮禁用逻辑**
   - 达到上限时禁用"添加商务账号"按钮
   - 达到上限时禁用"添加达人"按钮
   - 显示 Tooltip："已达上限，请升级套餐"

### 影响范围
- `packages/backend/src/routes/auth.routes.ts`
- `packages/backend/src/services/influencer.service.ts`
- `packages/frontend/src/pages/Dashboard/index.tsx`
- `packages/frontend/src/stores/authStore.ts`

---

## 问题 3：商务账号配额管理（新需求）

### 需求描述
工厂老板需要能够管理商务子账号的配额，查看已开通和未开通的账号。

### 具体要求

#### 3.1 工厂老板端 - 商务账号管理页面

**页面位置**：新增 `/app/team` 或在 Dashboard 中添加"团队管理"卡片

**显示内容**：
```
商务账号配额：3/10
- 已开通：3 个
  1. 张三 (zhang@example.com) - 已激活
  2. 李四 (li@example.com) - 已激活  
  3. 王五 (wang@example.com) - 待激活
  
- 未开通：7 个
  [+ 添加商务账号] 按钮（达到上限时禁用）
```

**功能**：
1. 显示配额总数（由套餐决定）
2. 显示已开通账号列表（姓名、邮箱、状态）
3. 显示未开通数量
4. 添加商务账号按钮（生成邀请链接或直接创建）
5. 禁用/启用商务账号
6. 删除商务账号（释放配额）

#### 3.2 后端 API 支持

**新增接口**：
```typescript
// 获取工厂的商务账号列表（包含配额信息）
GET /api/factory/staff
Response: {
  quota: { total: 10, used: 3, available: 7 },
  staff: [
    { id, name, email, status: 'ACTIVE' | 'INACTIVE', createdAt }
  ]
}

// 创建商务账号（工厂老板权限）
POST /api/factory/staff
Body: { name, email, password }

// 禁用/启用商务账号
PATCH /api/factory/staff/:staffId/toggle

// 删除商务账号
DELETE /api/factory/staff/:staffId
```

### 影响范围
- 新增：`packages/frontend/src/pages/Team/index.tsx`
- 新增：`packages/backend/src/routes/factory.routes.ts`
- 新增：`packages/backend/src/services/factory.service.ts`
- 修改：`packages/frontend/src/routes/index.tsx`（添加路由）
- 修改：`packages/frontend/src/layouts/MainLayout.tsx`（添加菜单项）

---

## 问题 4：商务账号独立注册与工厂绑定（新需求）

### 需求描述
商务人员应该可以独立注册账号，不必一开始就绑定工厂。注册后可以选择加入某个工厂。

### 具体要求

#### 4.1 商务账号注册流程改造

**当前流程**：
```
商务注册 → 必须选择工厂 → 创建账号（绑定工厂）
```

**新流程**：
```
商务注册 → 创建独立账号（factoryId = null）→ 登录后可选择加入工厂
```

#### 4.2 商务账号状态

**三种状态**：
1. **独立商务**：未绑定任何工厂（factoryId = null）
   - 可以查看公开信息
   - 不能创建合作、达人等
   - 可以申请加入工厂

2. **待审核商务**：已申请加入工厂，等待工厂老板审批
   - 显示"等待 XXX 工厂审批"
   - 不能使用工厂功能

3. **已绑定商务**：已加入工厂（factoryId != null）
   - 正常使用所有功能
   - 可以离开工厂（变回独立商务）

#### 4.3 工厂邀请/加入机制

**方式一：商务主动申请**
```
商务登录 → 浏览工厂列表 → 申请加入 → 工厂老板审批 → 加入成功
```

**方式二：工厂老板邀请**
```
工厂老板 → 生成邀请码/链接 → 发送给商务 → 商务使用邀请码 → 自动加入
```

**方式三：工厂老板直接创建**
```
工厂老板 → 创建商务账号 → 自动绑定到工厂
```

#### 4.4 数据库 Schema 调整

**User 表需要新增字段**：
```prisma
model User {
  // ... 现有字段
  
  // 商务账号相关
  factoryId       String?   @db.Uuid  // 可为空，表示独立商务
  factoryJoinedAt DateTime? // 加入工厂的时间
  
  // 工厂申请记录
  factoryApplications FactoryApplication[]
}

// 新增：工厂申请表
model FactoryApplication {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @db.Uuid
  factoryId   String   @db.Uuid
  status      String   // PENDING, APPROVED, REJECTED
  message     String?  // 申请留言
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id])
  factory     Factory  @relation(fields: [factoryId], references: [id])
  
  @@unique([userId, factoryId])
}
```

#### 4.5 前端页面调整

**注册页面**：
- 商务注册时不再要求选择工厂
- 注册成功后提示："注册成功！您可以申请加入工厂或独立使用"

**商务 Dashboard**：
- 未绑定工厂时显示：
  ```
  您还未加入任何工厂
  [浏览工厂] [输入邀请码]
  ```
- 已绑定工厂时显示正常 Dashboard

**工厂老板 - 团队管理页面**：
- 显示待审批的商务申请列表
- 可以批准/拒绝申请

#### 4.6 后端 API 支持

**新增接口**：
```typescript
// 商务申请加入工厂
POST /api/factory/:factoryId/apply
Body: { message: "我想加入贵公司" }

// 工厂老板查看申请列表
GET /api/factory/applications
Response: [{ id, user: {name, email}, message, createdAt }]

// 工厂老板审批申请
POST /api/factory/applications/:applicationId/review
Body: { status: 'APPROVED' | 'REJECTED' }

// 商务离开工厂
POST /api/factory/leave

// 生成工厂邀请码
POST /api/factory/invite-code
Response: { code: "ABC123", expiresAt }

// 使用邀请码加入工厂
POST /api/factory/join-by-code
Body: { code: "ABC123" }
```

### 影响范围
- `packages/backend/prisma/schema.prisma`（新增表）
- `packages/backend/src/services/auth.service.ts`（注册逻辑）
- `packages/frontend/src/pages/Register/index.tsx`（注册页面）
- `packages/frontend/src/pages/Dashboard/index.tsx`（商务 Dashboard）
- 新增：`packages/frontend/src/pages/FactoryBrowse/index.tsx`（浏览工厂）
- 新增：`packages/frontend/src/pages/Team/Applications.tsx`（申请管理）
- 新增：`packages/backend/src/routes/factory-application.routes.ts`
- 新增：`packages/backend/src/services/factory-application.service.ts`

---

## 优先级排序

### P0 - 立即修复（影响核心功能）
1. ✅ 问题 2：后端配额检查（防止超限）
2. ✅ 问题 1：工厂审核状态显示（用户体验）

### P1 - 高优先级（完善核心功能）
3. ✅ 问题 3：商务账号配额管理（工厂老板需要）
4. ✅ 问题 2：前端配额显示和限制（用户体验）

### P2 - 中优先级（增强功能）
5. ✅ 问题 4：商务独立注册与工厂绑定（灵活性）

---

## 实施计划

### 阶段 1：核心修复（1-2 天）
- [ ] 问题 1：添加工厂审核状态显示
- [ ] 问题 2：添加后端配额检查
- [ ] 问题 2：添加前端配额显示

### 阶段 2：功能完善（2-3 天）
- [ ] 问题 3：实现商务账号配额管理页面
- [ ] 问题 3：实现商务账号增删改查 API

### 阶段 3：架构优化（3-5 天）
- [ ] 问题 4：数据库 Schema 调整
- [ ] 问题 4：商务独立注册流程
- [ ] 问题 4：工厂申请/邀请机制
- [ ] 问题 4：前端页面调整

---

## 技术考虑

### 数据迁移
如果实施问题 4，需要考虑现有数据迁移：
- 现有商务账号都已绑定工厂，factoryId 不为空
- 迁移脚本：为所有现有商务账号设置 factoryJoinedAt = createdAt

### 权限控制
- 独立商务（factoryId = null）的权限需要特殊处理
- 中间件需要区分"需要工厂"和"不需要工厂"的接口

### 用户体验
- 商务注册后的引导流程要清晰
- 工厂老板的团队管理界面要直观
- 申请/邀请流程要简单易懂

---

## 测试要点

### 问题 1 测试
- [ ] 新注册工厂老板看到"待审核"提示
- [ ] 审核通过后提示消失
- [ ] 审核拒绝后显示拒绝原因
- [ ] 工厂暂停后显示暂停提示

### 问题 2 测试
- [ ] 达到商务账号上限时无法添加
- [ ] 达到达人数量上限时无法添加
- [ ] 前端按钮正确禁用
- [ ] 配额显示准确

### 问题 3 测试
- [ ] 工厂老板能看到所有商务账号
- [ ] 配额显示准确（已用/总数）
- [ ] 能够添加/禁用/删除商务账号
- [ ] 删除商务账号后配额释放

### 问题 4 测试
- [ ] 商务可以独立注册（不选工厂）
- [ ] 独立商务登录后看到引导页面
- [ ] 商务可以申请加入工厂
- [ ] 工厂老板可以审批申请
- [ ] 商务可以使用邀请码加入
- [ ] 商务可以离开工厂
- [ ] 权限控制正确（独立商务受限）
