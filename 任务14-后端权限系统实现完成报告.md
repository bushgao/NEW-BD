# ä»»åŠ¡14 - åç«¯æƒé™ç³»ç»Ÿå®ç°å®ŒæˆæŠ¥å‘Š

**å®Œæˆæ—¶é—´**: 2026å¹´1æœˆ7æ—¥  
**ä»»åŠ¡çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: âœ… å·²é€šè¿‡

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

å®ç°åç«¯æƒé™ç³»ç»Ÿï¼ŒåŒ…æ‹¬æƒé™ç±»å‹å®šä¹‰ã€æƒé™éªŒè¯ä¸­é—´ä»¶ã€æƒé™ç®¡ç†APIï¼Œå¹¶å°†æƒé™éªŒè¯åº”ç”¨åˆ°æ‰€æœ‰ç›¸å…³è·¯ç”±ã€‚

---

## âœ… å®Œæˆçš„å­ä»»åŠ¡

### 14.1 åˆ›å»ºæƒé™ç±»å‹å®šä¹‰ âœ…

**æ–‡ä»¶**: `packages/backend/src/types/permissions.ts`

**å®ç°å†…å®¹**:
- âœ… å®šä¹‰ `StaffPermissions` æ¥å£ï¼ˆæ•°æ®å¯è§æ€§ã€æ“ä½œæƒé™ã€é«˜çº§æƒé™ï¼‰
- âœ… å®šä¹‰ `PermissionTemplate` æ¥å£
- âœ… å®šä¹‰æƒé™æ¨¡æ¿å¸¸é‡ï¼ˆåŸºç¡€å•†åŠ¡ã€é«˜çº§å•†åŠ¡ã€å›¢é˜Ÿä¸»ç®¡ã€è‡ªå®šä¹‰ï¼‰
- âœ… å®ç° `hasPermission()` æƒé™æ£€æŸ¥å‡½æ•°
- âœ… å®ç° `identifyTemplate()` æ¨¡æ¿è¯†åˆ«å‡½æ•°

### 14.2 å®ç°æƒé™éªŒè¯ä¸­é—´ä»¶ âœ…

**æ–‡ä»¶**: `packages/backend/src/middleware/permission.middleware.ts`

**å®ç°å†…å®¹**:
- âœ… `checkPermission(permission)` - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šæƒé™
- âœ… `filterByPermission(permission)` - æ ¹æ®æƒé™è¿‡æ»¤æ•°æ®
- âœ… `checkStaffDataAccess()` - æ£€æŸ¥æ˜¯å¦å¯ä»¥è®¿é—®æŒ‡å®šå•†åŠ¡çš„æ•°æ®
- âœ… å·¥å‚è€æ¿å’Œå¹³å°ç®¡ç†å‘˜è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™
- âœ… ä»æ•°æ®åº“å®æ—¶è·å–æœ€æ–°æƒé™ï¼ˆç¡®ä¿æƒé™ä¿®æ”¹ç«‹å³ç”Ÿæ•ˆï¼‰

### 14.3 åˆ›å»ºæƒé™ç®¡ç† API âœ…

**æ–‡ä»¶**: `packages/backend/src/routes/staff-management.routes.ts`

**å®ç°å†…å®¹**:
- âœ… `GET /api/staff/:staffId/permissions` - è·å–å•†åŠ¡æƒé™
- âœ… `PUT /api/staff/:staffId/permissions` - æ›´æ–°å•†åŠ¡æƒé™
- âœ… `GET /api/staff/permission-templates` - è·å–æƒé™æ¨¡æ¿åˆ—è¡¨

### 14.4 åº”ç”¨æƒé™éªŒè¯åˆ°ç°æœ‰è·¯ç”± âœ…

**ä¿®æ”¹çš„æ–‡ä»¶**:
1. `packages/backend/src/routes/influencer.routes.ts`
2. `packages/backend/src/routes/collaboration.routes.ts`
3. `packages/backend/src/routes/report.routes.ts`

**åº”ç”¨çš„æƒé™éªŒè¯**:

#### è¾¾äººç®¡ç†è·¯ç”±
- âœ… `GET /influencers` - æ·»åŠ  `filterByPermission('dataVisibility.viewOthersInfluencers')`
- âœ… `POST /influencers` - æ·»åŠ  `checkPermission('operations.manageInfluencers')`
- âœ… `PUT /influencers/:id` - æ·»åŠ  `checkPermission('operations.manageInfluencers')`
- âœ… `DELETE /influencers/:id` - æ·»åŠ  `checkPermission('operations.manageInfluencers')`

#### æ ·å“ç®¡ç†è·¯ç”±
- âœ… `POST /samples` - å·²æœ‰ `checkPermission('operations.manageSamples')`
- âœ… `PUT /samples/:id` - å·²æœ‰ `checkPermission('operations.manageSamples')`
- âœ… `DELETE /samples/:id` - å·²æœ‰ `checkPermission('operations.manageSamples')`

#### åˆä½œç®¡ç†è·¯ç”±
- âœ… `GET /collaborations` - æ·»åŠ  `filterByPermission('dataVisibility.viewOthersCollaborations')`
- âœ… `GET /collaborations/pipeline` - æ·»åŠ  `filterByPermission('dataVisibility.viewOthersCollaborations')`
- âœ… `POST /collaborations` - æ·»åŠ  `checkPermission('operations.manageCollaborations')`
- âœ… `DELETE /collaborations/:id` - æ·»åŠ  `checkPermission('operations.deleteCollaborations')`

#### æŠ¥è¡¨è·¯ç”±
- âœ… `GET /reports/dashboard/trends` - æ·»åŠ æˆæœ¬æ•°æ®æƒé™æ£€æŸ¥
- âœ… `GET /reports/staff/:staffId/quality-score` - æ·»åŠ  `checkStaffDataAccess()`
- âœ… `GET /reports/staff/:staffId/calendar` - æ·»åŠ  `checkStaffDataAccess()`

---

## ğŸ§ª æµ‹è¯•ç»“æœ

**æµ‹è¯•æ–‡ä»¶**: `test-permission-routes.js`

### æµ‹è¯•åœºæ™¯

#### âœ… åœºæ™¯1: åŸºç¡€å•†åŠ¡æƒé™éš”ç¦»
- åŸºç¡€å•†åŠ¡åªèƒ½çœ‹åˆ°è‡ªå·±åˆ›å»ºçš„è¾¾äººï¼ˆ1ä¸ªï¼‰
- åŸºç¡€å•†åŠ¡åªèƒ½çœ‹åˆ°è‡ªå·±çš„åˆä½œè®°å½•ï¼ˆ2ä¸ªï¼‰
- å·¥å‚è€æ¿å¯ä»¥çœ‹åˆ°æ‰€æœ‰è¾¾äººï¼ˆ13ä¸ªï¼‰

#### âœ… åœºæ™¯2: æ ·å“ç®¡ç†æƒé™
- åŸºç¡€å•†åŠ¡åˆ›å»ºæ ·å“è¢«æ‹’ç»ï¼ˆ403ï¼‰
- å·¥å‚è€æ¿æˆåŠŸåˆ›å»ºæ ·å“ï¼ˆ201ï¼‰

#### âœ… åœºæ™¯3: åˆ é™¤åˆä½œè®°å½•æƒé™
- åŸºç¡€å•†åŠ¡åˆ é™¤åˆä½œè®°å½•è¢«æ‹’ç»ï¼ˆ403ï¼‰

#### âœ… åœºæ™¯4: æˆæœ¬æ•°æ®æŸ¥çœ‹æƒé™
- åŸºç¡€å•†åŠ¡æŸ¥çœ‹æˆæœ¬æ•°æ®è¢«æ‹’ç»ï¼ˆ403ï¼‰
- å·¥å‚è€æ¿å¯ä»¥æŸ¥çœ‹æˆæœ¬æ•°æ®ï¼ˆ200ï¼‰

### æµ‹è¯•è¾“å‡º

```
âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆï¼

ğŸ“Š æµ‹è¯•æ€»ç»“:
- åŸºç¡€å•†åŠ¡æƒé™éš”ç¦»: åªèƒ½çœ‹åˆ°è‡ªå·±çš„æ•°æ® âœ“
- åŸºç¡€å•†åŠ¡ä¸èƒ½ç®¡ç†æ ·å“ âœ“
- åŸºç¡€å•†åŠ¡ä¸èƒ½åˆ é™¤åˆä½œè®°å½• âœ“
- åŸºç¡€å•†åŠ¡ä¸èƒ½æŸ¥çœ‹æˆæœ¬æ•°æ® âœ“
- å·¥å‚è€æ¿æ‹¥æœ‰æ‰€æœ‰æƒé™ âœ“
```

---

## ğŸ“ æŠ€æœ¯å®ç°ç»†èŠ‚

### æƒé™æ£€æŸ¥æµç¨‹

1. **è¯·æ±‚åˆ°è¾¾** â†’ è®¤è¯ä¸­é—´ä»¶éªŒè¯token
2. **æƒé™ä¸­é—´ä»¶** â†’ æ£€æŸ¥ç”¨æˆ·è§’è‰²å’Œæƒé™
3. **å·¥å‚è€æ¿/å¹³å°ç®¡ç†å‘˜** â†’ è‡ªåŠ¨é€šè¿‡
4. **å•†åŠ¡äººå‘˜** â†’ ä»æ•°æ®åº“è·å–æœ€æ–°æƒé™
5. **æƒé™éªŒè¯** â†’ æ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å®šæƒé™
6. **æ•°æ®è¿‡æ»¤** â†’ æ ¹æ®æƒé™è¿‡æ»¤è¿”å›æ•°æ®

### æ•°æ®éš”ç¦»å®ç°

```typescript
// å¦‚æœå•†åŠ¡æ²¡æœ‰æŸ¥çœ‹å…¶ä»–äººæ•°æ®çš„æƒé™
// è‡ªåŠ¨æ·»åŠ è¿‡æ»¤æ¡ä»¶ï¼Œåªè¿”å›è‡ªå·±çš„æ•°æ®
if (!hasPermission(permissions, 'dataVisibility.viewOthersInfluencers')) {
  req.query.createdBy = user.userId;
}
```

### æƒé™å®æ—¶ç”Ÿæ•ˆ

```typescript
// æ¯æ¬¡è¯·æ±‚éƒ½ä»æ•°æ®åº“è·å–æœ€æ–°æƒé™
const userWithPermissions = await prisma.user.findUnique({
  where: { id: user.userId },
  select: { permissions: true },
});
```

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

æ ¹æ®éœ€æ±‚ FR-1.5ï¼Œæ‰€æœ‰éªŒæ”¶æ ‡å‡†å·²è¾¾æˆï¼š

- âœ… å·¥å‚è€æ¿å¯ä»¥ä¸ºæ¯ä¸ªå•†åŠ¡è®¾ç½®æƒé™
- âœ… æƒé™æ¨¡æ¿å¯ä»¥æ­£å¸¸åº”ç”¨
- âœ… è‡ªå®šä¹‰æƒé™å¯ä»¥ä¿å­˜
- âœ… æƒé™ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆï¼ˆæ— éœ€é‡æ–°ç™»å½•ï¼‰
- âœ… åŸºç¡€å•†åŠ¡åªèƒ½çœ‹åˆ°è‡ªå·±åˆ›å»ºçš„è¾¾äºº
- âœ… åŸºç¡€å•†åŠ¡åªèƒ½çœ‹åˆ°è‡ªå·±çš„åˆä½œè®°å½•
- âœ… åŸºç¡€å•†åŠ¡ä¸èƒ½æŸ¥çœ‹å…¶ä»–å•†åŠ¡çš„ä¸šç»©æ•°æ®
- âœ… åŸºç¡€å•†åŠ¡ä¸èƒ½ç®¡ç†æ ·å“
- âœ… å‰ç«¯éšè—çš„åŠŸèƒ½ï¼Œåç«¯ä¹ŸéªŒè¯æƒé™
- âœ… ç›´æ¥è°ƒç”¨ API ä¹Ÿä¼šè¢«æƒé™éªŒè¯æ‹¦æˆª
- âœ… å·¥å‚è€æ¿å§‹ç»ˆæ‹¥æœ‰æ‰€æœ‰æƒé™

---

## ğŸ“Š å½±å“èŒƒå›´

### ä¿®æ”¹çš„æ–‡ä»¶
1. `packages/backend/src/routes/influencer.routes.ts`
2. `packages/backend/src/routes/collaboration.routes.ts`
3. `packages/backend/src/routes/report.routes.ts`

### æ–°å¢çš„æµ‹è¯•æ–‡ä»¶
1. `test-permission-routes.js`

### å·²å­˜åœ¨çš„æ–‡ä»¶ï¼ˆå·²å®Œæˆï¼‰
1. `packages/backend/src/types/permissions.ts`
2. `packages/backend/src/middleware/permission.middleware.ts`
3. `packages/backend/src/routes/staff-management.routes.ts`

---

## ğŸš€ ä¸‹ä¸€æ­¥

ä»»åŠ¡14å·²å®Œæˆï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œï¼š
- **ä»»åŠ¡15**: å‰ç«¯æƒé™ç³»ç»Ÿå®ç°
  - 15.1 åˆ›å»º usePermissions Hook
  - 15.2 åˆ›å»ºæƒé™ç®¡ç†ç»„ä»¶
  - 15.3 æ›´æ–°å›¢é˜Ÿç®¡ç†é¡µé¢
  - 15.4 åº”ç”¨æƒé™åˆ°å„ä¸ªé¡µé¢

---

**å®Œæˆäºº**: Kiro AI Assistant  
**å®Œæˆæ—¥æœŸ**: 2026å¹´1æœˆ7æ—¥
