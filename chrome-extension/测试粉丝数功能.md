# 测试粉丝数功能指南

## 前置条件

✅ 数据库已迁移（添加 followers 字段）
✅ Prisma Client 已重新生成
✅ 后端服务已重启
✅ 前端服务正在运行

## 测试步骤

### 步骤 1：重新加载 Chrome 插件

1. 打开浏览器，访问 `chrome://extensions/`
2. 找到"Zilo 达人采集助手"插件
3. 点击刷新图标 🔄 重新加载插件

### 步骤 2：配置插件（如果还没配置）

1. 点击插件图标，打开配置面板
2. 配置信息：
   - **API 地址**: `http://localhost:3000/api`
   - **登录令牌**: 使用工厂老板或商务人员账号登录后获取

**获取 Token 的方法**：
1. 访问 `http://localhost:5173`
2. 使用工厂账号登录（如 `owner@demo.com` / `owner123`）
3. 打开浏览器控制台（F12）
4. 执行以下代码：
```javascript
JSON.parse(localStorage.getItem('auth-storage')).state.token.accessToken
```
5. 复制输出的 Token，粘贴到插件配置中

### 步骤 3：访问抖音精选联盟

1. 访问抖音精选联盟网站：
   - `https://buyin.jinritemai.com/dashboard/servicehall/daren-profile`
   - 或 `https://fxg.jinritemai.com`

2. 找到任意达人详情页

### 步骤 4：测试采集

1. 在达人详情页，应该能看到"添加到 Zilo"按钮
2. 点击按钮，等待采集
3. 观察控制台日志（F12 → Console）：
   ```
   [Zilo] 找到昵称: XXX
   [Zilo] 找到粉丝数 (方法1): 1.2万
   [Zilo] 提取的达人信息: {...}
   [Zilo Background] 准备发送请求: {...}
   [Zilo Background] 采集成功: {...}
   ```

4. 看到"达人采集成功！"提示

### 步骤 5：验证数据

#### 方法 1：在前端列表查看

1. 访问 `http://localhost:5173`
2. 登录系统
3. 进入"达人管理"页面
4. 查看最新添加的达人
5. **检查"粉丝数"列**：
   - 应该显示在"平台账号ID"列之后
   - 格式应该是 "1.2万" 或 "1,234" 等
   - 如果没有粉丝数，显示 "-"

#### 方法 2：检查数据库

打开数据库客户端，执行：
```sql
SELECT 
  nickname, 
  "platformId", 
  followers,
  "createdAt"
FROM "Influencer" 
ORDER BY "createdAt" DESC 
LIMIT 5;
```

预期结果：
```
nickname    | platformId | followers | createdAt
------------|------------|-----------|-------------------
测试达人     | dy123456   | 12000     | 2026-01-06 ...
```

### 步骤 6：测试不同粉丝数量级

采集以下不同粉丝数的达人，验证显示格式：

| 采集到的值 | 存储值 | 前端显示 |
|-----------|--------|---------|
| 1.2万     | 12000  | 1.2万   |
| 123.4万   | 1234000| 123.4万 |
| 5000      | 5000   | 5,000   |
| 未提取到   | null   | -       |

## 调试技巧

### 1. 查看插件日志

打开 `chrome://extensions/`，点击"Service Worker"查看后台日志：
```
[Zilo Background] 收到消息: {action: "collectInfluencer", data: {...}}
[Zilo Background] 准备发送请求: {...}
[Zilo Background] 采集成功: {...}
```

### 2. 查看页面提取日志

在达人详情页打开控制台（F12），查看：
```
[Zilo] 检测到达人详情页，准备注入采集按钮
[Zilo] 按钮已插入到: body
[Zilo] 找到昵称: XXX 选择器: span.auxo-dorami-atom-text
[Zilo] 找到粉丝数 (方法1): 1.2万
```

### 3. 手动测试提取逻辑

在达人详情页控制台执行：
```javascript
// 测试粉丝数提取
const dataNumElements = document.querySelectorAll('[class*="detail-data-num"]');
console.log('找到的元素:', dataNumElements);
console.log('第一个元素文本:', dataNumElements[0]?.textContent);
```

### 4. 测试解析函数

在插件 Service Worker 控制台测试：
```javascript
// 测试粉丝数解析
function parseFollowers(followersStr) {
  if (!followersStr) return '';
  const str = followersStr.replace(/[,，\s]/g, '');
  const match = str.match(/([\d.]+)([wW万])?/);
  if (!match) return followersStr;
  const num = parseFloat(match[1]);
  const unit = match[2];
  if (unit && (unit === 'w' || unit === 'W' || unit === '万')) {
    return Math.round(num * 10000).toString();
  }
  return Math.round(num).toString();
}

console.log(parseFollowers('1.2万'));  // 应输出: "12000"
console.log(parseFollowers('123.4万')); // 应输出: "1234000"
console.log(parseFollowers('5000'));   // 应输出: "5000"
```

## 常见问题

### Q1: 粉丝数列没有显示？
**A**: 刷新页面，确保前端代码已更新。

### Q2: 粉丝数显示为 "-"？
**A**: 可能是：
- 页面上没有粉丝数信息
- 选择器匹配失败
- 查看控制台日志确认是否提取到粉丝数

### Q3: 采集失败？
**A**: 检查：
- Token 是否正确配置
- Token 是否过期（重新登录获取）
- 后端服务是否正常运行
- 查看 Service Worker 日志中的错误信息

### Q4: 粉丝数格式不对？
**A**: 检查：
- 数据库中存储的值是否正确（应该是纯数字字符串）
- 前端格式化逻辑是否正确
- 浏览器控制台是否有 JavaScript 错误

## 成功标志

✅ 插件能正确提取粉丝数（控制台有日志）
✅ 后端能接收并保存粉丝数（数据库有值）
✅ 前端列表能正确显示粉丝数（格式化后）
✅ 不同数量级的粉丝数显示格式正确

## 下一步

测试通过后，可以：
1. 采集更多真实达人数据
2. 验证粉丝数排序功能（如需要）
3. 添加粉丝数筛选功能（如需要）
4. 在达人详情页显示粉丝数（如需要）

---

**祝测试顺利！** 🎉
