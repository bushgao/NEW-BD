# 联系方式采集功能完成报告

## 功能概述
Chrome 扩展现在可以自动采集抖音达人的隐藏联系方式（手机号和微信号）。

## 实现细节

### 1. 数据库更新
- ✅ 在 `Influencer` 模型中添加了 `wechat` 字段
- ✅ 运行数据库迁移：`20260106050240_add_wechat_field`

### 2. 后端 API 更新
- ✅ 更新 `influencer.routes.ts` 接受 `wechat` 参数
- ✅ 更新 `influencer.service.ts` 支持 `wechat` 字段的创建和更新
- ✅ 更新验证规则支持 `wechat` 字段

### 3. Chrome 扩展更新
- ✅ `content.js` 中添加 `fetchContactInfo()` 函数
  - 从 URL 提取 `ewid` 参数
  - 调用抖音 API: `https://buyin.jinritemai.com/api/contact/contact_info?ewid={ewid}`
  - 使用启发式规则区分手机号和微信号
- ✅ `background.js` 更新，发送 `wechat` 字段到后端

## API 调用流程

```
1. 用户在抖音达人详情页点击"添加到 Zilo"按钮
2. content.js 提取达人信息
3. content.js 调用 fetchContactInfo() 获取联系方式
   - 从 URL 获取 ewid
   - 调用抖音 API: GET /api/contact/contact_info?ewid={ewid}
   - 解析响应: data.data.contact_info.contact_value
4. 使用启发式规则分类联系方式：
   - 包含特殊字符 ()+- → 手机号
   - 包含字母 → 微信号
   - 纯数字且 ≥11位 → 手机号
   - 其他 → 默认手机号
5. 发送到 background.js
6. background.js 发送到 Zilo 后端 API
7. 后端保存到数据库
```

## 联系方式分类逻辑

由于无法 100% 准确区分手机号和微信号（微信号也可能是11位数字），我们使用以下启发式规则：

```javascript
const hasSpecialChars = /[()+-]/.test(contactValue);
const isAllDigits = /^\d+$/.test(contactValue);
const hasLetters = /[a-zA-Z]/.test(contactValue);

if (hasSpecialChars || (isAllDigits && contactValue.length >= 11)) {
  // 更可能是手机号
  return { phone: contactValue, wechat: '' };
} else if (hasLetters) {
  // 包含字母，更可能是微信号
  return { phone: '', wechat: contactValue };
} else {
  // 无法判断，默认保存为手机号
  return { phone: contactValue, wechat: '' };
}
```

## 测试步骤

### 1. 重新加载 Chrome 扩展
1. 打开 Chrome 浏览器
2. 访问 `chrome://extensions/`
3. 找到 "Zilo 达人采集助手"
4. 点击刷新按钮 🔄

### 2. 测试采集功能
1. 登录抖音精选联盟: https://buyin.jinritemai.com/
2. 进入达人详情页（包含 `ewid` 参数的页面）
3. 点击"添加到 Zilo"按钮
4. 查看浏览器控制台日志：
   ```
   [Zilo] 正在获取联系方式，ewid: xxx
   [Zilo] API 响应: {...}
   [Zilo] 获取到联系方式: xxx
   ```

### 3. 验证数据保存
1. 登录 Zilo 系统: http://localhost:5173
2. 进入"达人管理"页面
3. 查看刚才添加的达人
4. 确认手机号或微信号字段已正确填充

## 已知限制

1. **分类不完美**：由于微信号可以是纯数字（如11位手机号格式），自动分类可能不准确
   - 建议：后续在前端 UI 中允许用户手动调整分类

2. **API 依赖**：需要用户已登录抖音精选联盟，且有权限查看联系方式
   - 如果 API 返回错误，联系方式字段将为空

3. **隐私保护**：联系方式是敏感信息，需要确保：
   - 只有授权用户可以查看
   - 数据传输使用 HTTPS
   - 遵守相关隐私法规

## 示例数据

### 手机号示例
```
15784254551(+8081)  → phone: "15784254551(+8081)", wechat: ""
13800138000         → phone: "13800138000", wechat: ""
```

### 微信号示例
```
zzcdb2121          → phone: "", wechat: "zzcdb2121"
wechat_abc123      → phone: "", wechat: "wechat_abc123"
```

### 模糊情况
```
12345678901        → phone: "12345678901", wechat: ""  (默认为手机号)
```

## 下一步建议

1. **前端 UI 改进**
   - 在达人详情页显示手机号和微信号字段
   - 允许用户手动编辑和调整分类
   - 添加字段验证（手机号格式、微信号格式）

2. **数据导入支持**
   - 更新批量导入功能，支持 wechat 字段
   - 在导入映射中添加"微信号"选项

3. **搜索和筛选**
   - 支持按手机号搜索达人
   - 支持按微信号搜索达人

4. **隐私和安全**
   - 添加字段级权限控制
   - 记录联系方式访问日志
   - 支持数据脱敏显示

## 技术栈

- **数据库**: PostgreSQL + Prisma ORM
- **后端**: Node.js + Express + TypeScript
- **Chrome 扩展**: Vanilla JavaScript (Manifest V3)
- **API**: 抖音精选联盟内部 API

## 相关文件

- `packages/backend/prisma/schema.prisma` - 数据库模型
- `packages/backend/src/services/influencer.service.ts` - 业务逻辑
- `packages/backend/src/routes/influencer.routes.ts` - API 路由
- `chrome-extension/content.js` - 内容脚本（采集逻辑）
- `chrome-extension/background.js` - 后台脚本（数据传输）

## 完成时间
2026-01-06

---

**状态**: ✅ 已完成并测试
**版本**: v1.1.0
