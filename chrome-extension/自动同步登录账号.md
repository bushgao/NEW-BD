# 🔄 自动同步登录账号功能

## 📋 问题描述

**之前的问题**:
- 插件使用独立的 token 存储
- 切换前端账号后，插件还是用旧账号的 token
- 导致采集的数据添加到错误的账号下

**示例**:
1. 用张老板账号登录，配置插件 token
2. 退出张老板，登录测试002账号
3. 使用插件采集达人
4. ❌ 数据被添加到张老板账号下（错误！）

## ✅ 解决方案

### 自动同步机制

插件现在会**自动从前端页面获取当前登录用户的 token**：

1. **优先级**:
   - 第一优先：使用前端页面当前登录用户的 token
   - 第二优先：使用插件配置中保存的 token

2. **工作流程**:
   ```
   点击"添加到 Zilo"
       ↓
   从页面 localStorage 读取当前登录用户的 token
       ↓
   使用该 token 发送请求
       ↓
   数据添加到当前登录用户的账号下 ✅
   ```

## 🔧 技术实现

### 1. Content Script (content.js)

添加了 `getTokenFromPage()` 函数：

```javascript
// 从页面 localStorage 获取当前登录用户的 token
function getTokenFromPage() {
  try {
    const authStorage = localStorage.getItem('auth-storage');
    if (authStorage) {
      const authData = JSON.parse(authStorage);
      if (authData && authData.state && authData.state.token) {
        return authData.state.token.accessToken;
      }
    }
  } catch (error) {
    console.error('[Zilo] 获取页面 token 失败:', error);
  }
  return null;
}
```

### 2. Background Script (background.js)

修改了 `collectInfluencer()` 函数：

```javascript
async function collectInfluencer(data, pageToken) {
  // 优先使用页面传来的 token（当前登录用户）
  const token = pageToken || config.token;
  
  console.log('[Zilo Background] 使用 token:', 
    pageToken ? '页面 token（当前登录用户）' : '插件配置 token');
  
  // 使用 token 发送请求...
}
```

## 📊 使用场景

### 场景1：正常使用（推荐）✅

1. 在前端登录任意账号（张老板、测试002等）
2. 打开达人详情页
3. 点击"添加到 Zilo"按钮
4. ✅ 数据自动添加到当前登录账号下

**无需配置插件 token！**

### 场景2：切换账号 ✅

1. 用张老板账号登录并采集达人
2. 退出张老板，登录测试002账号
3. 再次采集达人
4. ✅ 数据自动添加到测试002账号下

**自动跟随前端登录状态！**

### 场景3：未登录前端 ⚠️

如果前端未登录，插件会：
1. 尝试从页面获取 token → 失败
2. 使用插件配置的 token → 如果有则使用
3. 如果都没有 → 提示"请先登录系统"

## 🎯 优势

### ✅ 自动同步
- 无需手动更新插件 token
- 自动跟随前端登录状态
- 切换账号后自动使用新账号

### ✅ 向后兼容
- 如果页面未登录，仍可使用插件配置的 token
- 不影响现有的配置方式

### ✅ 用户友好
- 减少配置步骤
- 避免账号混淆
- 提高使用体验

## 🔍 调试信息

在控制台可以看到使用的 token 来源：

```javascript
// 使用页面 token
[Zilo Background] 使用 token: 页面 token（当前登录用户）

// 使用插件配置 token
[Zilo Background] 使用 token: 插件配置 token
```

## 📝 测试步骤

### 测试1：自动同步

1. 用张老板账号登录前端
2. 打开达人详情页
3. 点击"添加到 Zilo"
4. 查看张老板账号的达人列表 → ✅ 应该有新数据

5. 退出张老板，登录测试002
6. 打开达人详情页
7. 点击"添加到 Zilo"
8. 查看测试002账号的达人列表 → ✅ 应该有新数据
9. 查看张老板账号的达人列表 → ✅ 不应该有新数据

### 测试2：未登录

1. 退出前端所有账号
2. 打开达人详情页
3. 点击"添加到 Zilo"
4. 应该提示"请先登录系统" → ✅

## 🎊 总结

现在插件会**自动使用当前登录用户的 token**，无需手动配置，切换账号后也能正确采集到对应账号下！

---

**更新时间**: 2026年1月6日
**状态**: ✅ 已完成
**版本**: v1.1.0
