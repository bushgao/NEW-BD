# å•†åŠ¡è´¦å·çŠ¶æ€å’Œæƒé™éš”ç¦» - å®æ–½è®¡åˆ’

**åˆ›å»ºæ—¶é—´**: 2026å¹´1æœˆ6æ—¥  
**ä¼˜å…ˆçº§**: ğŸ”¥ ç´§æ€¥  
**é¢„è®¡å·¥ä½œé‡**: 1.5å¤©

---

## ğŸ“‹ é—®é¢˜æè¿°

### é—®é¢˜1: ç¦ç”¨/å¯ç”¨åŠŸèƒ½æœªå®Œå…¨å®ç°
**ç°çŠ¶**:
- âœ… å‰ç«¯UIå·²å®ç°ï¼ˆæ˜¾ç¤ºç¦ç”¨/å¯ç”¨æŒ‰é’®ï¼‰
- âŒ æ•°æ®åº“æ²¡æœ‰ `status` å­—æ®µ
- âŒ åç«¯åªæ˜¯æ¨¡æ‹Ÿè¿”å›ï¼Œæ²¡æœ‰çœŸæ­£ä¿å­˜
- âŒ ç¦ç”¨åå•†åŠ¡äººå‘˜ä»ç„¶å¯ä»¥ç™»å½•

**å½±å“**:
- å·¥å‚è€æ¿æ— æ³•ä¸´æ—¶ç¦ç”¨å•†åŠ¡è´¦å·
- å•†åŠ¡ä¼‘å‡ã€ç¦»èŒè¿‡æ¸¡æœŸæ— æ³•ç®¡ç†è´¦å·çŠ¶æ€

### é—®é¢˜2: æƒé™éš”ç¦»æœªç”Ÿæ•ˆ
**ç°çŠ¶**:
- âœ… æƒé™è®¾ç½®åŠŸèƒ½å·²å®ç°
- âœ… æƒé™æ•°æ®å·²ä¿å­˜åˆ°æ•°æ®åº“
- âŒ åç«¯APIæ²¡æœ‰åº”ç”¨æƒé™è¿‡æ»¤
- âŒ åŸºç¡€å•†åŠ¡ä»èƒ½çœ‹åˆ°å…¶ä»–å•†åŠ¡çš„è¾¾äººåˆ—è¡¨

**å½±å“**:
- æ•°æ®éš”ç¦»å¤±æ•ˆï¼Œå•†åŠ¡å¯ä»¥çœ‹åˆ°ä¸è¯¥çœ‹çš„æ•°æ®
- æƒé™è®¾ç½®å½¢åŒè™šè®¾

---

## ğŸ¯ å®æ–½ç›®æ ‡

### ç›®æ ‡1: å®Œå–„ç¦ç”¨/å¯ç”¨åŠŸèƒ½
1. æ·»åŠ æ•°æ®åº“ `status` å­—æ®µ
2. å®ç°çœŸæ­£çš„çŠ¶æ€ä¿å­˜
3. ç™»å½•æ—¶éªŒè¯è´¦å·çŠ¶æ€
4. ç¦ç”¨çš„è´¦å·æ— æ³•ç™»å½•

### ç›®æ ‡2: å®ç°æƒé™æ•°æ®éš”ç¦»
1. è¾¾äººåˆ—è¡¨æ ¹æ®æƒé™è¿‡æ»¤
2. åˆä½œåˆ—è¡¨æ ¹æ®æƒé™è¿‡æ»¤
3. æ ·å“ç®¡ç†æ ¹æ®æƒé™éªŒè¯
4. ä¸šç»©æ•°æ®æ ¹æ®æƒé™è¿‡æ»¤

---

## ğŸ“¦ å®æ–½æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®åº“è¿ç§»ï¼ˆ0.5å°æ—¶ï¼‰

#### 1.1 æ·»åŠ  status å­—æ®µ
**æ–‡ä»¶**: `packages/backend/prisma/schema.prisma`

```prisma
model User {
  // ... ç°æœ‰å­—æ®µ
  
  // è´¦å·çŠ¶æ€
  status       UserStatus  @default(ACTIVE)
  
  // ... å…¶ä»–å­—æ®µ
}

enum UserStatus {
  ACTIVE    // æ­£å¸¸
  DISABLED  // å·²ç¦ç”¨
}
```

#### 1.2 åˆ›å»ºè¿ç§»è„šæœ¬
```bash
cd packages/backend
npx prisma migrate dev --name add_user_status
```

#### 1.3 æ›´æ–°ç°æœ‰è´¦å·çŠ¶æ€
æ‰€æœ‰ç°æœ‰è´¦å·é»˜è®¤è®¾ç½®ä¸º `ACTIVE`

---

### ç¬¬äºŒé˜¶æ®µï¼šå®ç°ç¦ç”¨/å¯ç”¨åŠŸèƒ½ï¼ˆ1å°æ—¶ï¼‰

#### 2.1 æ›´æ–°åç«¯æœåŠ¡
**æ–‡ä»¶**: `packages/backend/src/services/staff-management.service.ts`

**ä¿®æ”¹ `updateStaffStatus` å‡½æ•°**:
```typescript
export async function updateStaffStatus(
  staffId: string,
  factoryId: string,
  status: 'ACTIVE' | 'DISABLED'
): Promise<StaffMember> {
  const user = await prisma.user.findFirst({
    where: {
      id: staffId,
      factoryId,
      role: 'BUSINESS_STAFF',
    },
  });

  if (!user) {
    throw createNotFoundError('å•†åŠ¡è´¦å·ä¸å­˜åœ¨');
  }

  // æ›´æ–°çŠ¶æ€
  const updatedUser = await prisma.user.update({
    where: { id: staffId },
    data: { status },
    select: {
      id: true,
      name: true,
      email: true,
      createdAt: true,
      status: true,
    },
  });

  return {
    id: updatedUser.id,
    name: updatedUser.name,
    email: updatedUser.email,
    status: updatedUser.status,
    createdAt: updatedUser.createdAt,
  };
}
```

**ä¿®æ”¹ `listStaff` å‡½æ•°**:
```typescript
const [staff, total] = await Promise.all([
  prisma.user.findMany({
    where: {
      factoryId,
      role: 'BUSINESS_STAFF',
    },
    select: {
      id: true,
      name: true,
      email: true,
      createdAt: true,
      status: true,  // æ·»åŠ  status
    },
    orderBy: { createdAt: 'desc' },
    skip: (page - 1) * pageSize,
    take: pageSize,
  }),
  // ...
]);

const staffMembers: StaffMember[] = staff.map((user) => ({
  id: user.id,
  name: user.name,
  email: user.email,
  status: user.status,  // ä½¿ç”¨çœŸå®çŠ¶æ€
  createdAt: user.createdAt,
}));
```

#### 2.2 æ›´æ–°ç™»å½•éªŒè¯
**æ–‡ä»¶**: `packages/backend/src/services/auth.service.ts`

**åœ¨ç™»å½•å‡½æ•°ä¸­æ·»åŠ çŠ¶æ€æ£€æŸ¥**:
```typescript
// éªŒè¯å¯†ç 
const isPasswordValid = await bcrypt.compare(password, user.passwordHash);
if (!isPasswordValid) {
  throw createUnauthorizedError('é‚®ç®±æˆ–å¯†ç é”™è¯¯');
}

// æ£€æŸ¥è´¦å·çŠ¶æ€
if (user.status === 'DISABLED') {
  throw createForbiddenError('è´¦å·å·²è¢«ç¦ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
}
```

---

### ç¬¬ä¸‰é˜¶æ®µï¼šå®ç°æƒé™æ•°æ®éš”ç¦»ï¼ˆ3å°æ—¶ï¼‰

#### 3.1 æ›´æ–°è¾¾äººåˆ—è¡¨API
**æ–‡ä»¶**: `packages/backend/src/services/influencer.service.ts`

**ä¿®æ”¹ `listInfluencers` å‡½æ•°**:
```typescript
export async function listInfluencers(
  factoryId: string,
  userId: string,
  userRole: string,
  filters: InfluencerFilters,
  pagination: Pagination
): Promise<PaginatedResult<Influencer>> {
  const { page, pageSize } = pagination;

  // æ„å»ºæŸ¥è¯¢æ¡ä»¶
  const where: any = {
    factoryId,
    ...buildFilters(filters),
  };

  // æƒé™è¿‡æ»¤ï¼šåŸºç¡€å•†åŠ¡åªèƒ½çœ‹åˆ°è‡ªå·±åˆ›å»ºçš„è¾¾äºº
  if (userRole === 'BUSINESS_STAFF') {
    const user = await prisma.user.findUnique({
      where: { id: userId },
      select: { permissions: true },
    });

    const permissions = user?.permissions as StaffPermissions;
    
    // å¦‚æœæ²¡æœ‰æŸ¥çœ‹å…¶ä»–å•†åŠ¡è¾¾äººçš„æƒé™ï¼Œåªæ˜¾ç¤ºè‡ªå·±çš„
    if (!permissions?.dataVisibility?.viewOthersInfluencers) {
      where.createdBy = userId;
    }
  }

  // æŸ¥è¯¢æ•°æ®
  const [influencers, total] = await Promise.all([
    prisma.influencer.findMany({
      where,
      // ...
    }),
    prisma.influencer.count({ where }),
  ]);

  return {
    data: influencers,
    total,
    page,
    pageSize,
    totalPages: Math.ceil(total / pageSize),
  };
}
```

#### 3.2 æ·»åŠ  createdBy å­—æ®µ
**æ–‡ä»¶**: `packages/backend/prisma/schema.prisma`

```prisma
model Influencer {
  // ... ç°æœ‰å­—æ®µ
  
  // åˆ›å»ºäºº
  createdBy    String?
  createdByUser User?   @relation("InfluencerCreatedBy", fields: [createdBy], references: [id])
  
  // ... å…¶ä»–å­—æ®µ
}

model User {
  // ... ç°æœ‰å­—æ®µ
  
  // åˆ›å»ºçš„è¾¾äºº
  createdInfluencers Influencer[] @relation("InfluencerCreatedBy")
  
  // ... å…¶ä»–å­—æ®µ
}
```

#### 3.3 æ›´æ–°åˆä½œåˆ—è¡¨API
**æ–‡ä»¶**: `packages/backend/src/services/collaboration.service.ts`

**ä¿®æ”¹ `listCollaborations` å‡½æ•°**:
```typescript
export async function listCollaborations(
  factoryId: string,
  userId: string,
  userRole: string,
  filters: CollaborationFilters,
  pagination: Pagination
): Promise<PaginatedResult<Collaboration>> {
  const where: any = {
    factoryId,
    ...buildFilters(filters),
  };

  // æƒé™è¿‡æ»¤ï¼šåŸºç¡€å•†åŠ¡åªèƒ½çœ‹åˆ°è‡ªå·±çš„åˆä½œ
  if (userRole === 'BUSINESS_STAFF') {
    const user = await prisma.user.findUnique({
      where: { id: userId },
      select: { permissions: true },
    });

    const permissions = user?.permissions as StaffPermissions;
    
    // å¦‚æœæ²¡æœ‰æŸ¥çœ‹å…¶ä»–å•†åŠ¡åˆä½œçš„æƒé™ï¼Œåªæ˜¾ç¤ºè‡ªå·±çš„
    if (!permissions?.dataVisibility?.viewOthersCollaborations) {
      where.businessStaffId = userId;
    }
  }

  // æŸ¥è¯¢æ•°æ®
  // ...
}
```

#### 3.4 æ›´æ–°æ ·å“ç®¡ç†API
**æ–‡ä»¶**: `packages/backend/src/routes/sample.routes.ts`

**æ·»åŠ æƒé™éªŒè¯ä¸­é—´ä»¶**:
```typescript
import { checkPermission } from '../middleware/permission.middleware';

// åˆ›å»ºæ ·å“
router.post(
  '/',
  authenticate,
  checkPermission('operations.manageSamples'),  // æ·»åŠ æƒé™æ£€æŸ¥
  async (req: Request, res: Response, next: NextFunction) => {
    // ...
  }
);

// æ›´æ–°æ ·å“
router.put(
  '/:id',
  authenticate,
  checkPermission('operations.manageSamples'),  // æ·»åŠ æƒé™æ£€æŸ¥
  async (req: Request, res: Response, next: NextFunction) => {
    // ...
  }
);

// åˆ é™¤æ ·å“
router.delete(
  '/:id',
  authenticate,
  checkPermission('operations.manageSamples'),  // æ·»åŠ æƒé™æ£€æŸ¥
  async (req: Request, res: Response, next: NextFunction) => {
    // ...
  }
);
```

---

### ç¬¬å››é˜¶æ®µï¼šå‰ç«¯é€‚é…ï¼ˆ1å°æ—¶ï¼‰

#### 4.1 æ›´æ–°è¾¾äººç®¡ç†é¡µé¢
**æ–‡ä»¶**: `packages/frontend/src/pages/Influencers/index.tsx`

**æ ¹æ®æƒé™éšè—åŠŸèƒ½**:
```typescript
import { usePermissions } from '../../hooks/usePermissions';

const InfluencersPage = () => {
  const { canManageSamples, hasPermission } = usePermissions();
  
  // ...
  
  return (
    <div>
      {/* åªæœ‰æœ‰æƒé™çš„äººæ‰èƒ½çœ‹åˆ°åˆ›å»ºæŒ‰é’® */}
      {hasPermission('operations.manageInfluencers') && (
        <Button onClick={handleCreate}>åˆ›å»ºè¾¾äºº</Button>
      )}
      
      {/* ... */}
    </div>
  );
};
```

#### 4.2 æ›´æ–°æ ·å“ç®¡ç†é¡µé¢
**æ–‡ä»¶**: `packages/frontend/src/pages/Samples/index.tsx`

**æ ¹æ®æƒé™éšè—åŠŸèƒ½**:
```typescript
import { usePermissions } from '../../hooks/usePermissions';

const SamplesPage = () => {
  const { canManageSamples } = usePermissions();
  
  // ...
  
  return (
    <div>
      {/* åªæœ‰æœ‰æƒé™çš„äººæ‰èƒ½çœ‹åˆ°åˆ›å»ºæŒ‰é’® */}
      {canManageSamples && (
        <Button onClick={handleCreate}>åˆ›å»ºæ ·å“</Button>
      )}
      
      {/* ... */}
    </div>
  );
};
```

---

### ç¬¬äº”é˜¶æ®µï¼šæµ‹è¯•éªŒè¯ï¼ˆ1å°æ—¶ï¼‰

#### 5.1 ç¦ç”¨/å¯ç”¨åŠŸèƒ½æµ‹è¯•
1. å·¥å‚è€æ¿ç™»å½•
2. è¿›å…¥å›¢é˜Ÿç®¡ç†é¡µé¢
3. ç‚¹å‡»"ç¦ç”¨"æŒ‰é’®
4. éªŒè¯çŠ¶æ€å˜ä¸º"å·²ç¦ç”¨"
5. å•†åŠ¡äººå‘˜å°è¯•ç™»å½•ï¼Œåº”è¯¥è¢«æ‹’ç»
6. å·¥å‚è€æ¿ç‚¹å‡»"å¯ç”¨"æŒ‰é’®
7. éªŒè¯çŠ¶æ€å˜ä¸º"æ­£å¸¸"
8. å•†åŠ¡äººå‘˜å¯ä»¥æ­£å¸¸ç™»å½•

#### 5.2 æƒé™éš”ç¦»æµ‹è¯•
1. åˆ›å»ºä¸¤ä¸ªå•†åŠ¡è´¦å·ï¼šå•†åŠ¡Aï¼ˆåŸºç¡€å•†åŠ¡ï¼‰ã€å•†åŠ¡Bï¼ˆåŸºç¡€å•†åŠ¡ï¼‰
2. å•†åŠ¡Aåˆ›å»ºè¾¾äºº1
3. å•†åŠ¡Båˆ›å»ºè¾¾äºº2
4. å•†åŠ¡Aç™»å½•ï¼Œåº”è¯¥åªèƒ½çœ‹åˆ°è¾¾äºº1
5. å•†åŠ¡Bç™»å½•ï¼Œåº”è¯¥åªèƒ½çœ‹åˆ°è¾¾äºº2
6. å·¥å‚è€æ¿ç™»å½•ï¼Œåº”è¯¥èƒ½çœ‹åˆ°æ‰€æœ‰è¾¾äºº
7. å°†å•†åŠ¡Aå‡çº§ä¸º"é«˜çº§å•†åŠ¡"
8. å•†åŠ¡Aåº”è¯¥èƒ½çœ‹åˆ°æ‰€æœ‰è¾¾äººï¼ˆä½†ä¸èƒ½ç¼–è¾‘å…¶ä»–äººçš„ï¼‰

#### 5.3 æ ·å“ç®¡ç†æƒé™æµ‹è¯•
1. åŸºç¡€å•†åŠ¡ç™»å½•
2. è¿›å…¥æ ·å“ç®¡ç†é¡µé¢
3. åº”è¯¥çœ‹ä¸åˆ°"åˆ›å»ºæ ·å“"æŒ‰é’®
4. å°è¯•ç›´æ¥è°ƒç”¨APIåˆ›å»ºæ ·å“ï¼Œåº”è¯¥è¢«æ‹’ç»
5. é«˜çº§å•†åŠ¡ç™»å½•
6. åº”è¯¥èƒ½çœ‹åˆ°"åˆ›å»ºæ ·å“"æŒ‰é’®
7. å¯ä»¥æ­£å¸¸åˆ›å»ºæ ·å“

---

## ğŸ“ æµ‹è¯•è„šæœ¬

åˆ›å»ºæµ‹è¯•è„šæœ¬ `test-status-and-permissions.js`:

```javascript
/**
 * æµ‹è¯•å•†åŠ¡è´¦å·çŠ¶æ€å’Œæƒé™éš”ç¦»
 */

const API_BASE = 'http://localhost:3000/api';

// æµ‹è¯•è´¦å·
const FACTORY_OWNER = {
  email: 'owner@demo.com',
  password: 'owner123',
};

const STAFF_A = {
  email: 'staffa@demo.com',
  password: 'staff123',
};

const STAFF_B = {
  email: 'staffb@demo.com',
  password: 'staff123',
};

async function runTests() {
  console.log('=== å•†åŠ¡è´¦å·çŠ¶æ€å’Œæƒé™éš”ç¦»æµ‹è¯• ===\n');

  // æµ‹è¯•1: ç¦ç”¨/å¯ç”¨åŠŸèƒ½
  console.log('--- æµ‹è¯•1: ç¦ç”¨/å¯ç”¨åŠŸèƒ½ ---');
  // TODO: å®ç°æµ‹è¯•é€»è¾‘

  // æµ‹è¯•2: æƒé™æ•°æ®éš”ç¦»
  console.log('\n--- æµ‹è¯•2: æƒé™æ•°æ®éš”ç¦» ---');
  // TODO: å®ç°æµ‹è¯•é€»è¾‘

  // æµ‹è¯•3: æ ·å“ç®¡ç†æƒé™
  console.log('\n--- æµ‹è¯•3: æ ·å“ç®¡ç†æƒé™ ---');
  // TODO: å®ç°æµ‹è¯•é€»è¾‘
}

runTests();
```

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

### ç¦ç”¨/å¯ç”¨åŠŸèƒ½
- [x] æ•°æ®åº“æ·»åŠ  status å­—æ®µ
- [ ] å·¥å‚è€æ¿å¯ä»¥ç¦ç”¨å•†åŠ¡è´¦å·
- [ ] å·¥å‚è€æ¿å¯ä»¥å¯ç”¨å·²ç¦ç”¨çš„å•†åŠ¡è´¦å·
- [ ] ç¦ç”¨åå•†åŠ¡äººå‘˜æ— æ³•ç™»å½•
- [ ] å¯ç”¨åå•†åŠ¡äººå‘˜å¯ä»¥æ­£å¸¸ç™»å½•
- [ ] çŠ¶æ€å˜æ›´ç«‹å³ç”Ÿæ•ˆ
- [ ] å›¢é˜Ÿç®¡ç†é¡µé¢æ­£ç¡®æ˜¾ç¤ºçŠ¶æ€

### æƒé™æ•°æ®éš”ç¦»
- [ ] åŸºç¡€å•†åŠ¡åªèƒ½çœ‹åˆ°è‡ªå·±åˆ›å»ºçš„è¾¾äºº
- [ ] åŸºç¡€å•†åŠ¡åªèƒ½çœ‹åˆ°è‡ªå·±çš„åˆä½œè®°å½•
- [ ] åŸºç¡€å•†åŠ¡ä¸èƒ½ç®¡ç†æ ·å“
- [ ] é«˜çº§å•†åŠ¡å¯ä»¥ç®¡ç†æ ·å“
- [ ] é«˜çº§å•†åŠ¡å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è¾¾äººï¼ˆå­¦ä¹ ç”¨ï¼‰
- [ ] å›¢é˜Ÿä¸»ç®¡å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ•°æ®
- [ ] å·¥å‚è€æ¿å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ•°æ®
- [ ] å‰ç«¯éšè—çš„åŠŸèƒ½ï¼Œåç«¯ä¹ŸéªŒè¯æƒé™
- [ ] ç›´æ¥è°ƒç”¨APIä¹Ÿä¼šè¢«æ‹¦æˆª

---

## ğŸ“Š å·¥ä½œé‡ä¼°ç®—

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ |
|------|------|----------|
| 1 | æ•°æ®åº“è¿ç§» | 0.5å°æ—¶ |
| 2 | å®ç°ç¦ç”¨/å¯ç”¨åŠŸèƒ½ | 1å°æ—¶ |
| 3 | å®ç°æƒé™æ•°æ®éš”ç¦» | 3å°æ—¶ |
| 4 | å‰ç«¯é€‚é… | 1å°æ—¶ |
| 5 | æµ‹è¯•éªŒè¯ | 1å°æ—¶ |
| **æ€»è®¡** | | **6.5å°æ—¶** |

---

## ğŸš€ å¼€å§‹å®æ–½

å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹å®æ–½ï¼

**ç¬¬ä¸€æ­¥**: æ•°æ®åº“è¿ç§»
**ç¬¬äºŒæ­¥**: å®ç°ç¦ç”¨/å¯ç”¨åŠŸèƒ½
**ç¬¬ä¸‰æ­¥**: å®ç°æƒé™æ•°æ®éš”ç¦»
**ç¬¬å››æ­¥**: å‰ç«¯é€‚é…
**ç¬¬äº”æ­¥**: æµ‹è¯•éªŒè¯

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å·²åˆ›å»º  
**ä¸‹ä¸€æ­¥**: å¼€å§‹å®æ–½ç¬¬ä¸€é˜¶æ®µ
