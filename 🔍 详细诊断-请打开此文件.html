<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” è¯¦ç»†è¯Šæ–­ - Tokenåˆ†æ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .subtitle {
            color: #666;
            font-size: 16px;
            margin-bottom: 30px;
        }
        
        .status {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .status.success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }
        
        .status.warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
        }
        
        .status.info {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            color: #0c5460;
        }
        
        .token-info {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        
        .token-field {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }
        
        .token-field strong {
            color: #667eea;
            display: inline-block;
            width: 120px;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-decoration: none;
            margin: 10px 10px 10px 0;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .button.danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .button.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .steps {
            counter-reset: step;
        }
        
        .step {
            counter-increment: step;
            padding: 20px;
            margin: 15px 0;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 8px;
            position: relative;
            padding-left: 70px;
        }
        
        .step::before {
            content: counter(step);
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: #667eea;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .icon {
            font-size: 40px;
        }
        
        code {
            background: #f8f9fa;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #e83e8c;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>
                <span class="icon">ğŸ”</span>
                Token è¯¦ç»†è¯Šæ–­
            </h1>
            <p class="subtitle">åˆ†æå½“å‰æµè§ˆå™¨ä¸­çš„è®¤è¯TokençŠ¶æ€</p>
            
            <div id="diagnosis"></div>
            
            <div id="actions" style="margin-top: 30px;"></div>
        </div>
        
        <div class="card">
            <h1>
                <span class="icon">ğŸ“‹</span>
                è§£å†³æ­¥éª¤
            </h1>
            <div class="steps" id="steps"></div>
        </div>
    </div>

    <script>
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        function diagnose() {
            const diagnosisDiv = document.getElementById('diagnosis');
            const actionsDiv = document.getElementById('actions');
            const stepsDiv = document.getElementById('steps');
            
            // æ£€æŸ¥ localStorage
            const authStorage = localStorage.getItem('auth-storage');
            const adminStorage = localStorage.getItem('admin-storage');
            
            let diagnosis = '';
            let actions = '';
            let steps = '';
            let hasIssue = false;
            
            if (!authStorage && !adminStorage) {
                diagnosis = `
                    <div class="status info">
                        <strong>â„¹ï¸ æœªæ‰¾åˆ°Token</strong><br>
                        æµè§ˆå™¨ä¸­æ²¡æœ‰å­˜å‚¨ä»»ä½•è®¤è¯Tokenã€‚<br>
                        è¿™æ˜¯æ­£å¸¸çš„ï¼Œå¦‚æœæ‚¨è¿˜æ²¡æœ‰ç™»å½•çš„è¯ã€‚
                    </div>
                `;
                
                steps = `
                    <div class="step">
                        <strong>å‰å¾€ç™»å½•é¡µé¢</strong><br>
                        ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å‰å¾€ç™»å½•é¡µé¢
                    </div>
                    <div class="step">
                        <strong>ä½¿ç”¨æµ‹è¯•è´¦å·ç™»å½•</strong><br>
                        é‚®ç®±: <code>pinpai001@gmail.com</code><br>
                        å¯†ç : <code>password123</code>
                    </div>
                    <div class="step">
                        <strong>éªŒè¯Dashboard</strong><br>
                        ç™»å½•ååº”è¯¥èƒ½çœ‹åˆ°å®Œæ•´çš„Dashboardæ•°æ®
                    </div>
                `;
                
                actions = `
                    <a href="/login" class="button success">å‰å¾€ç™»å½•</a>
                `;
            } else {
                // è§£æToken
                let tokenData = null;
                let tokenSource = '';
                
                if (authStorage) {
                    try {
                        const parsed = JSON.parse(authStorage);
                        if (parsed.state && parsed.state.token && parsed.state.token.accessToken) {
                            tokenData = parseJwt(parsed.state.token.accessToken);
                            tokenSource = 'auth-storage (å·¥å‚å®¢æˆ·)';
                        }
                    } catch (e) {
                        console.error('è§£æ auth-storage å¤±è´¥:', e);
                    }
                }
                
                if (!tokenData && adminStorage) {
                    try {
                        const parsed = JSON.parse(adminStorage);
                        if (parsed.state && parsed.state.token && parsed.state.token.accessToken) {
                            tokenData = parseJwt(parsed.state.token.accessToken);
                            tokenSource = 'admin-storage (å¹³å°ç®¡ç†å‘˜)';
                        }
                    } catch (e) {
                        console.error('è§£æ admin-storage å¤±è´¥:', e);
                    }
                }
                
                if (!tokenData) {
                    diagnosis = `
                        <div class="status error">
                            <strong>âŒ Tokenè§£æå¤±è´¥</strong><br>
                            æ‰¾åˆ°äº†å­˜å‚¨çš„Tokenï¼Œä½†æ— æ³•è§£æã€‚Tokenå¯èƒ½å·²æŸåã€‚
                        </div>
                    `;
                    hasIssue = true;
                } else {
                    // æ£€æŸ¥Tokenå†…å®¹
                    const hasFactoryId = tokenData.factoryId !== undefined && tokenData.factoryId !== null;
                    const isExpired = tokenData.exp && (Date.now() / 1000) > tokenData.exp;
                    
                    diagnosis += `
                        <div class="status ${hasFactoryId && !isExpired ? 'success' : 'error'}">
                            <strong>${hasFactoryId && !isExpired ? 'âœ… TokençŠ¶æ€' : 'âŒ Tokenæœ‰é—®é¢˜'}</strong><br>
                            æ¥æº: ${tokenSource}
                        </div>
                        
                        <div class="token-info">
                            <div class="token-field">
                                <strong>ç”¨æˆ·ID:</strong> ${tokenData.userId || 'âŒ ç¼ºå¤±'}
                            </div>
                            <div class="token-field">
                                <strong>é‚®ç®±:</strong> ${tokenData.email || 'âŒ ç¼ºå¤±'}
                            </div>
                            <div class="token-field">
                                <strong>è§’è‰²:</strong> ${tokenData.role || 'âŒ ç¼ºå¤±'}
                            </div>
                            <div class="token-field" style="background: ${hasFactoryId ? '#d4edda' : '#f8d7da'};">
                                <strong>å·¥å‚ID:</strong> ${hasFactoryId ? 'âœ… ' + tokenData.factoryId : 'âŒ ç¼ºå¤± (è¿™æ˜¯é—®é¢˜æ‰€åœ¨!)'}
                            </div>
                            <div class="token-field">
                                <strong>ç­¾å‘æ—¶é—´:</strong> ${tokenData.iat ? new Date(tokenData.iat * 1000).toLocaleString('zh-CN') : 'æœªçŸ¥'}
                            </div>
                            <div class="token-field" style="background: ${isExpired ? '#f8d7da' : '#d4edda'};">
                                <strong>è¿‡æœŸæ—¶é—´:</strong> ${tokenData.exp ? new Date(tokenData.exp * 1000).toLocaleString('zh-CN') : 'æœªçŸ¥'}
                                ${isExpired ? ' âŒ å·²è¿‡æœŸ' : ' âœ… æœ‰æ•ˆ'}
                            </div>
                        </div>
                    `;
                    
                    if (!hasFactoryId) {
                        diagnosis += `
                            <div class="status error">
                                <strong>ğŸ¯ é—®é¢˜ç¡®è®¤</strong><br>
                                æ‚¨çš„Tokenä¸­<span class="highlight">ç¼ºå°‘ factoryId å­—æ®µ</span>ï¼<br><br>
                                è¿™æ˜¯ä¸€ä¸ª<strong>æ—§Token</strong>ï¼Œåœ¨ä»£ç ä¿®å¤ä¹‹å‰ç”Ÿæˆçš„ã€‚<br>
                                åç«¯ä»£ç å·²ç»ä¿®å¤ï¼Œä½†æµè§ˆå™¨è¿˜åœ¨ä½¿ç”¨æ—§Tokenã€‚<br><br>
                                <strong>è§£å†³æ–¹æ¡ˆï¼šæ¸…é™¤Tokenå¹¶é‡æ–°ç™»å½•</strong>
                            </div>
                        `;
                        hasIssue = true;
                        
                        steps = `
                            <div class="step">
                                <strong>ç‚¹å‡»"æ¸…é™¤Token"æŒ‰é’®</strong><br>
                                è¿™ä¼šåˆ é™¤æµè§ˆå™¨ä¸­çš„æ—§Token
                            </div>
                            <div class="step">
                                <strong>é¡µé¢ä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ</strong><br>
                                ä¸è¦æ‹…å¿ƒï¼Œè¿™æ˜¯æ­£å¸¸çš„
                            </div>
                            <div class="step">
                                <strong>é‡æ–°ç™»å½•</strong><br>
                                ä½¿ç”¨ç›¸åŒçš„è´¦å·å¯†ç ç™»å½•<br>
                                é‚®ç®±: <code>pinpai001@gmail.com</code><br>
                                å¯†ç : <code>password123</code>
                            </div>
                            <div class="step">
                                <strong>éªŒè¯ä¿®å¤</strong><br>
                                ç™»å½•åï¼ŒDashboardåº”è¯¥æ­£å¸¸æ˜¾ç¤ºï¼Œä¸å†æœ‰400é”™è¯¯
                            </div>
                            <div class="step">
                                <strong>ï¼ˆå¯é€‰ï¼‰å†æ¬¡æ‰“å¼€æ­¤é¡µé¢</strong><br>
                                ç¡®è®¤æ–°TokenåŒ…å« factoryId å­—æ®µ
                            </div>
                        `;
                        
                        actions = `
                            <button class="button danger" onclick="clearAndReload()">
                                ğŸ—‘ï¸ æ¸…é™¤Tokenå¹¶é‡æ–°ç™»å½•
                            </button>
                            <button class="button" onclick="location.reload()">
                                ğŸ”„ åˆ·æ–°è¯Šæ–­
                            </button>
                        `;
                    } else if (isExpired) {
                        diagnosis += `
                            <div class="status warning">
                                <strong>âš ï¸ Tokenå·²è¿‡æœŸ</strong><br>
                                æ‚¨çš„Tokenå·²ç»è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•ã€‚
                            </div>
                        `;
                        hasIssue = true;
                        
                        steps = `
                            <div class="step">
                                <strong>æ¸…é™¤è¿‡æœŸToken</strong><br>
                                ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ¸…é™¤è¿‡æœŸçš„Token
                            </div>
                            <div class="step">
                                <strong>é‡æ–°ç™»å½•</strong><br>
                                ä½¿ç”¨æ‚¨çš„è´¦å·å¯†ç é‡æ–°ç™»å½•
                            </div>
                        `;
                        
                        actions = `
                            <button class="button danger" onclick="clearAndReload()">
                                ğŸ—‘ï¸ æ¸…é™¤è¿‡æœŸToken
                            </button>
                        `;
                    } else {
                        diagnosis += `
                            <div class="status success">
                                <strong>âœ… Tokenå®Œå…¨æ­£å¸¸</strong><br>
                                æ‚¨çš„TokenåŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µï¼Œä¸”æœªè¿‡æœŸã€‚<br><br>
                                å¦‚æœDashboardä»ç„¶æ˜¾ç¤ºé”™è¯¯ï¼Œå¯èƒ½æ˜¯å…¶ä»–é—®é¢˜ã€‚<br>
                                è¯·æ£€æŸ¥ï¼š
                                <ul style="margin-top: 10px; margin-left: 20px;">
                                    <li>æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯</li>
                                    <li>Networkæ ‡ç­¾ä¸­APIè¯·æ±‚çš„å“åº”</li>
                                    <li>åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ</li>
                                </ul>
                            </div>
                        `;
                        
                        steps = `
                            <div class="step">
                                <strong>Tokenæ­£å¸¸</strong><br>
                                æ‚¨çš„TokenåŒ…å«æ­£ç¡®çš„ factoryIdï¼Œåº”è¯¥å¯ä»¥æ­£å¸¸ä½¿ç”¨
                            </div>
                            <div class="step">
                                <strong>å¦‚æœä»æœ‰é—®é¢˜</strong><br>
                                è¯·æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)<br>
                                æŸ¥çœ‹ Console å’Œ Network æ ‡ç­¾ä¸­çš„é”™è¯¯ä¿¡æ¯
                            </div>
                            <div class="step">
                                <strong>è”ç³»æŠ€æœ¯æ”¯æŒ</strong><br>
                                æä¾›æ§åˆ¶å°æˆªå›¾å’Œé”™è¯¯ä¿¡æ¯
                            </div>
                        `;
                        
                        actions = `
                            <a href="/app/dashboard" class="button success">å‰å¾€Dashboard</a>
                            <button class="button" onclick="location.reload()">ğŸ”„ åˆ·æ–°è¯Šæ–­</button>
                        `;
                    }
                }
            }
            
            diagnosisDiv.innerHTML = diagnosis;
            actionsDiv.innerHTML = actions;
            stepsDiv.innerHTML = steps;
        }

        function clearAndReload() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰Tokenå¹¶é‡æ–°ç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('auth-storage');
                localStorage.removeItem('admin-storage');
                sessionStorage.clear();
                alert('Tokenå·²æ¸…é™¤ï¼é¡µé¢å°†è·³è½¬åˆ°ç™»å½•é¡µé¢ã€‚');
                window.location.href = '/login';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œè¯Šæ–­
        diagnose();
    </script>
</body>
</html>
