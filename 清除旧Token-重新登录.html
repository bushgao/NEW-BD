<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¸…é™¤æ—§Token - é‡æ–°ç™»å½•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .problem-box {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }

    .problem-box h3 {
      color: #856404;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .problem-box p {
      color: #856404;
      font-size: 14px;
      line-height: 1.6;
    }

    .solution-box {
      background: #d1ecf1;
      border-left: 4px solid #17a2b8;
      padding: 15px;
      margin-bottom: 30px;
      border-radius: 4px;
    }

    .solution-box h3 {
      color: #0c5460;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .solution-box p {
      color: #0c5460;
      font-size: 14px;
      line-height: 1.6;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 16px;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-bottom: 15px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      box-shadow: 0 10px 20px rgba(108, 117, 125, 0.4);
    }

    #result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      display: none;
    }

    #result.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      display: block;
    }

    #result.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      display: block;
    }

    .steps {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .steps h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .steps ol {
      margin-left: 20px;
    }

    .steps li {
      color: #666;
      margin-bottom: 10px;
      line-height: 1.6;
    }

    .code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #e83e8c;
    }

    .countdown {
      text-align: center;
      font-size: 18px;
      color: #667eea;
      font-weight: 600;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ æ¸…é™¤æ—§Token</h1>
    <p class="subtitle">ä¿®å¤ "ç”¨æˆ·æœªå…³è”å·¥å‚" é”™è¯¯</p>

    <div class="problem-box">
      <h3>âŒ é—®é¢˜æè¿°</h3>
      <p>
        æ‚¨çš„ç™»å½•Tokenæ˜¯æ—§ç‰ˆæœ¬ï¼Œç¼ºå°‘ <span class="code">factoryId</span> å­—æ®µï¼Œ
        å¯¼è‡´æ‰€æœ‰Dashboard APIè¿”å› "ç”¨æˆ·æœªå…³è”å·¥å‚" é”™è¯¯ã€‚
      </p>
    </div>

    <div class="solution-box">
      <h3>âœ… è§£å†³æ–¹æ¡ˆ</h3>
      <p>
        ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ¸…é™¤æ—§Tokenï¼Œç„¶åé‡æ–°ç™»å½•å³å¯è·å–åŒ…å«å®Œæ•´ä¿¡æ¯çš„æ–°Tokenã€‚
      </p>
    </div>

    <button class="btn" onclick="clearToken()">
      ğŸ—‘ï¸ æ¸…é™¤æ—§Tokenå¹¶è·³è½¬ç™»å½•
    </button>

    <button class="btn btn-secondary" onclick="checkToken()">
      ğŸ” æ£€æŸ¥å½“å‰TokençŠ¶æ€
    </button>

    <div id="result"></div>

    <div class="steps">
      <h3>ğŸ“ æ‰‹åŠ¨æ“ä½œæ­¥éª¤ï¼ˆå¦‚æœæŒ‰é’®æ— æ•ˆï¼‰</h3>
      <ol>
        <li>æŒ‰ <span class="code">F12</span> æ‰“å¼€å¼€å‘è€…å·¥å…·</li>
        <li>åˆ‡æ¢åˆ° <span class="code">Application</span> æ ‡ç­¾</li>
        <li>å·¦ä¾§é€‰æ‹© <span class="code">Local Storage</span> â†’ <span class="code">http://localhost:5173</span></li>
        <li>åˆ é™¤æ‰€æœ‰å­˜å‚¨é¡¹ï¼ˆå³é”® â†’ Clearï¼‰</li>
        <li>åˆ·æ–°é¡µé¢å¹¶é‡æ–°ç™»å½•</li>
      </ol>
    </div>
  </div>

  <script>
    function clearToken() {
      try {
        // æ¸…é™¤æ‰€æœ‰localStorage
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          keysToRemove.push(localStorage.key(i));
        }
        keysToRemove.forEach(key => {
          if (key) localStorage.removeItem(key);
        });
        
        // æ¸…é™¤æ‰€æœ‰sessionStorage
        sessionStorage.clear();
        
        // æ¸…é™¤æ‰€æœ‰cookies
        document.cookie.split(";").forEach(function(c) { 
          document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
        });
        
        const resultDiv = document.getElementById('result');
        resultDiv.className = 'success';
        resultDiv.innerHTML = `
          <p style="font-size: 16px; margin-bottom: 10px;">
            âœ… <strong>Tokenå·²æˆåŠŸæ¸…é™¤ï¼</strong>
          </p>
          <p style="font-size: 14px; margin-bottom: 10px;">
            æ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...
          </p>
          <div class="countdown" id="countdown">3</div>
        `;
        
        // å€’è®¡æ—¶
        let count = 3;
        const countdownEl = document.getElementById('countdown');
        const interval = setInterval(() => {
          count--;
          if (countdownEl) {
            countdownEl.textContent = count.toString();
          }
          if (count <= 0) {
            clearInterval(interval);
            window.location.href = 'http://localhost:5173/';
          }
        }, 1000);
        
      } catch (error) {
        const resultDiv = document.getElementById('result');
        resultDiv.className = 'error';
        resultDiv.innerHTML = `
          <p><strong>âŒ æ¸…é™¤å¤±è´¥</strong></p>
          <p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
          <p>è¯·å°è¯•æ‰‹åŠ¨æ¸…é™¤ï¼ˆå‚è€ƒä¸‹æ–¹æ­¥éª¤ï¼‰</p>
        `;
      }
    }

    function checkToken() {
      try {
        const authStorage = localStorage.getItem('auth-storage');
        
        if (!authStorage) {
          const resultDiv = document.getElementById('result');
          resultDiv.className = 'error';
          resultDiv.innerHTML = `
            <p><strong>âš ï¸ æœªæ‰¾åˆ°Token</strong></p>
            <p>LocalStorageä¸­æ²¡æœ‰ auth-storage æ•°æ®</p>
            <p>æ‚¨å¯èƒ½å·²ç»é€€å‡ºç™»å½•æˆ–ä»æœªç™»å½•è¿‡</p>
          `;
          return;
        }

        const parsed = JSON.parse(authStorage);
        const token = parsed.state?.token;
        
        if (!token || !token.accessToken) {
          const resultDiv = document.getElementById('result');
          resultDiv.className = 'error';
          resultDiv.innerHTML = `
            <p><strong>âš ï¸ Tokenæ ¼å¼é”™è¯¯</strong></p>
            <p>æ— æ³•è§£æTokenæ•°æ®</p>
          `;
          return;
        }

        // è§£æJWT payload (ä¸éªŒè¯ç­¾åï¼Œä»…æŸ¥çœ‹å†…å®¹)
        const base64Url = token.accessToken.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        
        const payload = JSON.parse(jsonPayload);
        
        const hasFactoryId = 'factoryId' in payload && payload.factoryId !== null && payload.factoryId !== undefined;
        
        const resultDiv = document.getElementById('result');
        resultDiv.className = hasFactoryId ? 'success' : 'error';
        resultDiv.innerHTML = `
          <p><strong>${hasFactoryId ? 'âœ… Tokenæ­£å¸¸' : 'âŒ Tokenç¼ºå°‘factoryId'}</strong></p>
          <p style="margin-top: 10px;"><strong>Tokenå†…å®¹:</strong></p>
          <pre style="background: #f4f4f4; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px;">${JSON.stringify(payload, null, 2)}</pre>
          ${!hasFactoryId ? '<p style="margin-top: 10px; color: #721c24;"><strong>å»ºè®®:</strong> ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ¸…é™¤æ—§Tokenå¹¶é‡æ–°ç™»å½•</p>' : ''}
        `;
        
      } catch (error) {
        const resultDiv = document.getElementById('result');
        resultDiv.className = 'error';
        resultDiv.innerHTML = `
          <p><strong>âŒ æ£€æŸ¥å¤±è´¥</strong></p>
          <p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
        `;
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.addEventListener('load', () => {
      // å»¶è¿Ÿ1ç§’è‡ªåŠ¨æ£€æŸ¥ï¼Œç»™ç”¨æˆ·æ—¶é—´çœ‹åˆ°é¡µé¢
      setTimeout(checkToken, 1000);
    });
  </script>
</body>
</html>
