# ICS 数据库规范 v1.0

> 本文档定义了达人合作系统(ICS)数据库开发标准，**每次修改数据库结构必须遵循**。
>
> 更新日期: 2026-01-19

---

## 📁 一、Prisma 配置

### 1.1 文件位置

```
packages/backend/prisma/
├── schema.prisma    # 数据库模型定义
├── seed.ts          # 种子数据脚本
├── cleanup.sql      # 清理脚本（可选）
└── migrations/      # 迁移历史
```

### 1.2 数据库连接

```prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}
```

---

## 🏗️ 二、核心模型

### 2.1 用户系统

```prisma
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  phone         String?   @unique
  password      String
  name          String
  role          Role      @default(BUSINESS)
  isIndependent Boolean   @default(false)
  brandId       String?
  brand         Brand?    @relation("BrandStaff", fields: [brandId])
  ownedBrand    Brand?    @relation("BrandOwner")
  permissions   Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

enum Role {
  PLATFORM_ADMIN
  BRAND
  BUSINESS
  INFLUENCER
}
```

### 2.2 品牌系统

```prisma
model Brand {
  id               String       @id @default(uuid())
  name             String
  status           BrandStatus  @default(PENDING)
  planType         PlanType     @default(FREE)
  planStartedAt    DateTime?
  planExpiresAt    DateTime?
  isPaid           Boolean      @default(false)
  isLocked         Boolean      @default(false)
  staffLimit       Int          @default(3)
  influencerLimit  Int          @default(500)
  bonusStaff       Int          @default(0)
  bonusInfluencer  Int          @default(0)
  bonusDays        Int          @default(0)
  ownerId          String       @unique
  owner            User         @relation("BrandOwner", fields: [ownerId])
  staff            User[]       @relation("BrandStaff")
  influencers      Influencer[]
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}

enum BrandStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum PlanType {
  FREE
  PERSONAL
  PROFESSIONAL
  ENTERPRISE
}
```

### 2.3 达人系统（双模型架构）

```prisma
// 全局身份（身份锚点）
model InfluencerAccount {
  id            String       @id @default(uuid())
  primaryPhone  String?      @unique
  wechatId      String?      @unique
  nickname      String
  userId        String?      @unique
  user          User?        @relation(fields: [userId])
  influencers   Influencer[] // 关联的品牌花名册条目
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

// 品牌关系视图（花名册条目）
model Influencer {
  id            String             @id @default(uuid())
  nickname      String
  platform      Platform
  platformId    String
  phone         String?
  wechat        String?
  uid           String?
  homeUrl       String?
  shippingAddress String?
  status        InfluencerStatus   @default(ACTIVE)
  accountId     String?
  account       InfluencerAccount? @relation(fields: [accountId])
  brandId       String
  brand         Brand              @relation(fields: [brandId])
  collaborations Collaboration[]
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@unique([brandId, platform, platformId])
}

enum Platform {
  DOUYIN
  KUAISHOU
  XIAOHONGSHU
  WEIBO
  BILIBILI
  OTHER
}
```

---

## 💰 三、数据存储规范

### 3.1 货币存储

| 场景 | 存储格式 | 类型 | 示例 |
|------|----------|------|------|
| 精确金额（成本、账单） | 分 (Cents) | `Int` | ¥99.99 → 9999 |
| 估算金额（报价） | 分 (Cents) | `Int` | ¥1000 → 100000 |

```prisma
model Sample {
  unitCost    Int    // 单位成本（分）
  retailPrice Int    // 零售价（分）
}

model Collaboration {
  quotedPrice Int?   // 报价（分）
}
```

### 3.2 日期存储

```prisma
// 使用 DateTime 类型
planExpiresAt DateTime?
createdAt     DateTime  @default(now())
updatedAt     DateTime  @updatedAt
```

### 3.3 JSON 字段

```prisma
// 权限配置
permissions Json?

// 使用时需要类型转换
const permissions = user.permissions as unknown as StaffPermissions;
```

---

## 🔄 四、迁移流程

### 4.1 标准迁移步骤

```powershell
# 1. 停止开发服务器
taskkill /F /IM node.exe

# 2. 修改 schema.prisma

# 3. 创建迁移
npx prisma migrate dev --name add_bonus_fields

# 4. 重新生成客户端
npx prisma generate

# 5. 重启服务器
npm run dev
```

### 4.2 快速同步（开发环境）

```powershell
# 直接推送schema更改（无迁移文件）
npx prisma db push

# 重新生成客户端
npx prisma generate
```

### 4.3 强制重置（数据可丢失）

```powershell
# 重置数据库并重新应用schema
npx prisma db push --force-reset

# 重新播种数据
npx prisma db seed
```

---

## 🛠️ 五、常见问题处理

### 5.1 EPERM 文件锁

```powershell
# 症状: operation not permitted, rename ...query_engine-windows.dll

# 解决方案
Get-Process -Name node -ErrorAction SilentlyContinue | Stop-Process -Force
npx prisma generate
```

### 5.2 Enum 依赖死锁

```sql
-- 症状: cannot drop type "XXX_old" because other objects depend on it

-- 解决方案: 创建 prisma/cleanup.sql
DROP TABLE IF EXISTS "OldTable" CASCADE;
DROP TYPE IF EXISTS "OldEnum_old" CASCADE;

-- 执行
npx prisma db execute --file prisma/cleanup.sql
```

### 5.3 BOM 验证错误

```powershell
# 症状: P1012 - This line is invalid

# 解决方案: 移除BOM
node -e "const fs=require('fs');let c=fs.readFileSync('prisma/schema.prisma','utf8');if(c.charCodeAt(0)===0xFEFF)c=c.slice(1);fs.writeFileSync('prisma/schema.prisma',c,'utf8');"
```

### 5.4 迁移漂移

```powershell
# 症状: Drift detected

# 开发环境解决方案
npx prisma migrate dev

# 选择 yes 接受重置
```

---

## 📊 六、订阅层级

| 层级 | 商务限额 | 达人限额 | 价格 | 试用期 |
|------|----------|----------|------|--------|
| FREE | 3 | 500 | ¥0 | 30天 |
| PERSONAL | 1 | 500 | ¥599/年 | 30天 |
| PROFESSIONAL | 20 | 2,000 | ¥1,999/年 | - |
| ENTERPRISE | 50 | 10,000 | ¥2,999/年 | - |

### 6.1 赠送额度字段

```prisma
model Brand {
  bonusStaff       Int @default(0)  // 赠送商务账号数
  bonusInfluencer  Int @default(0)  // 赠送达人数量
  bonusDays        Int @default(0)  // 赠送天数
}
```

---

## 🌱 七、种子数据

### 7.1 配置

```json
// package.json
{
  "prisma": {
    "seed": "tsx prisma/seed.ts"
  }
}
```

### 7.2 执行

```powershell
npx prisma db seed
```

### 7.3 种子脚本示例

```typescript
// prisma/seed.ts
import { PrismaClient } from '@prisma/client';
import bcrypt from 'bcryptjs';

const prisma = new PrismaClient();

async function main() {
  // 创建管理员
  const admin = await prisma.user.upsert({
    where: { email: 'admin@example.com' },
    update: {},
    create: {
      email: 'admin@example.com',
      phone: '13800000000',
      password: await bcrypt.hash('admin123', 10),
      name: '系统管理员',
      role: 'PLATFORM_ADMIN',
    },
  });

  console.log('Seed completed:', { admin: admin.id });
}

main()
  .catch((e) => { console.error(e); process.exit(1); })
  .finally(() => prisma.$disconnect());
```

---

## 📋 八、检查清单

### 新字段检查清单

- [ ] 在 `schema.prisma` 中添加字段
- [ ] 运行 `npx prisma generate`
- [ ] 更新相关 Service 接口
- [ ] 更新相关 Route 解构
- [ ] 更新前端对应接口
- [ ] 测试字段读写

### 新模型检查清单

- [ ] 定义模型及字段
- [ ] 设置正确的关系（@relation）
- [ ] 添加必要的索引（@@unique, @@index）
- [ ] 运行迁移
- [ ] 创建 Service 层
- [ ] 创建 Route 层
- [ ] 更新 packages/shared 类型导出

---

*文档版本: v1.0 | 最后更新: 2026-01-19*
