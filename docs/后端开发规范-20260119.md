# ICS åç«¯å¼€å‘è§„èŒƒ v1.0

> æœ¬æ–‡æ¡£å®šä¹‰äº†è¾¾äººåˆä½œç³»ç»Ÿ(ICS)åç«¯å¼€å‘æ ‡å‡†ï¼Œ**æ¯æ¬¡åˆ›å»ºæˆ–ä¿®æ”¹åç«¯ä»£ç å¿…é¡»éµå¾ª**ã€‚
>
> æ›´æ–°æ—¥æœŸ: 2026-01-19

---

## ğŸ“ ä¸€ã€é¡¹ç›®ç»“æ„

```
packages/backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts            # å…¥å£ç‚¹ (Port 3000)
â”‚   â”œâ”€â”€ routes/             # APIè·¯ç”±å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ index.ts        # è·¯ç”±æ³¨å†Œä¸­å¿ƒ
â”‚   â”‚   â”œâ”€â”€ auth.routes.ts
â”‚   â”‚   â”œâ”€â”€ influencer.routes.ts
â”‚   â”‚   â”œâ”€â”€ collaboration.routes.ts
â”‚   â”‚   â”œâ”€â”€ sample.routes.ts
â”‚   â”‚   â”œâ”€â”€ platform.routes.ts
â”‚   â”‚   â””â”€â”€ subscription.routes.ts
â”‚   â”œâ”€â”€ services/           # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ auth.service.ts
â”‚   â”‚   â”œâ”€â”€ influencer.service.ts
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ middleware/         # ä¸­é—´ä»¶
â”‚       â”œâ”€â”€ auth.middleware.ts
â”‚       â””â”€â”€ permission.middleware.ts
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma       # æ•°æ®åº“æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ seed.ts             # ç§å­æ•°æ®è„šæœ¬
â”‚   â””â”€â”€ cleanup.sql         # æ•°æ®åº“æ¸…ç†è„šæœ¬ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ package.json
```

---

## ğŸ”Œ äºŒã€è·¯ç”±è§„èŒƒ

### 2.1 ä¸‰ç‚¹è¿æ¥åè®®

æ–°å»ºè·¯ç”±æ–‡ä»¶å¿…é¡»å®Œæˆä»¥ä¸‹ä¸‰æ­¥ï¼š

1. **åˆ›å»ºè·¯ç”±æ–‡ä»¶**: `src/routes/{feature}.routes.ts`
2. **å¯¼å…¥è·¯ç”±**: åœ¨ `src/routes/index.ts` ä¸­å¯¼å…¥
3. **æŒ‚è½½è·¯ç”±**: ä½¿ç”¨ `router.use('/path', featureRouter)`

```typescript
// 1. è·¯ç”±æ–‡ä»¶: feature.routes.ts
import { Router } from 'express';
const router = Router();

router.use(authenticate);
router.use(enrichUserData);

router.get('/', async (req, res) => { ... });
export default router;

// 2. ä¸­å¤®æ³¨å†Œ: routes/index.ts
import featureRoutes from './feature.routes';
router.use('/feature', featureRoutes);
```

### 2.2 è·¯ç”±çº§ä¸­é—´ä»¶åº”ç”¨

ä¸­é—´ä»¶åº”åœ¨è·¯ç”±çº§åˆ«ç»Ÿä¸€åº”ç”¨ï¼Œè€Œéæ¯ä¸ªç«¯ç‚¹é‡å¤ï¼š

```typescript
const router = Router();

// âœ… æ­£ç¡®ï¼šè·¯ç”±çº§åº”ç”¨
router.use(authenticate);
router.use(enrichUserData);

router.get('/', requireRoles('BRAND'), handler);
router.post('/', requireRoles('BRAND', 'BUSINESS'), handler);

// âŒ é”™è¯¯ï¼šæ¯ä¸ªç«¯ç‚¹é‡å¤
router.get('/', authenticate, enrichUserData, requireRoles('BRAND'), handler);
```

### 2.3 è¯·æ±‚ä½“è§£æ„è§„èŒƒ

**ç¦æ­¢é—æ¼æ–°å­—æ®µ**ï¼šå½“æ·»åŠ æ–°å­—æ®µæ—¶ï¼Œå¿…é¡»æ›´æ–°è·¯ç”±ä¸­çš„ `req.body` è§£æ„ï¼š

```typescript
// âŒ é”™è¯¯ï¼šé—æ¼æ–°å­—æ®µ
const { name, phone } = req.body;

// âœ… æ­£ç¡®ï¼šåŒ…å«æ‰€æœ‰å­—æ®µ
const { name, phone, email, bonusStaff, bonusInfluencer, bonusDays } = req.body;

// ä¼ é€’ç»™æœåŠ¡å±‚
await service.update(id, { name, phone, email, bonusStaff, bonusInfluencer, bonusDays });
```

---

## ğŸ” ä¸‰ã€è®¤è¯ä¸æˆæƒ

### 3.1 ä¸­é—´ä»¶å †æ ˆ

| ä¸­é—´ä»¶ | ç”¨é€” |
|--------|------|
| `authenticate` | éªŒè¯JWT Token |
| `enrichUserData` | è¡¥å…… `brandId`ï¼ˆå¤„ç†Owner/Staffå·®å¼‚ï¼‰ |
| `requireRoles(...roles)` | è§’è‰²æ£€æŸ¥ |
| `requireRolesOrIndependent(...roles)` | è§’è‰²æ£€æŸ¥ + ç‹¬ç«‹å•†åŠ¡è±å… |
| `checkPermission(permission)` | ç»†ç²’åº¦æƒé™æ£€æŸ¥ |

### 3.2 èº«ä»½ä¸Šä¸‹æ–‡ä¸°å¯Œ (enrichUserData)

```typescript
// enrichUserData ä¸­é—´ä»¶è§„èŒƒåŒ– brandId
export const enrichUserData = async (req, res, next) => {
  const user = req.user;
  
  // Staffè·¯å¾„ï¼šç›´æ¥ä½¿ç”¨ brandId
  if (user.brandId) {
    return next();
  }
  
  // Ownerè·¯å¾„ï¼šä» ownedBrand è·å– brandId
  const dbUser = await prisma.user.findUnique({
    where: { id: user.userId },
    include: { ownedBrand: true }
  });
  
  if (dbUser?.ownedBrand) {
    req.user.brandId = dbUser.ownedBrand.id;
  }
  
  next();
};
```

### 3.3 ç‹¬ç«‹å•†åŠ¡æˆæƒ

ç‹¬ç«‹å•†åŠ¡ç”¨æˆ· (`isIndependent: true`) éœ€è¦ç‰¹æ®Šå¤„ç†ï¼š

```typescript
export const requireRolesOrIndependent = (...roles: string[]) => {
  return async (req, res, next) => {
    const user = req.user;
    
    // æ£€æŸ¥è§’è‰²
    if (roles.includes(user.role)) {
      return next();
    }
    
    // æ£€æŸ¥ç‹¬ç«‹å•†åŠ¡è±å…
    if (user.role === 'BUSINESS') {
      const dbUser = await prisma.user.findUnique({
        where: { id: user.userId },
        select: { isIndependent: true }
      });
      
      if (dbUser?.isIndependent) {
        return next();
      }
    }
    
    return res.status(403).json({ error: 'æƒé™ä¸è¶³' });
  };
};
```

---

## ğŸ’¾ å››ã€æœåŠ¡å±‚è§„èŒƒ

### 4.1 æ¥å£å®šä¹‰

æœåŠ¡å±‚å¿…é¡»å®šä¹‰æ¸…æ™°çš„è¾“å…¥/è¾“å‡ºæ¥å£ï¼š

```typescript
// è¾“å…¥æ¥å£
export interface CreateInfluencerInput {
  nickname: string;
  platform: Platform;
  platformId: string;
  phone?: string;
  wechat?: string;
  brandId: string;  // å¿…é¡»åŒ…å«ç§Ÿæˆ·ID
}

// è¾“å‡ºæ¥å£ï¼ˆåŒ…å«å…³è”æ•°æ®ï¼‰
export interface InfluencerWithRelations {
  id: string;
  nickname: string;
  brand: { id: string; name: string };
  collaborations: Collaboration[];
}
```

### 4.2 äº‹åŠ¡å¤„ç†

æ¶‰åŠå¤šè¡¨æ“ä½œå¿…é¡»ä½¿ç”¨äº‹åŠ¡ï¼š

```typescript
export async function registerWithInvitation(data: RegisterInput): Promise<User> {
  return prisma.$transaction(async (tx) => {
    // 1. æ›´æ–°é‚€è¯·çŠ¶æ€
    await tx.invitation.update({
      where: { code: data.inviteCode },
      data: { status: 'USED', usedAt: new Date() }
    });
    
    // 2. åˆ›å»ºç”¨æˆ·
    const user = await tx.user.create({
      data: { ...data, brandId: invitation.brandId }
    });
    
    return user;
  });
}
```

### 4.3 é”™è¯¯å¤„ç†

```typescript
// æ ‡å‡†é”™è¯¯å“åº”
export async function getInfluencer(id: string): Promise<Influencer> {
  const influencer = await prisma.influencer.findUnique({ where: { id } });
  
  if (!influencer) {
    throw new NotFoundError('è¾¾äººä¸å­˜åœ¨');
  }
  
  return influencer;
}
```

---

## ğŸ“‹ äº”ã€APIå“åº”è§„èŒƒ

### 5.1 ç»Ÿä¸€å“åº”æ ¼å¼

```typescript
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
  };
}

// æˆåŠŸå“åº”
res.json({ success: true, data: result });

// é”™è¯¯å“åº”  
res.status(400).json({
  success: false,
  error: { code: 'VALIDATION_ERROR', message: 'å‚æ•°é”™è¯¯' }
});
```

### 5.2 çŠ¶æ€ç ä½¿ç”¨

| çŠ¶æ€ç  | ç”¨é€” |
|--------|------|
| 200 | æˆåŠŸ |
| 201 | åˆ›å»ºæˆåŠŸ |
| 400 | è¯·æ±‚å‚æ•°é”™è¯¯ |
| 401 | æœªè®¤è¯ï¼ˆTokenæ— æ•ˆ/è¿‡æœŸï¼‰ |
| 403 | æƒé™ä¸è¶³ï¼ˆå·²è®¤è¯ä½†æ— æƒé™ï¼‰ |
| 404 | èµ„æºä¸å­˜åœ¨ |
| 409 | å†²çªï¼ˆå¦‚é‡å¤åˆ›å»ºï¼‰ |
| 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |

---

## ğŸ”„ å…­ã€å…¨æ ˆåŒæ­¥åè®®

æ·»åŠ æ–°å­—æ®µæ—¶å¿…é¡»åŒæ­¥æ‰€æœ‰å±‚ï¼š

```
1. Prisma Schema (schema.prisma)
   â†“
2. npx prisma generate
   â†“
3. åç«¯ Service æ¥å£ (*.service.ts)
   â†“
4. åç«¯ Route è§£æ„ (*.routes.ts)
   â†“
5. å‰ç«¯ Service æ¥å£ (*.service.ts)
   â†“
6. å‰ç«¯ç»„ä»¶ä½¿ç”¨
```

> âš ï¸ ä»»ä¸€å±‚é—æ¼ä¼šå¯¼è‡´"å¹½çµæ•°æ®"æˆ–"UIç›²åŒº"

---

## ğŸ› ï¸ ä¸ƒã€å¸¸è§é—®é¢˜å¤„ç†

### 7.1 EADDRINUSE (ç«¯å£å ç”¨)

```powershell
# æŸ¥æ‰¾å ç”¨è¿›ç¨‹
netstat -ano | findstr :3000

# å¼ºåˆ¶ç»ˆæ­¢
taskkill /F /IM node.exe
```

### 7.2 EPERM (Prismaæ–‡ä»¶é”)

```powershell
# 1. åœæ­¢æ‰€æœ‰Nodeè¿›ç¨‹
Get-Process -Name node -ErrorAction SilentlyContinue | Stop-Process -Force

# 2. é‡æ–°ç”Ÿæˆ
npx prisma generate
```

### 7.3 404 Ghost Route

å¦‚æœAPIè¿”å›404ä½†ä»£ç å­˜åœ¨ï¼š
1. æ£€æŸ¥ `routes/index.ts` æ˜¯å¦å¯¼å…¥äº†è·¯ç”±
2. æ£€æŸ¥æŒ‚è½½è·¯å¾„æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥å‰ç«¯ `baseURL` æ˜¯å¦åŒ¹é…

### 7.4 500 Proxy Void

Viteä»£ç†è¿”å›ç©º500ï¼š
1. æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨
2. ç›´æ¥è®¿é—®åç«¯ç«¯å£æµ‹è¯•: `curl http://localhost:3000/api/health`
3. æ£€æŸ¥åç«¯ç»ˆç«¯æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—

---

## ğŸ“‹ å…«ã€æ£€æŸ¥æ¸…å•

### æ–°è·¯ç”±æ£€æŸ¥æ¸…å•

- [ ] åˆ›å»ºäº† `*.routes.ts` æ–‡ä»¶
- [ ] åœ¨ `routes/index.ts` ä¸­å¯¼å…¥å¹¶æŒ‚è½½
- [ ] åº”ç”¨äº† `authenticate` å’Œ `enrichUserData` ä¸­é—´ä»¶
- [ ] é…ç½®äº†æ­£ç¡®çš„è§’è‰²æ£€æŸ¥
- [ ] å®šä¹‰äº†è¾“å…¥éªŒè¯è§„åˆ™ (`express-validator`)

### æ–°å­—æ®µæ£€æŸ¥æ¸…å•

- [ ] Prisma schema å·²æ·»åŠ å­—æ®µ
- [ ] å·²è¿è¡Œ `npx prisma generate`
- [ ] Service æ¥å£å·²æ›´æ–° (Input/Output)
- [ ] Route å·²è§£æ„æ–°å­—æ®µ
- [ ] å·²é‡å¯å¼€å‘æœåŠ¡å™¨

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.0 | æœ€åæ›´æ–°: 2026-01-19*
