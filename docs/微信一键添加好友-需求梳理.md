# 微信一键添加好友功能 - 需求梳理

> **文档版本**: 1.0.0  
> **创建时间**: 2026-01-12 16:45:00 (北京时间)  
> **文档类型**: 需求分析与技术可行性评估  
> **状态**: 🔵 梳理中

---

## 📋 目录

1. [功能概述](#1-功能概述)
2. [核心需求](#2-核心需求)
3. [技术方案分析](#3-技术方案分析)
4. [安装方案设计](#4-安装方案设计)
5. [功能模块拆解](#5-功能模块拆解)
6. [数据库设计](#6-数据库设计)
7. [待确认问题](#7-待确认问题)
8. [风险评估](#8-风险评估)
9. [开发计划](#9-开发计划)

---

## 1. 功能概述

### 1.1 产品定位

为商务团队提供**一键添加微信好友**功能，与现有的达人采集插件集成，实现从采集到加微信的全流程自动化，提高商务工作效率。

### 1.2 目标用户

- **商务人员**：日常需要添加大量达人微信的一线工作者
- **品牌负责人**：需要查看添加记录和效率数据

### 1.3 核心价值

| 痛点 | 解决方案 |
|------|----------|
| 手动复制微信号、切换窗口、粘贴 | 一键自动完成 |
| 添加话术需要反复输入 | 话术模板管理，支持变量替换 |
| 多个微信账号切换麻烦 | 支持选择指定微信实例 |
| 无法追溯添加记录 | 完整的操作日志 |

---

## 2. 核心需求

### 2.1 功能需求清单

| 序号 | 功能模块 | 优先级 | 描述 |
|------|----------|--------|------|
| F1 | 一键添加微信 | P0 | 点击按钮后自动完成添加好友全流程 |
| F2 | 自动修改备注 | P0 | 添加后自动设置备注为"达人昵称-所属平台" |
| F3 | 话术管理页面 | P0 | 按产品分类管理添加话术 |
| F4 | 话术变量替换 | P1 | 支持 `{达人昵称}`、`{产品名}` 等变量 |
| F5 | 多微信选择 | P1 | 支持选择使用哪个微信实例 |
| F6 | 操作日志记录 | P1 | 记录谁、什么时候、添加了哪个达人 |
| F7 | 桥接程序自动安装 | P0 | 安装插件时自动安装本地桥接程序 |

### 2.2 用户操作流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           用户操作流程                                        │
└─────────────────────────────────────────────────────────────────────────────┘

  [在精选联盟页面]          [选择达人]           [点击一键添加]
         │                      │                      │
         ▼                      ▼                      ▼
  ┌─────────────┐        ┌─────────────┐        ┌─────────────┐
  │ 采集达人信息 │───────▶│ 选择话术模板 │───────▶│ 选择微信实例 │
  │ (现有功能)   │        │ (下拉选择)   │        │ (如有多个)   │
  └─────────────┘        └─────────────┘        └─────────────┘
                                                       │
         ┌─────────────────────────────────────────────┘
         │
         ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                        自动化流程（无需用户操作）                          │
  │                                                                         │
  │  1. 激活指定微信窗口                                                     │
  │  2. 打开搜索添加好友界面（Ctrl+F 或点击菜单）                             │
  │  3. 自动输入微信号                                                       │
  │  4. 点击搜索                                                            │
  │  5. 自动填写验证消息（话术模板 + 变量替换）                               │
  │                                                                         │
  └─────────────────────────────────────────────────────────────────────────┘
         │
         ▼
  ┌─────────────┐        ┌─────────────┐        ┌─────────────┐
  │ 用户确认添加 │───────▶│ 自动修改备注 │───────▶│ 记录操作日志 │
  │ (最后点击)   │        │ 昵称-平台    │        │ 同步到后端   │
  └─────────────┘        └─────────────┘        └─────────────┘
```

---

## 3. 技术方案分析

### 3.1 技术可行性研究

#### 微信多开原理

| 技术点 | 说明 |
|--------|------|
| **单例模式** | Windows微信使用互斥体（Mutex）`_WeChat_App_Instance_Identity_Mutex_Name` 防止多开 |
| **绕过方式** | BAT脚本快速连续启动多个 `WeChat.exe`，在互斥体创建前启动新实例 |
| **实例识别** | 每个微信是独立进程，可通过 PID、窗口句柄、窗口标题区分 |

#### 微信自动化方案对比

| 方案 | 安全性 | 封号风险 | 技术难度 | 推荐度 |
|------|--------|----------|----------|--------|
| **UI自动化** | ✅ 高 | ✅ 低 | 中等 | ⭐⭐⭐⭐⭐ |
| API Hook | ❌ 低 | ❌ 极高 | 高 | ❌ 不推荐 |
| 协议模拟 | ❌ 低 | ❌ 极高 | 极高 | ❌ 不推荐 |

> **结论**：采用 **UI自动化方案**，通过模拟鼠标点击、键盘输入操作微信界面，该方案模拟真实用户行为，封号风险最低。

### 3.2 系统架构设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              整体架构                                         │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────────────────┐
                    │          Chrome 插件 (现有)          │
                    │  - 达人信息采集                      │
                    │  - "一键添加微信"按钮                │
                    │  - 话术选择 UI                       │
                    │  - 微信实例选择                      │
                    └─────────────────┬───────────────────┘
                                      │
                                      │ Chrome Native Messaging
                                      │ (JSON over stdin/stdout)
                                      ▼
                    ┌─────────────────────────────────────┐
                    │       本地桥接服务 (新增)             │
                    │  - Native Messaging Host            │
                    │  - 微信进程扫描                      │
                    │  - UI自动化控制                      │
                    │  - 技术栈：Python + pywinauto       │
                    └─────────────────┬───────────────────┘
                                      │
                                      │ UI 自动化
                                      │ (模拟键盘鼠标)
                                      ▼
                    ┌─────────────────────────────────────┐
                    │          微信 PC 客户端              │
                    └─────────────────────────────────────┘


                    ┌─────────────────────────────────────┐
                    │            Web 系统 (现有)           │
                    │  - 话术管理页面（新增菜单项）         │
                    │  - 操作日志查看                      │
                    │  - 后端 API                         │
                    │  - 数据库存储                        │
                    └─────────────────────────────────────┘
```

### 3.3 Chrome Native Messaging 原理

Chrome 插件无法直接操作本地应用，需要通过 **Native Messaging** 机制与本地程序通信：

```
Chrome 插件                           本地程序
    │                                    │
    │ ─── chrome.runtime.sendNativeMessage() ───▶ │
    │                                    │
    │ ◀─── JSON 响应 (via stdout) ─────── │
    │                                    │
```

**关键组件**：
1. **Native Messaging Host**：本地可执行程序（Python/Node.js）
2. **Host Manifest**：JSON 配置文件，指定允许通信的插件 ID
3. **Windows 注册表项**：告诉 Chrome 如何找到 Host

---

## 4. 安装方案设计

### 4.1 一键安装方案

为了确保商务人员能够轻松安装，我们设计以下方案：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           安装流程                                           │
└─────────────────────────────────────────────────────────────────────────────┘

  用户下载安装包                     运行安装程序                    安装完成
        │                              │                              │
        ▼                              ▼                              ▼
  ┌─────────────┐              ┌─────────────┐              ┌─────────────┐
  │  单个 .exe  │─────────────▶│ 自动执行:    │─────────────▶│ 开始使用    │
  │  或 .msi    │              │ 1. 安装插件  │              │             │
  │  安装文件   │              │ 2. 安装Host  │              │             │
  │             │              │ 3. 注册表    │              │             │
  └─────────────┘              └─────────────┘              └─────────────┘
```

### 4.2 技术实现细节

| 步骤 | 操作 | 技术 |
|------|------|------|
| 1. 解压 Chrome 插件 | 将插件文件放到固定目录 | 文件操作 |
| 2. 安装 Native Host | 释放 Python 打包的 .exe 文件 | PyInstaller 打包 |
| 3. 创建 Host Manifest | 生成指向 .exe 的 JSON 配置 | 模板生成 |
| 4. 注册表写入 | Windows 注册表添加 Host 路径 | reg 命令 / Python winreg |
| 5. 引导用户加载插件 | 提示用户在 Chrome 中加载 | 图文教程 |

### 4.3 安装包内容

```
ICS-WeChat-Assistant-Setup.exe  (或 .msi)
├── chrome-extension/              # Chrome 插件文件
│   ├── manifest.json
│   ├── background.js
│   ├── content.js
│   ├── popup.html
│   └── ...
├── native-host/                   # 本地桥接程序
│   ├── wechat_bridge.exe         # PyInstaller 打包的可执行文件
│   └── com.ics.wechat.json       # Native Messaging Host 配置
├── install.bat                    # 安装脚本（注册表等）
└── uninstall.bat                  # 卸载脚本
```

---

## 5. 功能模块拆解

### 5.1 Chrome 插件扩展

**修改文件**：
- `manifest.json` - 添加 `nativeMessaging` 权限
- `background.js` - 添加与本地 Host 通信逻辑
- `content.js` - 添加"一键添加微信"按钮
- `popup.html/js` - 添加微信配置入口

**新增功能**：
```javascript
// 与本地 Host 通信示例
chrome.runtime.sendNativeMessage(
  'com.ics.wechat_bridge',
  {
    action: 'addWeChatFriend',
    data: {
      wechatId: 'wx123456',
      nickname: '美妆达人小红',
      platform: 'DOUYIN',
      message: '您好，我是XXX品牌商务，想和您聊聊合作～',
      noteFormat: '{nickname}-{platform}'  // 备注格式
    }
  },
  (response) => {
    console.log('操作结果:', response);
  }
);
```

### 5.2 本地桥接程序（Native Messaging Host）

**技术栈**：Python + pywinauto

**核心功能**：

| 模块 | 功能 | 实现方式 |
|------|------|----------|
| 进程扫描 | 获取所有微信进程 | `psutil` 库 |
| 窗口识别 | 区分多个微信实例 | `pywinauto` 窗口句柄 |
| UI 自动化 | 模拟点击、输入 | `pywinauto` / `pyautogui` |
| 消息通信 | 与 Chrome 通信 | stdin/stdout JSON |

**自动化流程**：
```python
# 伪代码
def add_wechat_friend(wechat_id, message, note):
    # 1. 激活微信窗口
    app = Application().connect(title_re='微信.*')
    main_window = app.window(title_re='微信.*')
    main_window.set_focus()
    
    # 2. 打开搜索框 (Ctrl+F)
    main_window.type_keys('^f')
    time.sleep(0.5)
    
    # 3. 输入微信号
    search_box = main_window.child_window(control_type='Edit')
    search_box.type_keys(wechat_id)
    
    # 4. 点击搜索/添加
    add_button = main_window.child_window(title='添加', control_type='Button')
    add_button.click()
    
    # 5. 填写验证消息
    message_box = main_window.child_window(control_type='Edit', class_name='...')
    message_box.type_keys(message)
    
    # 6. 等待用户确认添加（不自动点击最终的"发送"）
    return {"status": "ready", "message": "请点击发送完成添加"}
```

### 5.3 Web 系统扩展（话术管理）

**新增页面**：`/app/wechat-scripts` - 话术管理

**页面功能**：
- 产品列表（关联已有样品）
- 每个产品可配置多个话术模板
- 话术支持变量：`{达人昵称}`, `{产品名}`, `{当前日期}` 等
- 默认话术设置

**UI 设计（符合 Bento Glassmorphism 风格）**：
```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📝 话术管理                                                    [+ 添加话术] │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │  🎁 产品A - 美白精华                                    [默认]   │       │
│  │  ─────────────────────────────────────────────────────────────  │       │
│  │  话术1: 您好{达人昵称}，我是XX品牌商务，我们这款{产品名}...     │       │
│  │  话术2: Hi~我是XX品牌，看了您的内容很喜欢，希望能合作...       │       │
│  │                                                   [编辑] [删除] │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │  🧴 产品B - 保湿面膜                                            │       │
│  │  ...                                                            │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  💡 支持的变量:                                                             │
│  {达人昵称} - 达人的昵称                                                    │
│  {产品名} - 选择的产品名称                                                  │
│  {品牌名} - 您的品牌/工厂名称                                               │
│  {当前日期} - 今天的日期                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.4 微信实例配置

**简化方案**：在话术管理页面添加"微信设置"Tab

**内容**：
1. 微信安装路径配置（默认自动检测，支持手动填写）
2. 多实例列表（运行时自动扫描，显示：窗口标题/登录账号）
3. 默认使用的微信实例选择

**教程说明**（当自动检测失败时显示）：
```
📖 如何手动配置微信路径：
1. 右键点击桌面微信图标
2. 选择"属性"
3. 复制"目标"栏中的路径
4. 粘贴到下方输入框
```

---

## 6. 数据库设计

### 6.1 新增数据模型

#### WeChatScript（微信话术）

```prisma
model WeChatScript {
  id          String   @id @default(uuid())
  factoryId   String                         // 所属工厂
  sampleId    String?                        // 关联产品（可选，null表示通用话术）
  name        String                         // 话术名称
  content     String   @db.Text              // 话术内容（支持变量）
  isDefault   Boolean  @default(false)       // 是否默认话术
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String                         // 创建人
  
  factory     Factory  @relation(fields: [factoryId], references: [id])
  sample      Sample?  @relation(fields: [sampleId], references: [id])
  creator     User     @relation(fields: [createdBy], references: [id])
  logs        WeChatAddLog[]
  
  @@index([factoryId])
  @@index([sampleId])
}
```

#### WeChatAddLog（添加微信日志）

```prisma
model WeChatAddLog {
  id              String   @id @default(uuid())
  factoryId       String                      // 所属工厂
  influencerId    String?                     // 关联达人（如有）
  staffId         String                      // 操作商务
  scriptId        String?                     // 使用的话术
  targetWechatId  String                      // 目标微信号
  targetNickname  String                      // 目标昵称
  targetPlatform  String?                     // 目标平台
  noteSet         String?                     // 设置的备注
  status          WeChatAddStatus             // 操作状态
  errorMessage    String?                     // 错误信息（如有）
  createdAt       DateTime @default(now())
  
  factory         Factory  @relation(fields: [factoryId], references: [id])
  influencer      Influencer? @relation(fields: [influencerId], references: [id])
  staff           User     @relation("WeChatAddLogs", fields: [staffId], references: [id])
  script          WeChatScript? @relation(fields: [scriptId], references: [id])
  
  @@index([factoryId])
  @@index([staffId])
  @@index([createdAt])
}

enum WeChatAddStatus {
  SUCCESS         // 成功
  PENDING         // 待确认（用户未点击发送）
  FAILED          // 失败
  CANCELLED       // 取消
}
```

#### WeChatConfig（微信配置）【可选，也可以存 localStorage】

```prisma
model WeChatConfig {
  id              String   @id @default(uuid())
  userId          String   @unique            // 用户ID（每个用户一条）
  wechatPath      String?                     // 微信安装路径
  defaultInstance String?                     // 默认使用的微信实例标识
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id])
}
```

### 6.2 存储策略

| 数据类型 | 存储位置 | 原因 |
|----------|----------|------|
| 话术模板 | 后端数据库 | 团队共享、持久化 |
| 操作日志 | 后端数据库 | 统计分析、追溯 |
| 微信路径配置 | 本地 localStorage | 每台电脑不同 |
| 微信实例选择 | 本地 localStorage | 运行时动态 |

---

## 7. 已确认问题汇总

### 7.1 第一轮确认

| 编号 | 问题 | 您的回答 | 结论 |
|------|------|----------|------|
| Q1 | 在插件内实现还是独立应用？ | 在插件内，桥接程序一起安装 | ✅ 采用 Native Messaging + 安装包方案 |
| Q2 | 自动化程度？ | 全自动，只保留最后点击确认 | ✅ 自动填写，用户确认发送 |
| Q3 | 多微信配置方式？ | 可以手动配置路径 | ✅ 自动检测 + 手动配置教程 |
| Q4 | 话术分类方式？ | 按产品分类，支持变量 | ✅ 关联 Sample 表 |
| Q5 | 存储方式？ | 进数据库 | ✅ 话术和日志存数据库 |
| Q6 | 是否记录日志？ | 是 | ✅ 新增 WeChatAddLog 表 |

### 7.2 第二轮确认

| 编号 | 问题 | 您的回答 | 结论 |
|------|------|----------|------|
| Q7 | 话术管理权限 | 商务可以自己管理 | ✅ 商务管理自己创建的，品牌可管理全部 |
| Q8 | 操作日志页面位置 | 话术管理页面的Tab | ✅ 话术管理页面分为"话术模板"和"添加记录"两个Tab |
| Q9 | 批量添加功能 | 两个都要，可设置间隔时间 | ✅ 支持单个+批量，批量可设置间隔（防封号） |
| Q10 | 添加失败处理 | 都要 | ✅ 记录日志 + 重试队列 |
| Q11 | 添加状态标签 | 需要"微信已添加待通过"标签 | ✅ 新增微信添加状态字段（见下方7.3节） |

---

## 7.3 微信添加状态标签设计 🆕

### 需求分析

当商务点击"一键添加微信"后，达人并没有立即通过好友请求，这时需要有一个状态来标记"已发送请求，等待通过"。这个状态应该：

1. **归属于特定商务**：A商务添加的待通过状态，B商务看不到（或者能看到但知道是A添加的）
2. **可追溯**：知道是谁、什么时候发起的添加请求
3. **可更新**：达人通过后可以更新状态

### 状态流转

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           微信添加状态流转                                    │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────┐     一键添加      ┌─────────────┐     达人通过      ┌─────────────┐
  │   未添加    │ ─────────────────▶│  添加中     │ ─────────────────▶│   已通过    │
  │  (默认)     │                   │  (待通过)   │                   │   (已添加)  │
  └─────────────┘                   └──────┬──────┘                   └─────────────┘
                                           │
                                           │ 超时/失败
                                           ▼
                                    ┌─────────────┐
                                    │   添加失败   │ ───▶ 可重试
                                    └─────────────┘
```

### 数据模型设计

**方案A：在 WeChatAddLog 中记录状态（推荐）**

```prisma
enum WeChatAddStatus {
  PENDING         // 待通过（已发送请求）
  ACCEPTED        // 已通过（达人接受了）
  REJECTED        // 已拒绝（达人拒绝了）
  EXPIRED         // 已过期（超时未处理）
  FAILED          // 添加失败（技术原因）
}

model WeChatAddLog {
  id              String   @id @default(uuid())
  factoryId       String                      // 所属工厂
  influencerId    String?                     // 关联达人
  staffId         String                      // 操作商务
  scriptId        String?                     // 使用的话术
  targetWechatId  String                      // 目标微信号
  targetNickname  String                      // 目标昵称
  targetPlatform  String?                     // 目标平台
  noteSet         String?                     // 设置的备注
  status          WeChatAddStatus @default(PENDING) // 添加状态
  errorMessage    String?                     // 错误信息
  retryCount      Int      @default(0)        // 重试次数
  createdAt       DateTime @default(now())    // 发起时间
  acceptedAt      DateTime?                   // 通过时间（如有）
  updatedAt       DateTime @updatedAt
  
  // ... relations
}
```

**在达人列表/详情中显示状态**：

通过查询 `WeChatAddLog` 表，获取该达人最新的添加状态。

### UI 展示方案

#### 方案1：达人列表中显示标签

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  达人列表                                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────┐     │
│  │ 🎬 美妆达人小红  @xiaohong123                                      │     │
│  │ 抖音 | 粉丝 50万 | 美妆护肤                                        │     │
│  │ 📱 微信: wx_xiaohong                                              │     │
│  │                                                                   │     │
│  │ [🟡 微信待通过 - 张商务 1小时前]  [一键添加微信]                    │     │
│  └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────┐     │
│  │ 🎬 护肤博主Anna  @anna_beauty                                      │     │
│  │ 小红书 | 粉丝 30万 | 护肤                                          │     │
│  │ 📱 微信: anna_wx                                                  │     │
│  │                                                                   │     │
│  │ [🟢 微信已通过]  [发起合作]                                        │     │
│  └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 方案2：达人详情页显示

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  达人详情 - 美妆达人小红                                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  基本信息                                     微信联系状态                   │
│  ──────────                                   ────────────                  │
│  昵称: 美妆达人小红                           ┌─────────────────────────┐   │
│  平台: 抖音                                   │ 🟡 待通过               │   │
│  粉丝: 50万                                   │ 添加人: 张商务          │   │
│  微信: wx_xiaohong                            │ 时间: 2026-01-12 14:30  │   │
│                                               │ 话术: 美白精华推广       │   │
│                                               │                         │   │
│                                               │ [标记已通过] [重新添加]  │   │
│                                               └─────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 权限与可见性

| 角色 | 可见范围 | 操作权限 |
|------|----------|----------|
| **商务** | 自己添加的记录 | 标记通过、重新添加 |
| **品牌** | 工厂全部记录 | 查看、导出统计 |
| **其他商务** | 仅看到"有人已添加"提示，不显示是谁 | 无（避免重复添加） |

### 避免重复添加逻辑

```javascript
// 检查是否可以添加
function canAddWeChat(influencerId, currentStaffId) {
  const latestLog = await getLatestWeChatLog(influencerId);
  
  if (!latestLog) {
    return { canAdd: true };
  }
  
  if (latestLog.status === 'ACCEPTED') {
    return { canAdd: false, reason: '该达人微信已通过', by: latestLog.staffId };
  }
  
  if (latestLog.status === 'PENDING') {
    if (latestLog.staffId === currentStaffId) {
      return { canAdd: false, reason: '您已发送添加请求，等待通过中' };
    } else {
      return { canAdd: false, reason: '其他同事已在添加中，请勿重复添加' };
    }
  }
  
  // FAILED / EXPIRED 状态可以重新添加
  return { canAdd: true };
}
```

---

## 8. 批量添加功能设计 🆕

### 8.1 功能描述

支持商务选择多个达人，设置间隔时间后批量添加微信好友。

### 8.2 操作流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           批量添加流程                                        │
└─────────────────────────────────────────────────────────────────────────────┘

  [勾选多个达人]          [设置参数]              [开始执行]
         │                    │                       │
         ▼                    ▼                       ▼
  ┌─────────────┐      ┌─────────────┐        ┌─────────────┐
  │ 多选模式    │─────▶│ 选择话术    │───────▶│ 后台执行    │
  │ ☑ 达人A     │      │ 间隔时间    │        │ 进度显示    │
  │ ☑ 达人B     │      │ 30-60秒随机 │        │             │
  │ ☑ 达人C     │      │             │        │             │
  └─────────────┘      └─────────────┘        └─────────────┘
```

### 8.3 间隔时间设计（防封号）

| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| 最小间隔 | 两次添加之间的最小等待时间 | 30秒 |
| 最大间隔 | 两次添加之间的最大等待时间 | 60秒 |
| 实际间隔 | 在最小和最大之间随机取值 | 随机 |
| 批次上限 | 单次批量添加的最大数量 | 20人 |
| 每日上限 | 每天添加的总数量上限（建议） | 50人 |

### 8.4 批量添加UI

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  批量添加微信                                                    [X 关闭]   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  已选择 5 位达人                                                            │
│  ┌─────────────────────────────────────────────────────────────┐           │
│  │ 1. 美妆达人小红 - wx_xiaohong                               │           │
│  │ 2. 护肤博主Anna - anna_wx                                   │           │
│  │ 3. 穿搭博主小美 - xiaomei123                                │           │
│  │ 4. ...                                                      │           │
│  └─────────────────────────────────────────────────────────────┘           │
│                                                                             │
│  话术选择: [美白精华推广话术 ▼]                                             │
│                                                                             │
│  间隔时间:                                                                  │
│    最小间隔: [30] 秒    最大间隔: [60] 秒                                   │
│                                                                             │
│  ⚠️ 提示: 为避免微信风控，建议每日添加不超过50人，间隔不低于30秒            │
│                                                                             │
│                                        [取消]  [🚀 开始批量添加]            │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.5 执行进度显示

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  批量添加进行中...                                               [暂停]    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  进度: 3 / 5                                                                │
│  ████████████████░░░░░░░░░░░░░░ 60%                                        │
│                                                                             │
│  ✅ 美妆达人小红 - 已发送                                                   │
│  ✅ 护肤博主Anna - 已发送                                                   │
│  🔄 穿搭博主小美 - 添加中... (等待45秒后继续)                               │
│  ⏳ 时尚博主Lily - 等待中                                                   │
│  ⏳ 美食达人小厨 - 等待中                                                   │
│                                                                             │
│  预计剩余时间: 约 2 分钟                                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 重试队列设计 🆕

### 9.1 失败原因分类

| 失败类型 | 是否可重试 | 处理方式 |
|----------|------------|----------|
| 微信号不存在 | ❌ 否 | 标记失败，提示用户核实 |
| 网络超时 | ✅ 是 | 自动加入重试队列 |
| 微信未登录 | ✅ 是 | 提示用户登录后重试 |
| 操作被中断 | ✅ 是 | 自动加入重试队列 |
| 达人已是好友 | ❌ 否 | 自动标记为"已通过" |

### 9.2 重试策略

```
重试次数: 最多3次
重试间隔: 指数退避 (30s → 60s → 120s)
超过3次: 标记为永久失败，需人工处理
```

### 9.3 重试队列UI（在"添加记录"Tab中）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  添加记录                                   [待重试: 3]  [导出]             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  筛选: [全部 ▼]  [待通过]  [已通过]  [失败]  [待重试]                       │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 🟡 待通过 | 美妆达人小红 | wx_xiaohong | 2分钟前 | [标记已通过]    │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │ 🟢 已通过 | 护肤博主Anna | anna_wx | 1小时前                         │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │ 🔴 失败(可重试) | 时尚博主Lily | lily_wx | 网络超时 | [立即重试]    │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │ ⚫ 失败 | 美食达人小厨 | - | 微信号不存在                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  [一键重试全部失败记录]                                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 10. 风险评估

### 10.1 技术风险

| 风险 | 级别 | 说明 | 应对措施 |
|------|------|------|----------|
| 微信界面更新 | 🟡 中 | 微信更新可能导致UI自动化失效 | 模块化设计，便于更新适配 |
| 账号封禁 | 🟢 低 | UI自动化模拟真实操作，风险低 | 随机延时 + 间隔设置 + 每日上限 |
| Native Host 安装失败 | 🟡 中 | 权限、杀毒软件等可能阻止 | 提供详细排错指南 |

### 10.2 业务风险

| 风险 | 级别 | 说明 | 应对措施 |
|------|------|------|----------|
| 用户使用难度 | 🟢 低 | 商务可能不熟悉安装 | 一键安装包 + 图文教程 |
| 滥用风险 | 🟡 中 | 可能被用于恶意加人 | 日志记录 + 每日上限 + 管理员可查看 |

---

## 11. 更新后的开发计划

### 11.1 模块拆分（更新）

| 模块 | 预估工时 | 依赖 | 优先级 |
|------|----------|------|--------|
| 1. 数据库模型设计 | 3h | 无 | P0 |
| 2. 后端 API - 话术 CRUD | 4h | 模块1 | P0 |
| 3. 后端 API - 日志记录与状态 | 3h | 模块1 | P0 |
| 4. 后端 API - 重试队列 | 2h | 模块3 | P1 |
| 5. 前端 - 话术管理页面 | 6h | 模块2 | P0 |
| 6. 前端 - 添加记录Tab | 4h | 模块3 | P0 |
| 7. 前端 - 达人列表状态标签 | 3h | 模块3 | P1 |
| 8. Python Native Host 开发 | 10h | 无 | P0 |
| 9. 批量添加功能（前端+后端） | 6h | 模块8 | P1 |
| 10. Chrome 插件扩展 | 4h | 模块8 | P0 |
| 11. 安装包打包 | 4h | 模块8,10 | P0 |
| 12. 测试与文档 | 5h | 全部 | P0 |

**总计**：约 54 小时（7-8 个工作日）

### 11.2 分阶段交付

```
═══════════════════════════════════════════════════════════════════════════════
                              开发阶段规划
═══════════════════════════════════════════════════════════════════════════════

Phase 1: MVP 核心功能 (Day 1-4)
──────────────────────────────
├── ✅ 数据库模型设计与迁移
├── ✅ 话术 CRUD API + 页面
├── ✅ Python Native Host（单个添加）
├── ✅ Chrome 插件集成
└── 📦 可交付: 单个达人的一键添加微信功能

Phase 2: 完善功能 (Day 5-6)
──────────────────────────────
├── ✅ 添加记录日志
├── ✅ 微信状态标签
├── ✅ 达人列表/详情显示状态
└── 📦 可交付: 完整的添加记录追踪

Phase 3: 高级功能 (Day 7-8)
──────────────────────────────
├── ✅ 批量添加功能
├── ✅ 重试队列
├── ✅ 安装包打包
├── ✅ 用户文档
└── 📦 可交付: 完整功能上线
```

---

## 📝 修订历史

| 版本 | 日期 | 修改内容 |
|------|------|----------|
| 1.0.0 | 2026-01-12 16:45 | 初稿创建 |
| 1.1.0 | 2026-01-12 16:50 | 添加批量功能、重试队列、状态标签设计 |
