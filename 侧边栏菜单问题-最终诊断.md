# 侧边栏菜单问题 - 最终诊断

## 问题确认

商务人员登录后，左侧菜单只显示"工作台"一个菜单项，其他菜单项（达人管理、合作管道、合作结果）消失。

## 诊断结果

### ✅ 后端完全正常

1. **数据库数据正确**：
   ```json
   {
     "email": "staff@demo.com",
     "role": "BUSINESS_STAFF",  // ✅ 正确
     "factoryId": "455e45d0-e015-404e-9cf5-f273eecf3e6f"
   }
   ```

2. **登录 API 响应正确**：
   ```json
   {
     "success": true,
     "data": {
       "user": {
         "role": "BUSINESS_STAFF",  // ✅ 正确
         ...
       },
       "tokens": { ... }
     }
   }
   ```

3. **后端服务逻辑正确**：
   - `auth.service.ts` 正确返回 user.role
   - `auth.routes.ts` 正确包装响应

### ❓ 前端问题待确认

根据之前的截图，localStorage 中的数据也是正确的（`role: "BUSINESS_STAFF"`），但菜单仍然只显示 1 个项目。

## 可能的原因

### 1. 前端状态管理问题

**最可能的原因**：Zustand persist 的 hydration 时序问题。

- localStorage 中有正确的数据
- 但 MainLayout 渲染时，zustand 还没有完成 hydration
- 导致 `user?.role` 是 `undefined`
- `getMenuItems(undefined || '')` 返回 `''`
- 进入 switch 的 `default` 分支，只返回 `commonItems`

### 2. React 渲染时序问题

MainLayout 可能在 user 数据完全加载前就渲染了，导致第一次渲染时 `user?.role` 是 `undefined`。

## 解决方案

### 方案 1：添加 hydration 完成检查（推荐）

在 authStore 中添加一个 `_hasHydrated` 标志：

```typescript
// authStore.ts
interface AuthState {
  // ... 现有字段
  _hasHydrated: boolean;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set) => ({
      // ... 现有状态
      _hasHydrated: false,
    }),
    {
      name: 'auth-storage',
      onRehydrateStorage: () => (state) => {
        state._hasHydrated = true;
      },
    }
  )
);
```

然后在 MainLayout 中等待 hydration 完成：

```typescript
const MainLayout = () => {
  const { user, _hasHydrated } = useAuthStore();
  
  if (!_hasHydrated) {
    return <Spin size="large" />;
  }
  
  // 现在可以安全地使用 user.role
  const menuItems = getMenuItems(user?.role || '');
  // ...
}
```

### 方案 2：使用 useMemo 缓存菜单项

```typescript
const MainLayout = () => {
  const { user } = useAuthStore();
  
  const menuItems = useMemo(() => {
    return getMenuItems(user?.role || '');
  }, [user?.role]);
  
  // ...
}
```

### 方案 3：强制重新登录

最简单但不优雅的方案：

```javascript
// 在浏览器控制台执行
localStorage.clear();
location.reload();
```

然后重新登录：staff@demo.com / staff123

## 下一步操作

请选择以下操作之一：

### 选项 A：实施方案 1（推荐）
我可以修改 authStore 和 MainLayout，添加 hydration 检查。

### 选项 B：实施方案 2
我可以在 MainLayout 中使用 useMemo 缓存菜单项。

### 选项 C：先测试方案 3
您可以先清除 localStorage 并重新登录，看看问题是否解决。如果解决了，说明确实是 hydration 时序问题。

---

**请告诉我您想尝试哪个方案？**
