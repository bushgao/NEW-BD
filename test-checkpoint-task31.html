<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkpoint Task 31 - æ•°æ®å½•å…¥éªŒè¯</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .content {
      padding: 30px;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    
    .section h2 {
      font-size: 20px;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section-icon {
      font-size: 24px;
    }
    
    .input-group {
      margin-bottom: 20px;
    }
    
    .input-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #555;
      margin-bottom: 8px;
    }
    
    .input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    .input-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      background: #218838;
    }
    
    #results {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      max-height: 600px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .test-item {
      padding: 10px;
      margin: 5px 0;
      border-radius: 4px;
      background: white;
    }
    
    .test-pass {
      border-left: 4px solid #28a745;
    }
    
    .test-fail {
      border-left: 4px solid #dc3545;
    }
    
    .summary {
      margin-top: 20px;
      padding: 20px;
      background: white;
      border-radius: 8px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .summary-item {
      text-align: center;
      padding: 15px;
      border-radius: 6px;
    }
    
    .summary-item.passed {
      background: #d4edda;
      color: #155724;
    }
    
    .summary-item.failed {
      background: #f8d7da;
      color: #721c24;
    }
    
    .summary-item.total {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .summary-item .number {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .summary-item .label {
      font-size: 14px;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
    
    .checklist {
      list-style: none;
      padding: 0;
    }
    
    .checklist li {
      padding: 10px;
      margin: 5px 0;
      background: white;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .checklist li::before {
      content: 'â˜';
      font-size: 20px;
      color: #999;
    }
    
    .checklist li.checked::before {
      content: 'âœ“';
      color: #28a745;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ§ª Checkpoint Task 31</h1>
      <p>æ•°æ®å½•å…¥éªŒè¯ - ç»¼åˆæµ‹è¯•</p>
    </div>
    
    <div class="content">
      <!-- Token è®¾ç½® -->
      <div class="section">
        <h2><span class="section-icon">ğŸ”‘</span>è®¤è¯è®¾ç½®</h2>
        <div class="input-group">
          <label for="authToken">å•†åŠ¡äººå‘˜ Token:</label>
          <input 
            type="text" 
            id="authToken" 
            placeholder="ä»æµè§ˆå™¨ localStorage ä¸­è·å– token"
          >
        </div>
        <div class="button-group">
          <button class="btn-secondary" onclick="loadTokenFromStorage()">
            ğŸ“¥ ä» LocalStorage åŠ è½½
          </button>
          <button class="btn-success" onclick="saveToken()">
            ğŸ’¾ ä¿å­˜ Token
          </button>
        </div>
      </div>
      
      <!-- æµ‹è¯•é¡¹ç›®æ¸…å• -->
      <div class="section">
        <h2><span class="section-icon">ğŸ“‹</span>æµ‹è¯•é¡¹ç›®æ¸…å•</h2>
        <ul class="checklist" id="checklist">
          <li data-test="smartForm">æ™ºèƒ½è¡¨å•è‡ªåŠ¨å¡«å……</li>
          <li data-test="recommendations">æ™ºèƒ½æ¨è</li>
          <li data-test="batchOps">æ‰¹é‡æ“ä½œ</li>
          <li data-test="validation">æ•°æ®éªŒè¯</li>
          <li data-test="cache">è¡¨å•ç¼“å­˜</li>
        </ul>
      </div>
      
      <!-- æµ‹è¯•æ§åˆ¶ -->
      <div class="section">
        <h2><span class="section-icon">ğŸ®</span>æµ‹è¯•æ§åˆ¶</h2>
        <div class="button-group">
          <button class="btn-primary" onclick="runAllTests()">
            <span id="runBtnIcon">â–¶ï¸</span>
            <span id="runBtnText">è¿è¡Œæ‰€æœ‰æµ‹è¯•</span>
          </button>
          <button class="btn-secondary" onclick="clearResults()">
            ğŸ—‘ï¸ æ¸…ç©ºç»“æœ
          </button>
        </div>
      </div>
      
      <!-- æµ‹è¯•ç»“æœ -->
      <div id="resultsContainer" class="hidden">
        <div class="summary" id="summary"></div>
        <div id="results"></div>
      </div>
    </div>
  </div>

  <!-- åŠ è½½ localforage -->
  <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
  
  <script>
    const API_BASE_URL = 'http://localhost:3000/api';
    let authToken = '';
    const testResults = {
      passed: 0,
      failed: 0,
      tests: []
    };

    // ä» localStorage åŠ è½½ token
    function loadTokenFromStorage() {
      try {
        const stored = localStorage.getItem('auth-storage');
        if (stored) {
          const data = JSON.parse(stored);
          const token = data.state?.token;
          if (token) {
            document.getElementById('authToken').value = token;
            authToken = token;
            alert('âœ… Token åŠ è½½æˆåŠŸï¼');
          } else {
            alert('âŒ æœªæ‰¾åˆ° token');
          }
        } else {
          alert('âŒ æœªæ‰¾åˆ°è®¤è¯ä¿¡æ¯');
        }
      } catch (error) {
        alert('âŒ åŠ è½½å¤±è´¥: ' + error.message);
      }
    }

    // ä¿å­˜ token
    function saveToken() {
      const token = document.getElementById('authToken').value.trim();
      if (token) {
        authToken = token;
        alert('âœ… Token å·²ä¿å­˜ï¼');
      } else {
        alert('âŒ è¯·è¾“å…¥ Token');
      }
    }

    // è®°å½•æµ‹è¯•ç»“æœ
    function logTest(name, passed, details = '') {
      const status = passed ? 'âœ… PASS' : 'âŒ FAIL';
      const resultDiv = document.getElementById('results');
      
      const testItem = document.createElement('div');
      testItem.className = `test-item ${passed ? 'test-pass' : 'test-fail'}`;
      testItem.innerHTML = `
        <div><strong>${status}: ${name}</strong></div>
        ${details ? `<div style="margin-top: 5px; color: #666;">${details}</div>` : ''}
      `;
      resultDiv.appendChild(testItem);
      
      testResults.tests.push({ name, passed, details });
      if (passed) testResults.passed++;
      else testResults.failed++;
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      resultDiv.scrollTop = resultDiv.scrollHeight;
    }

    // æ›´æ–°æ¸…å•çŠ¶æ€
    function updateChecklist(testName) {
      const item = document.querySelector(`[data-test="${testName}"]`);
      if (item) {
        item.classList.add('checked');
      }
    }

    // æµ‹è¯•æ™ºèƒ½è¡¨å•è‡ªåŠ¨å¡«å……
    async function testSmartFormAutoFill() {
      console.log('æµ‹è¯• 1: æ™ºèƒ½è¡¨å•è‡ªåŠ¨å¡«å……');
      
      try {
        const response = await fetch(
          `${API_BASE_URL}/collaborations/suggestions?influencerId=test&type=sample`,
          {
            headers: {
              'Authorization': `Bearer ${authToken}`,
              'Content-Type': 'application/json'
            }
          }
        );
        
        if (response.ok) {
          const data = await response.json();
          logTest(
            'æ™ºèƒ½å»ºè®® API å“åº”æ­£å¸¸',
            true,
            `è¿”å› ${data.data?.suggestions?.length || 0} æ¡å»ºè®®`
          );
        } else {
          logTest('æ™ºèƒ½å»ºè®® API å“åº”æ­£å¸¸', false, `çŠ¶æ€ç : ${response.status}`);
        }
      } catch (error) {
        logTest('æ™ºèƒ½å»ºè®® API å“åº”æ­£å¸¸', false, error.message);
      }
      
      updateChecklist('smartForm');
    }

    // æµ‹è¯•æ™ºèƒ½æ¨è
    async function testSmartRecommendations() {
      console.log('æµ‹è¯• 2: æ™ºèƒ½æ¨è');
      
      try {
        const response = await fetch(
          `${API_BASE_URL}/collaborations/suggestions?influencerId=test&type=price`,
          {
            headers: {
              'Authorization': `Bearer ${authToken}`,
              'Content-Type': 'application/json'
            }
          }
        );
        
        if (response.ok) {
          const data = await response.json();
          logTest(
            'ä»·æ ¼æ¨è API å“åº”æ­£å¸¸',
            true,
            `è¿”å› ${data.data?.suggestions?.length || 0} æ¡å»ºè®®`
          );
        } else {
          logTest('ä»·æ ¼æ¨è API å“åº”æ­£å¸¸', false, `çŠ¶æ€ç : ${response.status}`);
        }
      } catch (error) {
        logTest('ä»·æ ¼æ¨è API å“åº”æ­£å¸¸', false, error.message);
      }
      
      updateChecklist('recommendations');
    }

    // æµ‹è¯•æ‰¹é‡æ“ä½œ
    async function testBatchOperations() {
      console.log('æµ‹è¯• 3: æ‰¹é‡æ“ä½œ');
      
      try {
        const testData = {
          ids: ['test-id-1', 'test-id-2'],
          operation: 'updateStage',
          data: { stage: 'NEGOTIATING' }
        };
        
        const response = await fetch(
          `${API_BASE_URL}/collaborations/batch-update`,
          {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${authToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(testData)
          }
        );
        
        if (response.ok) {
          const data = await response.json();
          logTest(
            'æ‰¹é‡æ›´æ–° API å“åº”æ­£å¸¸',
            true,
            `æ›´æ–°æˆåŠŸ: ${data.data?.updated || 0}, å¤±è´¥: ${data.data?.failed || 0}`
          );
        } else {
          logTest('æ‰¹é‡æ›´æ–° API å“åº”æ­£å¸¸', false, `çŠ¶æ€ç : ${response.status}`);
        }
      } catch (error) {
        logTest('æ‰¹é‡æ›´æ–° API å“åº”æ­£å¸¸', false, error.message);
      }
      
      updateChecklist('batchOps');
    }

    // æµ‹è¯•æ•°æ®éªŒè¯
    async function testDataValidation() {
      console.log('æµ‹è¯• 4: æ•°æ®éªŒè¯');
      
      try {
        const validData = {
          influencerId: 'test-influencer-id',
          sampleId: 'test-sample-id',
          stage: 'INITIAL_CONTACT',
          expectedPrice: 1000
        };
        
        const response = await fetch(
          `${API_BASE_URL}/collaborations/validate`,
          {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${authToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ data: validData })
          }
        );
        
        if (response.ok) {
          const data = await response.json();
          logTest(
            'æ•°æ®éªŒè¯ API å“åº”æ­£å¸¸',
            true,
            `éªŒè¯ç»“æœ: ${data.data?.isValid ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ'}`
          );
        } else {
          logTest('æ•°æ®éªŒè¯ API å“åº”æ­£å¸¸', false, `çŠ¶æ€ç : ${response.status}`);
        }
      } catch (error) {
        logTest('æ•°æ®éªŒè¯ API å“åº”æ­£å¸¸', false, error.message);
      }
      
      updateChecklist('validation');
    }

    // æµ‹è¯•è¡¨å•ç¼“å­˜
    async function testFormCache() {
      console.log('æµ‹è¯• 5: è¡¨å•ç¼“å­˜');
      
      try {
        const testFormData = {
          influencerId: 'test-influencer',
          sampleId: 'test-sample',
          notes: 'Test notes',
          timestamp: Date.now()
        };
        
        await localforage.setItem('collaboration-draft-test', testFormData);
        logTest('è¡¨å•æ•°æ®ç¼“å­˜å†™å…¥æˆåŠŸ', true, 'æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°');
        
        const cachedData = await localforage.getItem('collaboration-draft-test');
        const cacheValid = cachedData && 
          cachedData.influencerId === testFormData.influencerId;
        logTest(
          'è¡¨å•æ•°æ®ç¼“å­˜è¯»å–æˆåŠŸ',
          cacheValid,
          cacheValid ? 'ç¼“å­˜æ•°æ®å®Œæ•´' : 'ç¼“å­˜æ•°æ®ä¸åŒ¹é…'
        );
        
        await localforage.removeItem('collaboration-draft-test');
        logTest('è¡¨å•ç¼“å­˜æ¸…ç†æˆåŠŸ', true, 'æµ‹è¯•æ•°æ®å·²æ¸…ç†');
      } catch (error) {
        logTest('è¡¨å•ç¼“å­˜åŠŸèƒ½', false, error.message);
      }
      
      updateChecklist('cache');
    }

    // æ›´æ–°æ±‡æ€»
    function updateSummary() {
      const summaryDiv = document.getElementById('summary');
      summaryDiv.innerHTML = `
        <div class="summary-item passed">
          <div class="number">${testResults.passed}</div>
          <div class="label">âœ… é€šè¿‡</div>
        </div>
        <div class="summary-item failed">
          <div class="number">${testResults.failed}</div>
          <div class="label">âŒ å¤±è´¥</div>
        </div>
        <div class="summary-item total">
          <div class="number">${testResults.tests.length}</div>
          <div class="label">ğŸ“ æ€»è®¡</div>
        </div>
      `;
    }

    // è¿è¡Œæ‰€æœ‰æµ‹è¯•
    async function runAllTests() {
      if (!authToken) {
        alert('âŒ è¯·å…ˆè®¾ç½® Tokenï¼');
        return;
      }
      
      // é‡ç½®ç»“æœ
      testResults.passed = 0;
      testResults.failed = 0;
      testResults.tests = [];
      
      // æ˜¾ç¤ºç»“æœå®¹å™¨
      document.getElementById('resultsContainer').classList.remove('hidden');
      document.getElementById('results').innerHTML = '';
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.getElementById('runBtnIcon').innerHTML = '<span class="loading"></span>';
      document.getElementById('runBtnText').textContent = 'æµ‹è¯•è¿›è¡Œä¸­...';
      
      // è¿è¡Œæµ‹è¯•
      await testSmartFormAutoFill();
      await testSmartRecommendations();
      await testBatchOperations();
      await testDataValidation();
      await testFormCache();
      
      // æ›´æ–°æ±‡æ€»
      updateSummary();
      
      // æ¢å¤æŒ‰é’®çŠ¶æ€
      document.getElementById('runBtnIcon').textContent = 'â–¶ï¸';
      document.getElementById('runBtnText').textContent = 'è¿è¡Œæ‰€æœ‰æµ‹è¯•';
      
      // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
      alert(`âœ… æµ‹è¯•å®Œæˆï¼\né€šè¿‡: ${testResults.passed}\nå¤±è´¥: ${testResults.failed}`);
    }

    // æ¸…ç©ºç»“æœ
    function clearResults() {
      document.getElementById('results').innerHTML = '';
      document.getElementById('resultsContainer').classList.add('hidden');
      testResults.passed = 0;
      testResults.failed = 0;
      testResults.tests = [];
      
      // é‡ç½®æ¸…å•
      document.querySelectorAll('.checklist li').forEach(item => {
        item.classList.remove('checked');
      });
    }

    // é¡µé¢åŠ è½½æ—¶å°è¯•åŠ è½½ token
    window.addEventListener('load', () => {
      loadTokenFromStorage();
    });
  </script>
</body>
</html>
