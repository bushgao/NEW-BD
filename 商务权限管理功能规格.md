# 商务权限管理功能规格

**创建时间**: 2026年1月6日  
**功能类型**: 工厂老板端 - 权限管理  
**优先级**: 高  
**预计工作量**: 1.5天

---

## 📋 功能概述

为工厂老板提供精细化的商务权限管理功能，可以控制每个商务人员的数据访问范围和操作权限，实现数据隔离和安全管理。

---

## 🎯 业务场景

### 场景1：数据隔离
**问题**: 商务测试002不应该看到商务测试001的达人信息和业绩数据  
**解决**: 通过权限控制，限制商务只能查看自己的数据

### 场景2：样品管理权限
**问题**: 普通商务不应该有权限创建/编辑/删除样品  
**解决**: 只有工厂老板或授权的高级商务才能管理样品

### 场景3：成本数据保密
**问题**: 不希望所有商务都能看到成本数据  
**解决**: 通过权限控制，只有授权人员才能查看成本

### 场景4：团队主管权限
**问题**: 团队主管需要查看所有商务的数据进行管理  
**解决**: 为团队主管配置更高的权限

---

## 🔐 权限分类

### 1. 数据可见性权限

| 权限项 | 说明 | 默认值 | 影响范围 |
|--------|------|--------|----------|
| `viewOthersInfluencers` | 查看其他商务的达人信息 | ❌ 否 | 达人管理页面 |
| `viewOthersCollaborations` | 查看其他商务的合作记录 | ❌ 否 | 合作管道页面 |
| `viewOthersPerformance` | 查看其他商务的业绩数据 | ❌ 否 | 报表页面 |
| `viewTeamData` | 查看团队整体数据 | ✅ 是 | Dashboard、报表 |
| `viewRanking` | 查看排行榜 | ✅ 是 | Dashboard |

### 2. 操作权限

| 权限项 | 说明 | 默认值 | 影响范围 |
|--------|------|--------|----------|
| `manageInfluencers` | 创建/编辑/删除达人 | ✅ 是 | 达人管理页面 |
| `manageSamples` | 创建/编辑/删除样品 | ❌ 否 | 样品管理页面 |
| `manageCollaborations` | 创建/编辑合作记录 | ✅ 是 | 合作管道页面 |
| `deleteCollaborations` | 删除合作记录 | ❌ 否 | 合作管道页面 |
| `exportData` | 导出数据 | ✅ 是 | 所有页面 |
| `batchOperations` | 批量操作 | ✅ 是 | 所有页面 |

### 3. 高级权限

| 权限项 | 说明 | 默认值 | 影响范围 |
|--------|------|--------|----------|
| `viewCostData` | 查看成本数据 | ❌ 否 | Dashboard、报表、样品 |
| `viewROIData` | 查看ROI数据 | ✅ 是 | Dashboard、报表 |
| `modifyOthersData` | 修改其他商务的数据 | ❌ 否 | 所有页面 |

---

## 📦 权限模板

### 模板1：基础商务（默认）
**适用对象**: 新入职商务、实习生

**权限配置**:
```json
{
  "dataVisibility": {
    "viewOthersInfluencers": false,
    "viewOthersCollaborations": false,
    "viewOthersPerformance": false,
    "viewTeamData": true,
    "viewRanking": true
  },
  "operations": {
    "manageInfluencers": true,
    "manageSamples": false,
    "manageCollaborations": true,
    "deleteCollaborations": false,
    "exportData": true,
    "batchOperations": true
  },
  "advanced": {
    "viewCostData": false,
    "viewROIData": true,
    "modifyOthersData": false
  }
}
```

**特点**:
- ✅ 可以管理自己的达人和合作
- ✅ 可以查看团队整体数据和排行榜
- ✅ 可以查看ROI数据
- ❌ 不能查看其他商务的详细数据
- ❌ 不能管理样品
- ❌ 不能查看成本数据

---

### 模板2：高级商务
**适用对象**: 资深商务、业绩优秀的商务

**权限配置**:
```json
{
  "dataVisibility": {
    "viewOthersInfluencers": false,
    "viewOthersCollaborations": false,
    "viewOthersPerformance": true,
    "viewTeamData": true,
    "viewRanking": true
  },
  "operations": {
    "manageInfluencers": true,
    "manageSamples": true,
    "manageCollaborations": true,
    "deleteCollaborations": false,
    "exportData": true,
    "batchOperations": true
  },
  "advanced": {
    "viewCostData": false,
    "viewROIData": true,
    "modifyOthersData": false
  }
}
```

**特点**:
- ✅ 可以管理样品
- ✅ 可以查看其他商务的业绩数据（用于学习）
- ✅ 其他权限同基础商务
- ❌ 不能查看其他商务的达人和合作详情
- ❌ 不能查看成本数据

---

### 模板3：团队主管
**适用对象**: 团队负责人、商务经理

**权限配置**:
```json
{
  "dataVisibility": {
    "viewOthersInfluencers": true,
    "viewOthersCollaborations": true,
    "viewOthersPerformance": true,
    "viewTeamData": true,
    "viewRanking": true
  },
  "operations": {
    "manageInfluencers": true,
    "manageSamples": true,
    "manageCollaborations": true,
    "deleteCollaborations": true,
    "exportData": true,
    "batchOperations": true
  },
  "advanced": {
    "viewCostData": true,
    "viewROIData": true,
    "modifyOthersData": true
  }
}
```

**特点**:
- ✅ 可以查看所有商务的数据
- ✅ 可以管理所有资源
- ✅ 可以查看成本数据
- ✅ 可以修改其他商务的数据
- ✅ 拥有最高权限（仅次于工厂老板）

---

### 模板4：自定义
**适用对象**: 特殊需求的商务

**特点**:
- 工厂老板可以自由组合各项权限
- 保存后可以作为新的模板使用

---

## 🎨 UI 设计

### 1. 团队管理页面增强

**位置**: `/app/team`

**新增内容**:
- 在每个商务的操作列添加"权限设置"按钮
- 显示当前权限模板（基础/高级/主管/自定义）

```
┌─────────────────────────────────────────────────────┐
│ 团队管理                                             │
├─────────────────────────────────────────────────────┤
│ 姓名    邮箱           状态   权限模板   操作        │
│ 张三    zhang@...     正常   基础商务   [查看详情]  │
│                                        [权限设置]   │
│                                        [禁用]       │
│                                        [删除]       │
└─────────────────────────────────────────────────────┘
```

---

### 2. 权限设置弹窗

**触发**: 点击"权限设置"按钮

**布局**:
```
┌─────────────────────────────────────────────────────┐
│ 权限设置 - 张三                                [X]   │
├─────────────────────────────────────────────────────┤
│                                                      │
│ 快速应用模板:                                        │
│ ○ 基础商务  ○ 高级商务  ○ 团队主管  ● 自定义       │
│                                                      │
│ ─────────────────────────────────────────────────   │
│                                                      │
│ 📊 数据可见性权限                                    │
│ ☐ 查看其他商务的达人信息                            │
│ ☐ 查看其他商务的合作记录                            │
│ ☐ 查看其他商务的业绩数据                            │
│ ☑ 查看团队整体数据                                  │
│ ☑ 查看排行榜                                        │
│                                                      │
│ 🔧 操作权限                                          │
│ ☑ 创建/编辑/删除达人                                │
│ ☐ 创建/编辑/删除样品                                │
│ ☑ 创建/编辑合作记录                                 │
│ ☐ 删除合作记录                                      │
│ ☑ 导出数据                                          │
│ ☑ 批量操作                                          │
│                                                      │
│ ⚡ 高级权限                                          │
│ ☐ 查看成本数据                                      │
│ ☑ 查看ROI数据                                       │
│ ☐ 修改其他商务的数据                                │
│                                                      │
│ ─────────────────────────────────────────────────   │
│                                                      │
│              [取消]  [保存并应用]                    │
└─────────────────────────────────────────────────────┘
```

---

### 3. 权限影响提示

**场景**: 商务人员登录后，如果某些功能被限制

**示例1**: 达人管理页面
```
┌─────────────────────────────────────────────────────┐
│ 达人管理                                             │
├─────────────────────────────────────────────────────┤
│ ℹ️ 您当前只能查看自己创建的达人                      │
│                                                      │
│ [搜索框] [筛选] [导出] [添加达人]                   │
│                                                      │
│ 显示: 我的达人 (15个)                               │
└─────────────────────────────────────────────────────┘
```

**示例2**: 样品管理页面
```
┌─────────────────────────────────────────────────────┐
│ 样品管理                                             │
├─────────────────────────────────────────────────────┤
│ ℹ️ 您没有权限管理样品，如需添加样品请联系管理员      │
│                                                      │
│ [搜索框] [筛选]                                      │
│ （添加样品按钮被隐藏）                               │
└─────────────────────────────────────────────────────┘
```

---

## 🔧 技术实现

### 1. 数据库 Schema

```prisma
model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String
  role        UserRole
  factoryId   String?
  
  // 新增：权限配置
  permissions Json?    @default("{}")
  
  // ... 其他字段
}
```

**permissions 字段结构**:
```typescript
interface StaffPermissions {
  dataVisibility: {
    viewOthersInfluencers: boolean;
    viewOthersCollaborations: boolean;
    viewOthersPerformance: boolean;
    viewTeamData: boolean;
    viewRanking: boolean;
  };
  operations: {
    manageInfluencers: boolean;
    manageSamples: boolean;
    manageCollaborations: boolean;
    deleteCollaborations: boolean;
    exportData: boolean;
    batchOperations: boolean;
  };
  advanced: {
    viewCostData: boolean;
    viewROIData: boolean;
    modifyOthersData: boolean;
  };
}
```

---

### 2. 后端 API

#### 2.1 获取商务权限
```typescript
GET /api/staff/:staffId/permissions

Response:
{
  "success": true,
  "data": {
    "permissions": {
      "dataVisibility": { ... },
      "operations": { ... },
      "advanced": { ... }
    },
    "template": "basic" | "advanced" | "supervisor" | "custom"
  }
}
```

#### 2.2 更新商务权限
```typescript
PUT /api/staff/:staffId/permissions

Request:
{
  "permissions": {
    "dataVisibility": { ... },
    "operations": { ... },
    "advanced": { ... }
  }
}

Response:
{
  "success": true,
  "data": {
    "user": { ... }
  }
}
```

#### 2.3 获取权限模板
```typescript
GET /api/staff/permission-templates

Response:
{
  "success": true,
  "data": {
    "templates": [
      {
        "id": "basic",
        "name": "基础商务",
        "description": "适用于新入职商务",
        "permissions": { ... }
      },
      {
        "id": "advanced",
        "name": "高级商务",
        "description": "适用于资深商务",
        "permissions": { ... }
      },
      {
        "id": "supervisor",
        "name": "团队主管",
        "description": "适用于团队负责人",
        "permissions": { ... }
      }
    ]
  }
}
```

---

### 3. 权限验证中间件

```typescript
// packages/backend/src/middleware/permission.middleware.ts

export const checkPermission = (permission: string) => {
  return async (req: Request, res: Response, next: NextFunction) => {
    const user = req.user;
    
    // 工厂老板拥有所有权限
    if (user.role === 'FACTORY_OWNER') {
      return next();
    }
    
    // 检查商务权限
    if (user.role === 'BUSINESS_STAFF') {
      const permissions = user.permissions as StaffPermissions;
      
      if (!hasPermission(permissions, permission)) {
        return res.status(403).json({
          success: false,
          error: {
            code: 'PERMISSION_DENIED',
            message: '您没有权限执行此操作'
          }
        });
      }
    }
    
    next();
  };
};

// 权限检查函数
function hasPermission(permissions: StaffPermissions, permission: string): boolean {
  const [category, key] = permission.split('.');
  
  if (category === 'dataVisibility') {
    return permissions.dataVisibility[key as keyof typeof permissions.dataVisibility];
  }
  
  if (category === 'operations') {
    return permissions.operations[key as keyof typeof permissions.operations];
  }
  
  if (category === 'advanced') {
    return permissions.advanced[key as keyof typeof permissions.advanced];
  }
  
  return false;
}
```

---

### 4. 应用权限验证到路由

```typescript
// packages/backend/src/routes/influencer.routes.ts

// 查看达人列表 - 根据权限过滤
router.get('/', 
  authenticateToken,
  async (req, res) => {
    const user = req.user;
    const permissions = user.permissions as StaffPermissions;
    
    // 如果没有查看其他商务达人的权限，只返回自己的
    if (user.role === 'BUSINESS_STAFF' && 
        !permissions.dataVisibility.viewOthersInfluencers) {
      req.query.businessStaffId = user.id;
    }
    
    // 继续处理...
  }
);

// 创建达人 - 需要权限
router.post('/',
  authenticateToken,
  checkPermission('operations.manageInfluencers'),
  createInfluencer
);

// 删除达人 - 需要权限
router.delete('/:id',
  authenticateToken,
  checkPermission('operations.manageInfluencers'),
  deleteInfluencer
);
```

---

### 5. 前端权限检查 Hook

```typescript
// packages/frontend/src/hooks/usePermissions.ts

import { useAuthStore } from '../stores/authStore';

export interface StaffPermissions {
  dataVisibility: {
    viewOthersInfluencers: boolean;
    viewOthersCollaborations: boolean;
    viewOthersPerformance: boolean;
    viewTeamData: boolean;
    viewRanking: boolean;
  };
  operations: {
    manageInfluencers: boolean;
    manageSamples: boolean;
    manageCollaborations: boolean;
    deleteCollaborations: boolean;
    exportData: boolean;
    batchOperations: boolean;
  };
  advanced: {
    viewCostData: boolean;
    viewROIData: boolean;
    modifyOthersData: boolean;
  };
}

export const usePermissions = () => {
  const { user } = useAuthStore();
  
  // 工厂老板拥有所有权限
  if (user?.role === 'FACTORY_OWNER') {
    return {
      hasPermission: () => true,
      permissions: null,
    };
  }
  
  // 商务人员权限
  const permissions = (user?.permissions || getDefaultPermissions()) as StaffPermissions;
  
  const hasPermission = (permission: string): boolean => {
    const [category, key] = permission.split('.');
    
    if (category === 'dataVisibility') {
      return permissions.dataVisibility[key as keyof typeof permissions.dataVisibility];
    }
    
    if (category === 'operations') {
      return permissions.operations[key as keyof typeof permissions.operations];
    }
    
    if (category === 'advanced') {
      return permissions.advanced[key as keyof typeof permissions.advanced];
    }
    
    return false;
  };
  
  return {
    hasPermission,
    permissions,
  };
};

// 默认权限（基础商务）
function getDefaultPermissions(): StaffPermissions {
  return {
    dataVisibility: {
      viewOthersInfluencers: false,
      viewOthersCollaborations: false,
      viewOthersPerformance: false,
      viewTeamData: true,
      viewRanking: true,
    },
    operations: {
      manageInfluencers: true,
      manageSamples: false,
      manageCollaborations: true,
      deleteCollaborations: false,
      exportData: true,
      batchOperations: true,
    },
    advanced: {
      viewCostData: false,
      viewROIData: true,
      modifyOthersData: false,
    },
  };
}
```

---

### 6. 前端组件应用权限

```typescript
// packages/frontend/src/pages/Influencers/index.tsx

import { usePermissions } from '../../hooks/usePermissions';

const InfluencersPage = () => {
  const { hasPermission } = usePermissions();
  
  // 根据权限显示/隐藏功能
  const canManageInfluencers = hasPermission('operations.manageInfluencers');
  const canViewOthers = hasPermission('dataVisibility.viewOthersInfluencers');
  
  return (
    <div>
      {!canViewOthers && (
        <Alert
          message="您当前只能查看自己创建的达人"
          type="info"
          showIcon
          closable
        />
      )}
      
      <Space>
        {canManageInfluencers && (
          <Button type="primary" icon={<PlusOutlined />}>
            添加达人
          </Button>
        )}
      </Space>
      
      {/* ... */}
    </div>
  );
};
```

---

## ✅ 验收标准

### 功能验收

1. ✅ 工厂老板可以为每个商务设置权限
2. ✅ 权限模板可以正常应用
3. ✅ 自定义权限可以保存
4. ✅ 权限修改后立即生效（无需重新登录）
5. ✅ 商务人员看到的功能和数据符合权限设置

### 数据隔离验收

1. ✅ 商务A不能看到商务B的达人（如果没有权限）
2. ✅ 商务A不能看到商务B的合作记录（如果没有权限）
3. ✅ 商务A不能看到商务B的业绩数据（如果没有权限）
4. ✅ 商务A不能修改商务B的数据（如果没有权限）

### 操作权限验收

1. ✅ 没有样品管理权限的商务不能创建/编辑/删除样品
2. ✅ 没有删除权限的商务不能删除合作记录
3. ✅ 没有导出权限的商务不能导出数据

### 安全验收

1. ✅ 前端隐藏的功能，后端也要验证权限
2. ✅ 直接调用 API 也会被权限验证拦截
3. ✅ 工厂老板始终拥有所有权限

---

## 🧪 测试用例

### 测试用例1：基础商务权限
**前置条件**: 商务测试002 使用"基础商务"模板

**测试步骤**:
1. 登录商务测试002账号
2. 进入达人管理页面
3. 查看达人列表

**预期结果**:
- ✅ 只能看到自己创建的达人
- ✅ 看不到商务测试001创建的达人
- ✅ 可以添加新达人
- ✅ 可以编辑自己的达人

---

### 测试用例2：样品管理权限
**前置条件**: 商务测试002 没有样品管理权限

**测试步骤**:
1. 登录商务测试002账号
2. 进入样品管理页面

**预期结果**:
- ✅ 看不到"添加样品"按钮
- ✅ 看不到"编辑"按钮
- ✅ 看不到"删除"按钮
- ✅ 可以查看样品列表
- ✅ 页面显示提示："您没有权限管理样品"

---

### 测试用例3：团队主管权限
**前置条件**: 商务测试003 使用"团队主管"模板

**测试步骤**:
1. 登录商务测试003账号
2. 进入达人管理页面
3. 查看达人列表

**预期结果**:
- ✅ 可以看到所有商务的达人
- ✅ 可以编辑任何达人
- ✅ 可以删除任何达人
- ✅ 可以查看成本数据

---

### 测试用例4：权限修改立即生效
**前置条件**: 商务测试002 当前使用"基础商务"模板

**测试步骤**:
1. 工厂老板登录
2. 进入团队管理页面
3. 点击商务测试002的"权限设置"
4. 应用"团队主管"模板
5. 保存
6. 商务测试002刷新页面

**预期结果**:
- ✅ 商务测试002现在可以看到所有达人
- ✅ 无需重新登录

---

## 📝 开发清单

### 后端开发（0.5天）

- [ ] 1. 数据库迁移：添加 permissions 字段
- [ ] 2. 创建权限类型定义
- [ ] 3. 实现权限验证中间件
- [ ] 4. 实现权限管理 API
  - [ ] GET /staff/:staffId/permissions
  - [ ] PUT /staff/:staffId/permissions
  - [ ] GET /staff/permission-templates
- [ ] 5. 应用权限验证到现有路由
  - [ ] 达人管理路由
  - [ ] 样品管理路由
  - [ ] 合作管理路由
  - [ ] 报表路由
- [ ] 6. 编写单元测试

### 前端开发（1天）

- [ ] 1. 创建权限 Hook (usePermissions)
- [ ] 2. 创建权限管理组件
  - [ ] StaffPermissionsModal
  - [ ] PermissionTemplateSelector
  - [ ] PermissionCheckbox
- [ ] 3. 更新团队管理页面
  - [ ] 添加"权限设置"按钮
  - [ ] 显示当前权限模板
- [ ] 4. 应用权限到各个页面
  - [ ] 达人管理页面
  - [ ] 样品管理页面
  - [ ] 合作管道页面
  - [ ] 报表页面
  - [ ] Dashboard
- [ ] 5. 添加权限提示信息
- [ ] 6. 测试所有权限场景

---

## 🚀 上线计划

### 第一阶段：开发（1.5天）
- Day 1 上午：后端开发
- Day 1 下午：前端开发（组件）
- Day 2 上午：前端开发（应用到页面）
- Day 2 下午：测试和修复

### 第二阶段：测试（0.5天）
- 功能测试
- 权限验证测试
- 安全测试

### 第三阶段：上线
- 数据库迁移
- 代码部署
- 用户培训

---

**文档状态**: ✅ 已创建  
**等待**: 开始开发
