# Zilo 系统部署和微信小程序开发计划

## 一、云服务商选择建议

### 综合评估

考虑到你的需求（中国访问 + 未来微信小程序），我**强烈推荐使用腾讯云**。

#### 腾讯云的优势

1. **微信生态集成** ⭐⭐⭐⭐⭐
   - 腾讯云与微信小程序同属腾讯生态
   - 提供微信云开发（CloudBase），专为小程序优化
   - 小程序后端服务可以直接使用腾讯云函数
   - 微信支付、企业微信等集成更便捷

2. **国内访问速度** ⭐⭐⭐⭐⭐
   - CDN 节点覆盖全国
   - 网络质量稳定
   - 备案流程相对简单

3. **性价比** ⭐⭐⭐⭐
   - 新用户有大量免费额度
   - 价格相对合理
   - 经常有优惠活动

4. **技术支持** ⭐⭐⭐⭐
   - 文档完善（中文）
   - 社区活跃
   - 客服响应快

#### 阿里云的优势

1. **市场份额最大** ⭐⭐⭐⭐⭐
2. **产品线最全** ⭐⭐⭐⭐⭐
3. **技术成熟度高** ⭐⭐⭐⭐⭐
4. **但微信小程序集成不如腾讯云便捷** ⭐⭐⭐

### 最终建议

**选择腾讯云**，原因：
- 你明确提到要做微信小程序
- 腾讯云与微信生态无缝集成
- 未来扩展更方便（企业微信、微信支付等）

---

## 二、部署方案（腾讯云）

### 方案 A：轻量应用服务器（推荐新手）

**适合场景**：
- 初期用户量不大（< 1000 日活）
- 预算有限
- 快速上线

**配置建议**：
- CPU: 2核
- 内存: 4GB
- 带宽: 5Mbps
- 系统盘: 60GB SSD
- **价格**: 约 ¥74/月

**优点**：
- 配置简单，一键部署
- 价格便宜
- 包含固定带宽

**缺点**：
- 扩展性有限
- 不支持负载均衡

### 方案 B：云服务器 CVM + 云数据库（推荐生产环境）

**适合场景**：
- 预期用户量较大
- 需要高可用性
- 长期运营

**配置建议**：
- **CVM**: 2核4GB，¥90/月
- **云数据库 MySQL**: 1核1GB，¥50/月
- **对象存储 COS**: 按量计费，约 ¥10/月
- **CDN**: 按量计费，约 ¥20/月
- **总计**: 约 ¥170/月

**优点**：
- 高可用性
- 可扩展
- 数据库独立，性能更好

### 方案 C：Serverless（推荐未来微信小程序）

**适合场景**：
- 微信小程序后端
- 流量波动大
- 按需付费

**使用服务**：
- 云函数 SCF
- 云数据库 MongoDB
- 云存储 COS
- API 网关

**优点**：
- 按量付费，成本低
- 自动扩展
- 与小程序完美集成

**缺点**：
- 需要改造现有代码
- 冷启动延迟

---

## 三、部署步骤（方案 B - 推荐）

### 阶段 1：准备工作

#### 1.1 注册腾讯云账号
- 访问 https://cloud.tencent.com/
- 完成实名认证
- 领取新用户代金券

#### 1.2 域名准备
- 购买域名（推荐在腾讯云购买，方便管理）
- 域名备案（必须，约 7-20 天）
  - 准备材料：营业执照、身份证、核验单
  - 腾讯云提供免费幕布和协助

#### 1.3 SSL 证书
- 申请免费 SSL 证书（腾讯云提供）
- 或使用 Let's Encrypt

### 阶段 2：购买和配置服务器

#### 2.1 购买云服务器 CVM
```
地域：根据用户分布选择（建议：北京/上海/广州）
机型：标准型 S5
配置：2核4GB
系统：Ubuntu 20.04 LTS
带宽：5Mbps（按需调整）
```

#### 2.2 购买云数据库 MySQL
```
版本：MySQL 8.0
配置：1核1GB（可按需升级）
存储：50GB
```

#### 2.3 配置安全组
```
入站规则：
- 22 端口（SSH）：仅允许你的 IP
- 80 端口（HTTP）：0.0.0.0/0
- 443 端口（HTTPS）：0.0.0.0/0
- 3001 端口（后端 API）：仅允许内网访问
```

### 阶段 3：服务器环境配置

#### 3.1 连接服务器
```bash
ssh root@你的服务器IP
```

#### 3.2 安装必要软件
```bash
# 更新系统
apt update && apt upgrade -y

# 安装 Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt install -y nodejs

# 安装 PM2（进程管理）
npm install -g pm2

# 安装 Nginx
apt install -y nginx

# 安装 Git
apt install -y git
```

#### 3.3 配置数据库
```bash
# 连接到云数据库
mysql -h 你的数据库内网地址 -u root -p

# 创建数据库
CREATE DATABASE zilo_production CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建用户
CREATE USER 'zilo'@'%' IDENTIFIED BY '强密码';
GRANT ALL PRIVILEGES ON zilo_production.* TO 'zilo'@'%';
FLUSH PRIVILEGES;
```

### 阶段 4：部署应用

#### 4.1 克隆代码
```bash
cd /var/www
git clone https://github.com/bushgao/NEW-BD.git zilo
cd zilo
```

#### 4.2 配置环境变量
```bash
# 后端环境变量
cd packages/backend
cp .env.example .env
nano .env
```

编辑 `.env` 文件：
```env
NODE_ENV=production
PORT=3001

# 数据库配置
DATABASE_URL="mysql://zilo:密码@数据库内网地址:3306/zilo_production"

# JWT 密钥（生成一个强密钥）
JWT_SECRET="你的超长随机密钥"

# 其他配置...
```

#### 4.3 安装依赖和构建
```bash
# 安装依赖
npm install

# 构建前端
cd packages/frontend
npm install
npm run build

# 构建后端
cd ../backend
npm install
npm run build

# 运行数据库迁移
npx prisma migrate deploy
npx prisma generate
```

#### 4.4 使用 PM2 启动应用
```bash
# 启动后端
cd /var/www/zilo/packages/backend
pm2 start dist/index.js --name zilo-backend

# 保存 PM2 配置
pm2 save
pm2 startup
```

### 阶段 5：配置 Nginx

#### 5.1 创建 Nginx 配置
```bash
nano /etc/nginx/sites-available/zilo
```

配置内容：
```nginx
server {
    listen 80;
    server_name 你的域名.com;

    # 前端静态文件
    location / {
        root /var/www/zilo/packages/frontend/dist;
        try_files $uri $uri/ /index.html;
        
        # 缓存静态资源
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # 后端 API
    location /api {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

#### 5.2 启用配置
```bash
ln -s /etc/nginx/sites-available/zilo /etc/nginx/sites-enabled/
nginx -t
systemctl restart nginx
```

#### 5.3 配置 SSL（HTTPS）
```bash
# 安装 Certbot
apt install -y certbot python3-certbot-nginx

# 获取证书
certbot --nginx -d 你的域名.com

# 自动续期
certbot renew --dry-run
```

### 阶段 6：域名解析

在腾讯云 DNS 控制台添加记录：
```
类型: A
主机记录: @
记录值: 你的服务器公网IP
TTL: 600
```

---

## 四、微信小程序开发计划

### 技术方案选择

#### 方案 A：原生小程序 + 现有后端 API（推荐）

**优点**：
- 复用现有后端逻辑
- 开发成本低
- 性能最好

**缺点**：
- 需要学习小程序开发
- 需要单独维护小程序代码

**技术栈**：
- 小程序原生框架
- 或使用 Taro/uni-app（可以同时支持多端）

#### 方案 B：云开发（CloudBase）

**优点**：
- 无需服务器
- 与微信生态深度集成
- 开发速度快

**缺点**：
- 需要重构后端
- 被腾讯云绑定

### 推荐方案：Taro + 现有后端

使用 Taro 框架的好处：
1. 使用 React 语法（你已经熟悉）
2. 一套代码可以编译成小程序、H5、App
3. 可以复用部分前端组件逻辑

### 小程序开发步骤

#### 第一步：注册小程序
1. 访问 https://mp.weixin.qq.com/
2. 注册小程序账号（需要营业执照）
3. 完成认证（¥300/年）
4. 获取 AppID

#### 第二步：安装开发工具
```bash
# 安装 Taro CLI
npm install -g @tarojs/cli

# 创建小程序项目
taro init zilo-miniprogram
```

选择：
- React
- TypeScript
- 微信小程序

#### 第三步：配置小程序
```javascript
// project.config.json
{
  "appid": "你的小程序AppID",
  "projectname": "Zilo",
  "miniprogramRoot": "dist/",
  "setting": {
    "es6": true,
    "enhance": true
  }
}
```

#### 第四步：开发核心功能

**小程序端需要实现的功能**：
1. 微信登录（使用 wx.login）
2. 达人端功能（查看合作、上传样品照片等）
3. 工厂端功能（简化版的管理功能）

**与现有后端对接**：
```typescript
// 配置 API 基础地址
const API_BASE = 'https://你的域名.com/api';

// 微信登录
async function wxLogin() {
  const { code } = await Taro.login();
  const res = await Taro.request({
    url: `${API_BASE}/auth/wechat/login`,
    method: 'POST',
    data: { code }
  });
  return res.data;
}
```

#### 第五步：后端适配

需要在现有后端添加微信登录接口：

```typescript
// packages/backend/src/routes/wechat-auth.routes.ts
router.post('/auth/wechat/login', async (req, res) => {
  const { code } = req.body;
  
  // 1. 用 code 换取 openid
  const wxRes = await axios.get('https://api.weixin.qq.com/sns/jscode2session', {
    params: {
      appid: process.env.WECHAT_APPID,
      secret: process.env.WECHAT_SECRET,
      js_code: code,
      grant_type: 'authorization_code'
    }
  });
  
  const { openid, session_key } = wxRes.data;
  
  // 2. 查找或创建用户
  let user = await prisma.user.findUnique({ where: { wechatOpenid: openid } });
  if (!user) {
    user = await prisma.user.create({
      data: { wechatOpenid: openid }
    });
  }
  
  // 3. 生成 JWT token
  const token = jwt.sign({ userId: user.id }, process.env.JWT_SECRET);
  
  res.json({ token, user });
});
```

---

## 五、完整时间线和成本估算

### 时间线

| 阶段 | 任务 | 预计时间 |
|------|------|----------|
| 第1周 | 域名购买、备案申请 | 1天（备案需等待7-20天） |
| 第2周 | 购买服务器、配置环境 | 2天 |
| 第3周 | 部署应用、测试 | 3天 |
| 第4周 | 域名解析、SSL配置 | 1天 |
| **备案期间** | 开发小程序 | 2-3周 |
| 备案完成后 | 正式上线 | 1天 |
| 上线后 | 小程序提交审核 | 3-7天 |

**总计**：约 1-1.5 个月

### 成本估算

#### 一次性成本
- 域名：¥50-100/年
- 小程序认证：¥300/年
- SSL证书：免费（Let's Encrypt）

#### 月度成本（方案 B）
- 云服务器：¥90/月
- 云数据库：¥50/月
- 对象存储：¥10/月
- CDN：¥20/月
- **合计**：¥170/月

#### 年度成本
- 服务器等：¥170 × 12 = ¥2,040
- 域名续费：¥100
- 小程序认证：¥300
- **总计**：约 ¥2,440/年

---

## 六、下一步行动清单

### 立即开始（今天）
- [ ] 注册腾讯云账号
- [ ] 购买域名
- [ ] 提交域名备案申请

### 本周完成
- [ ] 购买云服务器和数据库
- [ ] 配置服务器环境
- [ ] 部署应用到服务器

### 备案期间（1-3周）
- [ ] 注册微信小程序
- [ ] 学习 Taro 框架
- [ ] 开发小程序核心功能
- [ ] 后端添加微信登录接口

### 备案完成后
- [ ] 配置域名解析
- [ ] 配置 SSL 证书
- [ ] 正式上线测试
- [ ] 提交小程序审核

---

## 七、注意事项

### 安全建议
1. 定期更新系统和软件
2. 使用强密码
3. 配置防火墙
4. 定期备份数据库
5. 使用 HTTPS

### 性能优化
1. 启用 Nginx gzip 压缩
2. 配置 CDN 加速静态资源
3. 数据库索引优化
4. 使用 Redis 缓存热点数据

### 监控和运维
1. 配置服务器监控（腾讯云自带）
2. 配置日志收集
3. 设置告警通知
4. 定期查看服务器资源使用情况

---

## 八、需要我帮你做什么？

我可以帮你：
1. 创建详细的部署脚本
2. 编写 Nginx 配置文件
3. 创建 PM2 配置文件
4. 编写微信登录后端接口
5. 创建小程序项目模板
6. 提供更详细的某个步骤的指导

请告诉我你想从哪一步开始！
