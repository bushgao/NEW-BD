# 智能建议功能调试指南

## 问题：智能建议没有显示

---

## 🔍 调试步骤

### 步骤 1: 检查浏览器控制台

1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 打开"新建合作"弹窗
4. 选择一个达人

**查看日志**:
- 应该看到 `handleInfluencerChange: 达人选择变化: xxx`
- 应该看到 `loadSuggestions: 开始加载建议，达人 ID: xxx`
- 应该看到 `loadSuggestions: 发起 API 请求...`
- 应该看到 `loadSuggestions: API 响应: {...}`
- 应该看到 `loadSuggestions: 合并后的建议数量: X`

**如果没有看到这些日志**:
- 前端代码可能没有更新，请刷新页面（Ctrl+F5 强制刷新）

---

### 步骤 2: 检查 Network 请求

1. 切换到 Network 标签
2. 选择一个达人
3. 查找以下请求：
   - `suggestions?influencerId=xxx&type=sample`
   - `suggestions?influencerId=xxx&type=price`
   - `suggestions?influencerId=xxx&type=schedule`

**检查请求状态**:
- ✅ 状态码 200：API 正常
- ❌ 状态码 404：路由未找到
- ❌ 状态码 500：服务器错误
- ❌ 状态码 401/403：认证/权限问题

**如果是 404 错误**:
- 后端路由可能没有正确配置
- 检查后端服务是否重启

**如果是 500 错误**:
- 点击请求查看 Response
- 查看错误详情
- 检查后端控制台日志

---

### 步骤 3: 手动测试 API

在浏览器控制台运行以下代码：

```javascript
// 1. 获取 token
const token = localStorage.getItem('token');
console.log('Token:', token);

// 2. 获取达人列表
fetch('http://localhost:3000/api/influencers?page=1&pageSize=10', {
  headers: { 'Authorization': `Bearer ${token}` }
})
.then(res => res.json())
.then(data => {
  console.log('达人列表:', data);
  
  if (data.data && data.data.length > 0) {
    const influencerId = data.data[0].id;
    console.log('使用达人 ID:', influencerId);
    
    // 3. 测试样品建议
    return fetch(`http://localhost:3000/api/collaborations/suggestions?influencerId=${influencerId}&type=sample`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
  }
})
.then(res => res.json())
.then(data => {
  console.log('样品建议:', data);
})
.catch(err => {
  console.error('错误:', err);
});
```

---

### 步骤 4: 检查后端服务

1. 打开后端控制台
2. 查看是否有错误日志
3. 确认后端服务运行在 `http://localhost:3000`

**常见后端错误**:
- 数据库连接失败
- Prisma 查询错误
- 类型错误

---

### 步骤 5: 检查数据库数据

智能建议需要历史数据才能生成推荐。检查数据库：

```sql
-- 检查是否有达人
SELECT COUNT(*) FROM "Influencer";

-- 检查是否有样品
SELECT COUNT(*) FROM "Sample";

-- 检查是否有成功的合作记录
SELECT COUNT(*) FROM "Collaboration" 
WHERE stage IN ('PUBLISHED', 'REVIEWED');

-- 检查是否有合作结果
SELECT COUNT(*) FROM "CollaborationResult";
```

**如果没有历史数据**:
- 建议会显示"最新样品"、"粉丝估算报价"等低置信度推荐
- 这是正常的，不是 bug

---

## 🐛 常见问题和解决方案

### 问题 1: 建议数量为 0

**原因**: 没有历史数据

**解决方案**:
1. 创建一些测试数据
2. 创建几条合作记录并标记为"已发布"
3. 添加合作结果数据

**临时验证**: 即使没有历史数据，也应该显示低置信度的建议（最新样品、粉丝估算等）

---

### 问题 2: API 返回 404

**原因**: 路由未正确注册

**解决方案**:
1. 检查 `packages/backend/src/routes/collaboration.routes.ts`
2. 确认 `/suggestions` 路由存在
3. 重启后端服务

---

### 问题 3: API 返回 500

**原因**: 后端代码错误

**解决方案**:
1. 查看后端控制台的错误堆栈
2. 检查 Prisma 查询是否正确
3. 检查数据类型是否匹配

---

### 问题 4: 前端没有调用 API

**原因**: 
- 组件代码未更新
- 事件处理函数未触发

**解决方案**:
1. 强制刷新页面（Ctrl+F5）
2. 清除浏览器缓存
3. 检查 `handleInfluencerChange` 是否绑定到 Select 组件

---

### 问题 5: 建议卡片不显示

**原因**: 
- `suggestions` state 为空数组
- 渲染条件不满足

**解决方案**:
1. 在控制台检查 `suggestions` state
2. 检查 `renderSuggestions()` 函数的条件
3. 确认 `suggestions.length > 0`

---

## 🔧 快速修复

### 修复 1: 强制显示测试建议

在 `CreateCollaborationModal.tsx` 中临时添加测试数据：

```typescript
// 在 handleInfluencerChange 函数中添加
const handleInfluencerChange = (influencerId: string) => {
  console.log('handleInfluencerChange: 达人选择变化:', influencerId);
  setSelectedInfluencer(influencerId);
  
  // 临时测试数据
  setSuggestions([
    {
      field: 'sampleId',
      value: 'test-id',
      label: '测试样品（测试）',
      reason: '这是一个测试建议',
      confidence: 'high' as const,
    },
  ]);
  
  loadSuggestions(influencerId);
};
```

**如果测试建议显示了**:
- 说明 UI 渲染正常
- 问题在于 API 调用或数据处理

**如果测试建议也不显示**:
- 说明 UI 渲染有问题
- 检查 `renderSuggestions()` 函数

---

### 修复 2: 简化 API 调用

临时简化 `loadSuggestions` 函数：

```typescript
const loadSuggestions = useCallback(async (influencerId: string) => {
  console.log('loadSuggestions: 开始');
  
  // 直接设置测试数据
  setSuggestions([
    {
      field: 'test',
      value: 'test',
      label: '测试建议',
      reason: '测试',
      confidence: 'high' as const,
    },
  ]);
  
  console.log('loadSuggestions: 完成');
}, []);
```

---

## ✅ 验证清单

完成以下检查：

- [ ] 后端服务正在运行
- [ ] 前端页面已刷新
- [ ] 浏览器控制台有日志输出
- [ ] Network 标签有 API 请求
- [ ] API 返回状态码 200
- [ ] API 返回的数据结构正确
- [ ] `suggestions` state 有数据
- [ ] 建议卡片在 DOM 中存在

---

## 📞 需要帮助？

如果以上步骤都无法解决问题，请提供：

1. 浏览器控制台的完整日志
2. Network 标签中 API 请求的详情
3. 后端控制台的错误信息
4. 数据库中的数据情况

这样我可以更准确地定位问题。
