import{r as n,_ as ee,I as J,d as te,j as t,S as re}from"./index-CT9F3akh.js";import{r as oe,d as R}from"./CalendarOutlined-6RDrkSku.js";import{k as ae,i as se,a as le,l as ne}from"./collaboration.service-COMowK_-.js";import{P as ie}from"./influencer.service-CIZYR2fC.js";import{d as de}from"./sample.service-Cb3fiYXC.js";import{p as ce}from"./money-DMHcC8uu.js";import"./api-W_2ufh2E.js";import{F as j}from"./index-gbW5J2sR.js";import{s as p}from"./index-DBkC0DaV.js";import{M as V}from"./index-CxrQydPb.js";import{S as $}from"./index-DfnzXlZl.js";import{T as me}from"./index-CGanNrki.js";import{D as ue}from"./index-DVFXVRcq.js";import{I as fe}from"./index-htVVH06X.js";import{A as q}from"./index-C7lyzjCv.js";import{I as he,T as pe}from"./TextArea-Dl3y1VrD.js";import{S as z}from"./index-B4IHrhqI.js";import{T as ge}from"./index-DnlS8_jt.js";import{B as G}from"./button-BCSOJgfZ.js";import{R as ye}from"./BulbOutlined-DzSz1Ne2.js";var xe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M536.1 273H488c-4.4 0-8 3.6-8 8v275.3c0 2.6 1.2 5 3.3 6.5l165.3 120.7c3.6 2.6 8.6 1.9 11.2-1.7l28.6-39c2.7-3.7 1.9-8.7-1.7-11.2L544.1 528.5V281c0-4.4-3.6-8-8-8zm219.8 75.2l156.8 38.3c5 1.2 9.9-2.6 9.9-7.7l.8-161.5c0-6.7-7.7-10.5-12.9-6.3L752.9 334.1a8 8 0 003 14.1zm167.7 301.1l-56.7-19.5a8 8 0 00-10.1 4.8c-1.9 5.1-3.9 10.1-6 15.1-17.8 42.1-43.3 80-75.9 112.5a353 353 0 01-112.5 75.9 352.18 352.18 0 01-137.7 27.8c-47.8 0-94.1-9.3-137.7-27.8a353 353 0 01-112.5-75.9c-32.5-32.5-58-70.4-75.9-112.5A353.44 353.44 0 01171 512c0-47.8 9.3-94.2 27.8-137.8 17.8-42.1 43.3-80 75.9-112.5a353 353 0 01112.5-75.9C430.6 167.3 477 158 524.8 158s94.1 9.3 137.7 27.8A353 353 0 01775 261.7c10.2 10.3 19.8 21 28.6 32.3l59.8-46.8C784.7 146.6 662.2 81.9 524.6 82 285 82.1 92.6 276.7 95 516.4 97.4 751.9 288.9 942 524.8 942c185.5 0 343.5-117.6 403.7-282.3 1.5-4.2-.7-8.9-4.9-10.4z"}}]},name:"history",theme:"outlined"},Se=function(M,i){return n.createElement(he,ee({},M,{ref:i,icon:xe}))},_e=n.forwardRef(Se),K={exports:{}};(function(u,M){(function(i,s){u.exports=s()})(J,function(){return function(i,s,y){i=i||{};var c=s.prototype,l={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function x(o,f,S,b){return c.fromToBase(o,f,S,b)}y.en.relativeTime=l,c.fromToBase=function(o,f,S,b,Y){for(var A,I,g,C=S.$locale().relativeTime||l,D=i.thresholds||[{l:"s",r:44,d:"second"},{l:"m",r:89},{l:"mm",r:44,d:"minute"},{l:"h",r:89},{l:"hh",r:21,d:"hour"},{l:"d",r:35},{l:"dd",r:25,d:"day"},{l:"M",r:45},{l:"MM",r:10,d:"month"},{l:"y",r:17},{l:"yy",d:"year"}],E=D.length,w=0;w<E;w+=1){var h=D[w];h.d&&(A=b?y(o).diff(S,h.d,!0):S.diff(o,h.d,!0));var _=(i.rounding||Math.round)(Math.abs(A));if(g=A>0,_<=h.r||!h.r){_<=1&&w>0&&(h=D[w-1]);var T=C[h.l];Y&&(_=Y(""+_)),I=typeof T=="string"?T.replace("%d",_):T(_,f,h.l,g);break}}if(f)return I;var L=g?C.future:C.past;return typeof L=="function"?L(I):L.replace("%s",I)},c.to=function(o,f){return x(o,f,this,!0)},c.from=function(o,f){return x(o,f,this)};var m=function(o){return o.$u?y.utc():y()};c.toNow=function(o){return this.to(m(this),o)},c.fromNow=function(o){return this.from(m(this),o)}}})})(K);var je=K.exports;const Ne=te(je);var Ye={exports:{}};(function(u,M){(function(i,s){u.exports=s(oe())})(J,function(i){function s(l){return l&&typeof l=="object"&&"default"in l?l:{default:l}}var y=s(i),c={name:"zh-cn",weekdays:"星期日_星期一_星期二_星期三_星期四_星期五_星期六".split("_"),weekdaysShort:"周日_周一_周二_周三_周四_周五_周六".split("_"),weekdaysMin:"日_一_二_三_四_五_六".split("_"),months:"一月_二月_三月_四月_五月_六月_七月_八月_九月_十月_十一月_十二月".split("_"),monthsShort:"1月_2月_3月_4月_5月_6月_7月_8月_9月_10月_11月_12月".split("_"),ordinal:function(l,x){return x==="W"?l+"周":l+"日"},weekStart:1,yearStart:4,formats:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY/MM/DD",LL:"YYYY年M月D日",LLL:"YYYY年M月D日Ah点mm分",LLLL:"YYYY年M月D日ddddAh点mm分",l:"YYYY/M/D",ll:"YYYY年M月D日",lll:"YYYY年M月D日 HH:mm",llll:"YYYY年M月D日dddd HH:mm"},relativeTime:{future:"%s内",past:"%s前",s:"几秒",m:"1 分钟",mm:"%d 分钟",h:"1 小时",hh:"%d 小时",d:"1 天",dd:"%d 天",M:"1 个月",MM:"%d 个月",y:"1 年",yy:"%d 年"},meridiem:function(l,x){var m=100*l+x;return m<600?"凌晨":m<900?"早上":m<1100?"上午":m<1300?"中午":m<1800?"下午":"晚上"}};return y.default.locale(c,null,!0),c})})(Ye);const O="smart_form_draft_collaboration",Ie=24*60*60*1e3,qe=({visible:u,influencers:M,onClose:i})=>{const[s]=j.useForm(),[y,c]=n.useState(!1),[l,x]=n.useState([]),[m,o]=n.useState([]),[f,S]=n.useState(!1),[b,Y]=n.useState(!1),[A,I]=n.useState(null),[g,C]=n.useState(null);n.useEffect(()=>{u&&(async()=>{try{const r=await de({page:1,pageSize:100});x(r.data)}catch(r){console.error("Failed to load samples:",r)}})()},[u]);const D=n.useCallback(()=>{try{const e=localStorage.getItem(O);if(e){const{data:r,timestamp:a}=JSON.parse(e);if(Date.now()-a<Ie)return r;localStorage.removeItem(O)}}catch(e){console.error("Failed to load draft:",e)}return null},[]),E=n.useCallback(e=>{try{const r={data:e,timestamp:Date.now()};localStorage.setItem(O,JSON.stringify(r))}catch(r){console.error("Failed to save draft:",r)}},[]),w=n.useCallback(()=>{try{localStorage.removeItem(O)}catch(e){console.error("Failed to clear draft:",e)}},[]);n.useEffect(()=>{if(u){const e=D();e?(s.setFieldsValue({...e,deadline:e.deadline?R(e.deadline):void 0}),Y(!0),p.info("已恢复上次编辑的草稿")):s.setFieldsValue({stage:"LEAD"})}},[u,s,D]);const h=n.useCallback(async e=>{if(!e){console.log("loadSuggestions: 没有达人 ID");return}console.log("loadSuggestions: 开始加载建议，达人 ID:",e),S(!0);try{console.log("loadSuggestions: 发起 API 请求...");const r=await ae(e,"sample").catch(d=>(console.error("样品建议加载失败:",d),{type:"sample",suggestions:[]}));console.log("loadSuggestions: API 响应:",{sample:r});const a=[...r.suggestions];console.log("loadSuggestions: 合并后的建议数量:",a.length),o(a),a.length>0?p.success(`已加载 ${a.length} 条智能建议`):p.info("暂无智能建议，您可以手动填写")}catch(r){console.error("loadSuggestions: 加载建议失败:",r),p.error("加载智能建议失败，请手动填写")}finally{S(!1),console.log("loadSuggestions: 加载完成")}},[]),_=e=>{console.log("handleInfluencerChange: 达人选择变化:",e),I(e),o([{field:"sampleId",value:"test-sample-1",label:"测试样品A（历史最佳）",reason:"该达人使用此样品平均GMV为 ¥5000，效果最好",confidence:"high"}]),h(e)},T=(e,r)=>{Y(!0);const a=setTimeout(()=>{var k;const d={...r,deadline:(k=r.deadline)==null?void 0:k.toISOString()};E(d)},1e3);return()=>clearTimeout(a)},L=e=>{e.field==="scheduledDate"?s.setFieldValue("deadline",R(e.value)):s.setFieldValue(e.field,e.value),o(r=>r.filter(a=>a.field!==e.field)),p.success(`已应用建议：${e.label}`)},W=e=>{o(r=>r.filter(a=>a.field!==e))},X=async()=>{var e,r,a;try{const d=await s.validateFields();if(g&&!g.isValid){p.error("请修正表单中的错误后再提交");return}if(g&&g.duplicates&&g.duplicates.length>0){V.confirm({title:"发现重复数据",content:"该达人已有进行中的合作记录，是否继续创建新的合作？",onOk:async()=>{await B(d)}});return}await B(d)}catch(d){if(d.errorFields)return;p.error(((a=(r=(e=d.response)==null?void 0:e.data)==null?void 0:r.error)==null?void 0:a.message)||"创建失败")}},B=async(e,r=!1)=>{var a,d,k,N;try{c(!0);const v=await ne({influencerId:e.influencerId,stage:e.stage,sampleId:e.sampleId,quotedPrice:e.quotedPrice?ce(Number(e.quotedPrice)):void 0,deadline:(a=e.deadline)==null?void 0:a.toISOString(),notes:e.notes,forceCreate:r});if(!v.success&&v.conflicts&&v.conflicts.length>0){const F=v.conflicts;V.confirm({title:"⚠️ 联系冲突提醒",content:t.jsxs("div",{children:[t.jsxs("p",{style:{marginBottom:8},children:["该达人已被 ",F.length," 位商务跟进："]}),t.jsx("div",{style:{padding:12,background:"#fff7e6",borderRadius:6,border:"1px solid #ffd591",maxHeight:200,overflowY:"auto"},children:F.map((P,H)=>t.jsxs("div",{style:{marginBottom:H<F.length-1?12:0,paddingBottom:H<F.length-1?12:0,borderBottom:H<F.length-1?"1px dashed #ffd591":"none"},children:[t.jsx("p",{style:{margin:0},children:t.jsxs("strong",{children:[H+1,". ",P.staffName]})}),t.jsxs("p",{style:{margin:"4px 0 0 0",fontSize:12,color:"#666"},children:["当前阶段：",P.stageName]})]},P.id))}),t.jsx("p",{style:{marginTop:12,color:"#666"},children:"确定要继续创建新的合作记录吗？"})]}),okText:"继续创建",cancelText:"取消",okButtonProps:{danger:!0},onOk:async()=>{await B(e,!0)}});return}p.success("合作记录已创建"),s.resetFields(),w(),Y(!1),o([]),C(null),i(!0)}catch(v){throw p.error(((N=(k=(d=v.response)==null?void 0:d.data)==null?void 0:k.error)==null?void 0:N.message)||"创建失败"),v}finally{c(!1)}},Q=()=>{var e;if(b){const r=s.getFieldsValue(),a={...r,deadline:(e=r.deadline)==null?void 0:e.toISOString()};E(a),p.info("草稿已保存")}s.resetFields(),Y(!1),o([]),I(null),i()},U=()=>m.length===0?null:t.jsx(q,{type:"info",icon:t.jsx(ye,{}),message:"智能建议",description:t.jsx(re,{spinning:f,children:t.jsx(z,{direction:"vertical",style:{width:"100%"},children:m.map((e,r)=>t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsxs(z,{children:[t.jsx(ge,{color:e.confidence==="high"?"green":e.confidence==="medium"?"orange":"default",children:e.confidence==="high"?"强烈推荐":e.confidence==="medium"?"建议":"可选"}),t.jsx(pe,{title:e.reason,children:t.jsx("span",{children:e.label})})]}),t.jsxs(z,{children:[t.jsx(G,{type:"link",size:"small",onClick:()=>L(e),children:"应用"}),t.jsx(G,{type:"link",size:"small",onClick:()=>W(e.field),children:"忽略"})]})]},r))})}),style:{marginBottom:16}}),Z=()=>b?t.jsx(q,{type:"warning",icon:t.jsx(_e,{}),message:"有未保存的更改",description:"表单内容会自动保存为草稿，您可以随时返回继续编辑",closable:!0,style:{marginBottom:16}}):null;return t.jsxs(V,{title:"新建合作",open:u,onOk:X,onCancel:Q,confirmLoading:y,okText:"创建",cancelText:"取消",width:600,children:[Z(),U(),t.jsxs(j,{form:s,layout:"vertical",onValuesChange:T,initialValues:{stage:"LEAD"},children:[t.jsx(j.Item,{name:"influencerId",label:"选择达人",rules:[{required:!0,message:"请选择达人"}],children:t.jsx($,{showSearch:!0,placeholder:"搜索并选择达人",optionFilterProp:"children",filterOption:(e,r)=>((r==null?void 0:r.label)??"").toLowerCase().includes(e.toLowerCase()),onChange:_,options:M.map(e=>({value:e.id,label:`${e.nickname} (${ie[e.platform]} - ${e.platformId})`}))})}),t.jsx(j.Item,{name:"stage",label:"初始阶段",rules:[{required:!0,message:"请选择初始阶段"}],children:t.jsx($,{options:se.map(e=>({value:e,label:le[e]}))})}),t.jsx(j.Item,{name:"sampleId",label:"推荐样品",children:t.jsx($,{placeholder:"选择样品（可选）",allowClear:!0,options:l.map(e=>({value:e.id,label:e.name}))})}),t.jsx(j.Item,{name:"quotedPrice",label:"报价",children:t.jsx(me,{placeholder:"输入报价金额（可选）",prefix:"¥",min:0,precision:2,style:{width:"100%"}})}),t.jsx(j.Item,{name:"deadline",label:"截止时间",children:t.jsx(ue,{showTime:!0,placeholder:"选择截止时间（可选）",style:{width:"100%"},format:"YYYY-MM-DD HH:mm",disabledDate:e=>e&&e<R().startOf("day")})}),t.jsx(j.Item,{name:"notes",label:"备注",children:t.jsx(fe.TextArea,{placeholder:"输入备注信息（可选）",rows:3,maxLength:500,showCount:!0})})]})]})};export{qe as C,Ne as r};
