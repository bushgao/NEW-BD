import{r as j,_ as le,j as e}from"./index-CT9F3akh.js";import{P as ne}from"./influencer.service-CIZYR2fC.js";import{F as n}from"./index-gbW5J2sR.js";import{M as q}from"./index-CxrQydPb.js";import{S as oe}from"./index-BLPQIUwK.js";import{R as ie}from"./index-ColvUN_H.js";import{S as H}from"./index-B4IHrhqI.js";import{T as ce}from"./index-WSGRBNKI.js";import{T as v}from"./index-DnlS8_jt.js";import{A as K}from"./index-C7lyzjCv.js";import{F as de}from"./Table-pvERNZVb.js";import{R as _}from"./index-Dd1FzYQF.js";import{U as pe}from"./index-BFjyBC68.js";import{I as ue}from"./TextArea-Dl3y1VrD.js";import{B as C}from"./button-BCSOJgfZ.js";import{R as A}from"./DownloadOutlined-uTWihTI_.js";import{S as h}from"./index-DfnzXlZl.js";import{s as R}from"./index-DBkC0DaV.js";import{d as m}from"./CalendarOutlined-6RDrkSku.js";import{a as B}from"./api-W_2ufh2E.js";import{D as me}from"./index-DVFXVRcq.js";import{D as fe}from"./index-BndKrrhJ.js";var xe={icon:{tag:"svg",attrs:{viewBox:"0 0 1024 1024",focusable:"false"},children:[{tag:"path",attrs:{d:"M885.2 446.3l-.2-.8-112.2-285.1c-5-16.1-19.9-27.2-36.8-27.2H281.2c-17 0-32.1 11.3-36.9 27.6L139.4 443l-.3.7-.2.8c-1.3 4.9-1.7 9.9-1 14.8-.1 1.6-.2 3.2-.2 4.8V830a60.9 60.9 0 0060.8 60.8h627.2c33.5 0 60.8-27.3 60.9-60.8V464.1c0-1.3 0-2.6-.1-3.7.4-4.9 0-9.6-1.3-14.1zm-295.8-43l-.3 15.7c-.8 44.9-31.8 75.1-77.1 75.1-22.1 0-41.1-7.1-54.8-20.6S436 441.2 435.6 419l-.3-15.7H229.5L309 210h399.2l81.7 193.3H589.4zm-375 76.8h157.3c24.3 57.1 76 90.8 140.4 90.8 33.7 0 65-9.4 90.3-27.2 22.2-15.6 39.5-37.4 50.7-63.6h156.5V814H214.4V480.1z"}}]},name:"inbox",theme:"outlined"},he=function(s,l){return j.createElement(ue,le({},s,{ref:l,icon:xe}))},je=j.forwardRef(he);const M={influencers:"达人列表",samples:"样品列表",dispatches:"寄样记录",collaborations:"合作记录",results:"合作结果","staff-performance":"商务绩效报表","roi-report":"ROI报表","sample-cost-report":"样品成本报表"},V={influencers:"达人",samples:"样品"};async function ge(i,s="influencers"){const l=new FormData;return l.append("file",i),l.append("type",s),(await B.post("/import/parse",l,{headers:{"Content-Type":"multipart/form-data"}})).data.data}async function be(i,s,l="influencers"){const c=new FormData;return c.append("file",i),c.append("mapping",JSON.stringify(s)),c.append("type",l),(await B.post("/import/preview",c,{headers:{"Content-Type":"multipart/form-data"}})).data.data}async function we(i,s,l="influencers",c=!0){const d=new FormData;return d.append("file",i),d.append("mapping",JSON.stringify(s)),d.append("type",l),d.append("skipDuplicates",String(c)),(await B.post("/import/execute",d,{headers:{"Content-Type":"multipart/form-data"}})).data.data}async function ye(i){const s=await B.get(`/template/${i}`,{responseType:"blob"}),l=s.headers["content-disposition"];let c=i==="samples"?"样品导入模板.xlsx":"达人导入模板.xlsx";if(l){const I=l.match(/filename\*=UTF-8''(.+)/);I&&(c=decodeURIComponent(I[1]))}const d=new Blob([s.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),p=window.URL.createObjectURL(d),r=document.createElement("a");r.href=p,r.download=c,document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(p)}async function ve(i,s={}){const l=new URLSearchParams;s.startDate&&l.append("startDate",s.startDate),s.endDate&&l.append("endDate",s.endDate),s.groupBy&&l.append("groupBy",s.groupBy);const c=await B.get(`/export/${i}`,{params:l,responseType:"blob"}),d=c.headers["content-disposition"];let p=`${M[i]}_${new Date().toISOString().slice(0,10)}.xlsx`;if(d){const S=d.match(/filename\*=UTF-8''(.+)/);S&&(p=decodeURIComponent(S[1]))}const r=new Blob([c.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),I=window.URL.createObjectURL(r),f=document.createElement("a");f.href=I,f.download=p,document.body.appendChild(f),f.click(),document.body.removeChild(f),window.URL.revokeObjectURL(I)}const{Dragger:Ie}=pe,{Text:k}=ce,Ye=({visible:i,onClose:s,defaultType:l="influencers",allowTypeChange:c=!0})=>{const[d,p]=j.useState(0),[r,I]=j.useState(l),[f,S]=j.useState(null),[o,T]=j.useState([]),[U,D]=j.useState({}),[$,u]=j.useState([]),[x,O]=j.useState({total:0,valid:0,error:0,duplicate:0}),[y,L]=j.useState(null),[P,F]=j.useState(!1),[Y,z]=j.useState(!1),[E]=n.useForm(),W=async()=>{var t,a,b;z(!0);try{await ye(r),R.success("模板下载成功")}catch(g){R.error(((b=(a=(t=g.response)==null?void 0:t.data)==null?void 0:a.error)==null?void 0:b.message)||"模板下载失败")}finally{z(!1)}},X=()=>{p(0),S(null),T([]),D({}),u([]),O({total:0,valid:0,error:0,duplicate:0}),L(null),E.resetFields()},N=t=>{X(),s(t)},Q=async t=>{var a,b,g;if(t.originFileObj){F(!0);try{const w=await ge(t.originFileObj,r);S(t.originFileObj),T(w.headers),D(w.suggestedMapping),E.setFieldsValue(w.suggestedMapping),p(1)}catch(w){R.error(((g=(b=(a=w.response)==null?void 0:a.data)==null?void 0:b.error)==null?void 0:g.message)||"文件解析失败")}finally{F(!1)}}},Z=async()=>{var t,a,b;try{const g=await E.validateFields();if(!f)return;F(!0);const w=await be(f,g,r);D(g),u(w.preview),O({total:w.totalRows,valid:w.validRows,error:w.errorRows,duplicate:w.duplicateRows}),p(2)}catch(g){(b=(a=(t=g.response)==null?void 0:t.data)==null?void 0:a.error)!=null&&b.message&&R.error(g.response.data.error.message)}finally{F(!1)}},G=async()=>{var t,a,b;if(f){F(!0);try{const g=await we(f,U,r,!0);L(g),p(3)}catch(g){R.error(((b=(a=(t=g.response)==null?void 0:t.data)==null?void 0:a.error)==null?void 0:b.message)||"导入失败")}finally{F(!1)}}},ee=r==="samples"?[{title:"行号",dataIndex:"rowNumber",key:"rowNumber",width:60},{title:"SKU",dataIndex:["data","sku"],key:"sku",width:100},{title:"名称",dataIndex:["data","name"],key:"name",width:150},{title:"单件成本",dataIndex:["data","unitCost"],key:"unitCost",width:100,render:t=>t?`¥${(t/100).toFixed(2)}`:"-"},{title:"建议零售价",dataIndex:["data","retailPrice"],key:"retailPrice",width:100,render:t=>t?`¥${(t/100).toFixed(2)}`:"-"},{title:"状态",key:"status",width:100,render:(t,a)=>a.errors.length>0?e.jsx(v,{color:"error",children:"数据错误"}):a.isDuplicate?e.jsx(v,{color:"warning",children:"重复"}):e.jsx(v,{color:"success",children:"有效"})},{title:"问题",key:"issues",render:(t,a)=>a.errors.length>0?e.jsx(k,{type:"danger",children:a.errors.join("; ")}):a.isDuplicate&&a.duplicateInfo?e.jsxs(k,{type:"warning",children:['SKU与已有样品"',a.duplicateInfo.existingName,'"重复']}):"-"}]:[{title:"行号",dataIndex:"rowNumber",key:"rowNumber",width:60},{title:"昵称",dataIndex:["data","nickname"],key:"nickname",width:120},{title:"平台",dataIndex:["data","platform"],key:"platform",width:80,render:t=>t&&ne[t]},{title:"平台账号ID",dataIndex:["data","platformId"],key:"platformId",width:120,ellipsis:!0},{title:"状态",key:"status",width:100,render:(t,a)=>a.errors.length>0?e.jsx(v,{color:"error",children:"数据错误"}):a.isDuplicate?e.jsx(v,{color:"warning",children:"重复"}):e.jsx(v,{color:"success",children:"有效"})},{title:"问题",key:"issues",render:(t,a)=>a.errors.length>0?e.jsx(k,{type:"danger",children:a.errors.join("; ")}):a.isDuplicate&&a.duplicateInfo?e.jsxs(k,{type:"warning",children:['与已有数据"',a.duplicateInfo.existingName,'"重复']}):"-"}],te=()=>e.jsxs(e.Fragment,{children:[e.jsx(n.Item,{name:"nickname",label:"昵称列",rules:[{required:!0,message:"请选择昵称列"}],children:e.jsx(h,{placeholder:"请选择",options:o.map(t=>({value:t,label:t}))})}),e.jsx(n.Item,{name:"platform",label:"平台列",rules:[{required:!0,message:"请选择平台列"}],children:e.jsx(h,{placeholder:"请选择",options:o.map(t=>({value:t,label:t}))})}),e.jsx(n.Item,{name:"platformId",label:"平台账号ID列",rules:[{required:!0,message:"请选择平台账号ID列"}],children:e.jsx(h,{placeholder:"请选择",options:o.map(t=>({value:t,label:t}))})}),e.jsx(n.Item,{name:"phone",label:"手机号列（可选）",children:e.jsx(h,{placeholder:"请选择",allowClear:!0,options:o.map(t=>({value:t,label:t}))})}),e.jsx(n.Item,{name:"categories",label:"类目列（可选）",children:e.jsx(h,{placeholder:"请选择",allowClear:!0,options:o.map(t=>({value:t,label:t}))})}),e.jsx(n.Item,{name:"tags",label:"标签列（可选）",children:e.jsx(h,{placeholder:"请选择",allowClear:!0,options:o.map(t=>({value:t,label:t}))})}),e.jsx(n.Item,{name:"notes",label:"备注列（可选）",children:e.jsx(h,{placeholder:"请选择",allowClear:!0,options:o.map(t=>({value:t,label:t}))})})]}),ae=()=>e.jsxs(e.Fragment,{children:[e.jsx(n.Item,{name:"sku",label:"SKU列",rules:[{required:!0,message:"请选择SKU列"}],children:e.jsx(h,{placeholder:"请选择",options:o.map(t=>({value:t,label:t}))})}),e.jsx(n.Item,{name:"name",label:"名称列",rules:[{required:!0,message:"请选择名称列"}],children:e.jsx(h,{placeholder:"请选择",options:o.map(t=>({value:t,label:t}))})}),e.jsx(n.Item,{name:"unitCost",label:"单件成本列（元）",rules:[{required:!0,message:"请选择单件成本列"}],children:e.jsx(h,{placeholder:"请选择",options:o.map(t=>({value:t,label:t}))})}),e.jsx(n.Item,{name:"retailPrice",label:"建议零售价列（元）",rules:[{required:!0,message:"请选择建议零售价列"}],children:e.jsx(h,{placeholder:"请选择",options:o.map(t=>({value:t,label:t}))})}),e.jsx(n.Item,{name:"canResend",label:"可复寄列（可选）",children:e.jsx(h,{placeholder:"请选择",allowClear:!0,options:o.map(t=>({value:t,label:t}))})}),e.jsx(n.Item,{name:"notes",label:"备注列（可选）",children:e.jsx(h,{placeholder:"请选择",allowClear:!0,options:o.map(t=>({value:t,label:t}))})})]}),re=()=>{switch(d){case 0:return e.jsxs("div",{children:[c&&e.jsxs("div",{style:{marginBottom:16},children:[e.jsx(k,{strong:!0,children:"选择导入类型："}),e.jsxs(_.Group,{value:r,onChange:t=>I(t.target.value),style:{marginLeft:16},children:[e.jsx(_.Button,{value:"influencers",children:"达人"}),e.jsx(_.Button,{value:"samples",children:"样品"})]})]}),e.jsxs(Ie,{accept:".xlsx,.xls,.csv",maxCount:1,beforeUpload:()=>!1,onChange:({file:t})=>Q(t),showUploadList:!1,children:[e.jsx("p",{className:"ant-upload-drag-icon",children:e.jsx(je,{})}),e.jsx("p",{className:"ant-upload-text",children:"点击或拖拽文件到此区域上传"}),e.jsx("p",{className:"ant-upload-hint",children:"支持 Excel (.xlsx, .xls) 或 CSV 文件"})]}),e.jsx("div",{style:{marginTop:16,textAlign:"center"},children:e.jsxs(C,{icon:e.jsx(A,{}),onClick:W,loading:Y,children:["下载",V[r],"导入模板"]})})]});case 1:return e.jsxs(n,{form:E,layout:"vertical",children:[e.jsx(K,{type:"info",message:`请将文件中的列映射到${V[r]}字段`,style:{marginBottom:16}}),r==="samples"?ae():te()]});case 2:return e.jsxs("div",{children:[e.jsxs(H,{style:{marginBottom:16},children:[e.jsxs(v,{color:"default",children:["总计: ",x.total]}),e.jsxs(v,{color:"success",children:["有效: ",x.valid]}),e.jsxs(v,{color:"error",children:["错误: ",x.error]}),e.jsxs(v,{color:"warning",children:["重复: ",x.duplicate]})]}),x.duplicate>0&&e.jsx(K,{type:"warning",message:`检测到 ${x.duplicate} 条重复数据，导入时将自动跳过`,style:{marginBottom:16}}),e.jsx(de,{columns:ee,dataSource:$,rowKey:"rowNumber",size:"small",scroll:{y:300},pagination:!1})]});case 3:return y?e.jsx(ie,{status:y.successCount>0?"success":"warning",title:"导入完成",subTitle:e.jsxs(H,{direction:"vertical",children:[e.jsxs(k,{children:["成功导入: ",y.successCount," 条"]}),e.jsxs(k,{children:["跳过重复: ",y.duplicateCount," 条"]}),e.jsxs(k,{children:["导入失败: ",y.errorCount," 条"]}),y.skippedCount>0&&e.jsxs(k,{type:"warning",children:["因配额限制跳过: ",y.skippedCount," 条"]})]})}):null;default:return null}},se=()=>{switch(d){case 0:return[e.jsx(C,{onClick:()=>N(),children:"取消"},"cancel")];case 1:return[e.jsx(C,{onClick:()=>p(0),children:"上一步"},"back"),e.jsx(C,{type:"primary",loading:P,onClick:Z,children:"下一步"},"next")];case 2:return[e.jsx(C,{onClick:()=>p(1),children:"上一步"},"back"),e.jsxs(C,{type:"primary",loading:P,onClick:G,disabled:x.valid===0,children:["确认导入 (",x.valid," 条)"]},"import")];case 3:return[e.jsx(C,{type:"primary",onClick:()=>N(!0),children:"完成"},"close")];default:return[]}};return e.jsxs(q,{title:`批量导入${V[r]}`,open:i,onCancel:()=>N(),footer:se(),width:800,destroyOnClose:!0,children:[e.jsx(oe,{current:d,items:[{title:"上传文件"},{title:"字段映射"},{title:"预览确认"},{title:"导入完成"}],style:{marginBottom:24}}),re()]})},{RangePicker:J}=me,We=({types:i=["influencers","samples","dispatches","collaborations","results"],showDateRange:s=!0,showGroupBy:l=!1,buttonText:c="导出"})=>{const[d,p]=j.useState(!1),[r,I]=j.useState(null),[f,S]=j.useState(!1),[o]=n.useForm(),T=async u=>{if(s||l&&u==="roi-report"){I(u),p(!0);return}await U(u,{})},U=async(u,x)=>{var O,y,L;S(!0);try{await ve(u,x),R.success("导出成功"),p(!1),o.resetFields()}catch(P){R.error(((L=(y=(O=P.response)==null?void 0:O.data)==null?void 0:y.error)==null?void 0:L.message)||"导出失败")}finally{S(!1)}},D=async()=>{if(!r)return;const u=o.getFieldsValue(),x={};u.dateRange&&(x.startDate=u.dateRange[0].toISOString(),x.endDate=u.dateRange[1].toISOString()),u.groupBy&&(x.groupBy=u.groupBy),await U(r,x)},$=i.map(u=>({key:u,label:M[u],onClick:()=>T(u)}));return i.length===1?e.jsxs(e.Fragment,{children:[e.jsx(C,{icon:e.jsx(A,{}),onClick:()=>T(i[0]),loading:f,children:c}),e.jsx(q,{title:`导出${r?M[r]:""}`,open:d,onOk:D,onCancel:()=>{p(!1),o.resetFields()},confirmLoading:f,okText:"导出",cancelText:"取消",children:e.jsxs(n,{form:o,layout:"vertical",children:[s&&e.jsx(n.Item,{name:"dateRange",label:"日期范围（可选）",children:e.jsx(J,{style:{width:"100%"},presets:[{label:"本周",value:[m().startOf("week"),m()]},{label:"本月",value:[m().startOf("month"),m()]},{label:"近30天",value:[m().subtract(30,"day"),m()]},{label:"近90天",value:[m().subtract(90,"day"),m()]}]})}),l&&r==="roi-report"&&e.jsx(n.Item,{name:"groupBy",label:"分组方式",initialValue:"month",children:e.jsx(h,{options:[{value:"influencer",label:"按达人"},{value:"sample",label:"按样品"},{value:"staff",label:"按商务"},{value:"month",label:"按月份"}]})})]})})]}):e.jsxs(e.Fragment,{children:[e.jsx(fe,{menu:{items:$},placement:"bottomRight",children:e.jsx(C,{icon:e.jsx(A,{}),loading:f,children:c})}),e.jsx(q,{title:`导出${r?M[r]:""}`,open:d,onOk:D,onCancel:()=>{p(!1),o.resetFields()},confirmLoading:f,okText:"导出",cancelText:"取消",children:e.jsxs(n,{form:o,layout:"vertical",children:[s&&e.jsx(n.Item,{name:"dateRange",label:"日期范围（可选）",children:e.jsx(J,{style:{width:"100%"},presets:[{label:"本周",value:[m().startOf("week"),m()]},{label:"本月",value:[m().startOf("month"),m()]},{label:"近30天",value:[m().subtract(30,"day"),m()]},{label:"近90天",value:[m().subtract(90,"day"),m()]}]})}),l&&r==="roi-report"&&e.jsx(n.Item,{name:"groupBy",label:"分组方式",initialValue:"month",children:e.jsx(h,{options:[{value:"influencer",label:"按达人"},{value:"sample",label:"按样品"},{value:"staff",label:"按商务"},{value:"month",label:"按月份"}]})})]})})]})};export{We as E,Ye as I,je as R,ye as d};
