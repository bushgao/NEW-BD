import{r as i,j as e,S as W,e as ne}from"./index-CT9F3akh.js";import{a as T}from"./api-W_2ufh2E.js";import{P as X}from"./influencer.service-CIZYR2fC.js";import{C as O,a as E}from"./Card-D9YXdlEe.js";import{m as ie}from"./collaboration.service-COMowK_-.js";import{d as Z}from"./CalendarOutlined-6RDrkSku.js";import{F as g}from"./index-gbW5J2sR.js";import{s as v}from"./index-DBkC0DaV.js";import{M as ee}from"./index-CxrQydPb.js";import{S as Y}from"./index-DfnzXlZl.js";import{D}from"./index-BIA-WqSn.js";import{f as P,b as te}from"./money-DMHcC8uu.js";import{D as le}from"./index-N65tUqUy.js";import{T as q}from"./index-DnlS8_jt.js";import{D as U}from"./index-DVFXVRcq.js";import{T as z}from"./index-CGanNrki.js";import{S as oe}from"./index-2ffhpgky.js";import{I as ce}from"./index-htVVH06X.js";import{R as G,C as d}from"./row-DVjUYxl3.js";import{C as $}from"./index-DSHlf2Aa.js";import{S as w}from"./index-C_yDWHqX.js";import{F as ae}from"./Table-pvERNZVb.js";import{T as de}from"./index-WSGRBNKI.js";import{S as ue}from"./index-B4IHrhqI.js";import{B as H}from"./button-BCSOJgfZ.js";import{R as me}from"./BarChartOutlined-DdaTVtk6.js";import{R as pe}from"./PlusOutlined-oMbGAVrA.js";import"./TextArea-Dl3y1VrD.js";import"./PurePanel-DcW2x34y.js";import"./Overflow-Gz7ZFAqv.js";import"./Input-UrGHJeeK.js";import"./QuestionCircleOutlined-CZssou_a.js";import"./UnstableContext-DKFbPjPy.js";import"./ActionButton-DPGDuFxb.js";import"./Skeleton-DdNqplha.js";import"./index-BoArUKpt.js";import"./fade-pCPugiYp.js";import"./SearchOutlined-CyHaylvE.js";import"./useBreakpoint--6XYT0_e.js";import"./index-Do9OUhYv.js";import"./extendsObject-78o_rR5W.js";import"./ClockCircleOutlined-DAoco557.js";import"./index-DiUoGV2L.js";import"./EllipsisOutlined-Bv641ndy.js";import"./index-Dd1FzYQF.js";import"./index-BndKrrhJ.js";import"./LeftOutlined-DGEyRIvL.js";import"./Pagination-6AhiOKxV.js";const Q={SHORT_VIDEO:"短视频",LIVE_STREAM:"直播"},K={LOSS:"未回本",BREAK_EVEN:"刚回本",PROFIT:"已回本",HIGH_PROFIT:"爆赚"},se={LOSS:"#ff4d4f",BREAK_EVEN:"#faad14",PROFIT:"#52c41a",HIGH_PROFIT:"#13c2c2"};async function he(a={}){const r={page:a.page||1,pageSize:a.pageSize||20};return a.profitStatus&&(r.profitStatus=a.profitStatus),a.contentType&&(r.contentType=a.contentType),a.businessStaffId&&(r.businessStaffId=a.businessStaffId),a.startDate&&(r.startDate=a.startDate),a.endDate&&(r.endDate=a.endDate),(await T.get("/results",{params:r})).data.data}async function fe(a){return(await T.get(`/results/${a}`)).data.data.result}async function xe(a){return(await T.post("/results",a)).data.data.result}async function ge(a,r){return(await T.put(`/results/${a}`,r)).data.data.result}async function ye(a){const r={};return a&&(r.startDate=a.startDate,r.endDate=a.endDate),(await T.get("/results/stats",{params:r})).data.data}async function je(a,r){const u={groupBy:a};return r&&(u.startDate=r.startDate,u.endDate=r.endDate),(await T.get("/results/report",{params:u})).data.data}const Se=({visible:a,result:r,onClose:u})=>{var V;const[y]=g.useForm(),[b,R]=i.useState(!1),[C,j]=i.useState(!1),[o,f]=i.useState([]),[c,x]=i.useState(null),[m,l]=i.useState(null),h=!!r;i.useEffect(()=>{a&&(r?_():L())},[a,r]);const _=async()=>{if(r){R(!0);try{const s=await fe(r.id);l(s),y.setFieldsValue({contentType:s.contentType,publishedAt:Z(s.publishedAt),salesQuantity:s.salesQuantity,salesGmv:s.salesGmv/100,commissionRate:s.commissionRate,pitFee:s.pitFee/100,actualCommission:s.actualCommission/100,willRepeat:s.willRepeat,notes:s.notes})}catch{v.error("获取结果详情失败")}finally{R(!1)}}},L=async()=>{R(!0);try{const s=await ie({stage:"PUBLISHED",pageSize:100});f(s.data)}catch{v.error("获取合作列表失败")}finally{R(!1)}},N=s=>{const p=o.find(I=>I.id===s);x(p||null)},B=async()=>{var s,p,I;try{const S=await y.validateFields();j(!0);const A={...S,publishedAt:S.publishedAt.toISOString(),salesGmv:Math.round(S.salesGmv*100),pitFee:S.pitFee?Math.round(S.pitFee*100):0,actualCommission:Math.round(S.actualCommission*100)};h&&r?(await ge(r.id,A),v.success("更新成功")):(await xe(A),v.success("录入成功")),y.resetFields(),x(null),l(null),u(!0)}catch(S){if(S.errorFields)return;v.error(((I=(p=(s=S.response)==null?void 0:s.data)==null?void 0:p.error)==null?void 0:I.message)||"操作失败")}finally{j(!1)}},k=()=>{y.resetFields(),x(null),l(null),u()},F=()=>m?m.totalSampleCost:c!=null&&c.dispatches?c.dispatches.reduce((s,p)=>s+p.totalCost,0):0;return e.jsx(ee,{title:h?"编辑合作结果":"录入合作结果",open:a,onOk:B,onCancel:k,confirmLoading:C,width:600,okText:h?"保存":"录入",cancelText:"取消",children:e.jsx(W,{spinning:b,children:e.jsxs(g,{form:y,layout:"vertical",initialValues:{contentType:"SHORT_VIDEO",willRepeat:!1,pitFee:0},children:[!h&&e.jsx(g.Item,{name:"collaborationId",label:"选择合作",rules:[{required:!0,message:"请选择合作"}],children:e.jsx(Y,{showSearch:!0,placeholder:"搜索并选择合作",optionFilterProp:"children",onChange:N,filterOption:(s,p)=>((p==null?void 0:p.label)??"").toLowerCase().includes(s.toLowerCase()),options:o.map(s=>({value:s.id,label:`${s.influencer.nickname} (${X[s.influencer.platform]})`}))})}),(c||m)&&e.jsxs(e.Fragment,{children:[e.jsxs(D,{size:"small",column:2,style:{marginBottom:16},children:[e.jsx(D.Item,{label:"达人",children:((V=m==null?void 0:m.collaboration)==null?void 0:V.influencer.nickname)||(c==null?void 0:c.influencer.nickname)}),e.jsxs(D.Item,{label:"样品成本",children:["¥",P(F())]})]}),e.jsx(le,{style:{margin:"12px 0"}})]}),h&&m&&e.jsxs(D,{size:"small",column:2,style:{marginBottom:16},children:[e.jsx(D.Item,{label:"当前 ROI",children:m.roi.toFixed(2)}),e.jsx(D.Item,{label:"回本状态",children:e.jsx(q,{color:se[m.profitStatus],children:K[m.profitStatus]})})]}),e.jsx(g.Item,{name:"contentType",label:"内容类型",rules:[{required:!0,message:"请选择内容类型"}],children:e.jsx(Y,{options:Object.entries(Q).map(([s,p])=>({value:s,label:p}))})}),e.jsx(g.Item,{name:"publishedAt",label:"发布时间",rules:[{required:!0,message:"请选择发布时间"}],children:e.jsx(U,{style:{width:"100%"}})}),e.jsx(g.Item,{name:"salesQuantity",label:"销售件数",rules:[{required:!0,message:"请输入销售件数"}],children:e.jsx(z,{min:0,style:{width:"100%"},placeholder:"请输入销售件数"})}),e.jsx(g.Item,{name:"salesGmv",label:"销售 GMV（元）",rules:[{required:!0,message:"请输入销售 GMV"}],children:e.jsx(z,{min:0,precision:2,style:{width:"100%"},placeholder:"请输入销售 GMV",prefix:"¥"})}),e.jsx(g.Item,{name:"commissionRate",label:"佣金比例（%）",children:e.jsx(z,{min:0,max:100,precision:2,style:{width:"100%"},placeholder:"请输入佣金比例",suffix:"%"})}),e.jsx(g.Item,{name:"pitFee",label:"坑位费（元）",children:e.jsx(z,{min:0,precision:2,style:{width:"100%"},placeholder:"请输入坑位费",prefix:"¥"})}),e.jsx(g.Item,{name:"actualCommission",label:"实付佣金（元）",rules:[{required:!0,message:"请输入实付佣金"}],children:e.jsx(z,{min:0,precision:2,style:{width:"100%"},placeholder:"请输入实付佣金",prefix:"¥"})}),e.jsx(g.Item,{name:"willRepeat",label:"是否复投",valuePropName:"checked",children:e.jsx(oe,{checkedChildren:"是",unCheckedChildren:"否"})}),e.jsx(g.Item,{name:"notes",label:"备注",children:e.jsx(ce.TextArea,{rows:3,placeholder:"请输入备注",maxLength:500,showCount:!0})})]})})})},{RangePicker:be}=U,Re=[{value:"influencer",label:"按达人"},{value:"sample",label:"按样品"},{value:"staff",label:"按商务"},{value:"month",label:"按月份"}],we=({visible:a,onClose:r})=>{const[u,y]=i.useState(!1),[b,R]=i.useState("influencer"),[C,j]=i.useState(),[o,f]=i.useState(null);i.useEffect(()=>{a&&c()},[a,b,C]);const c=async()=>{y(!0);try{const l=await je(b,C);f(l)}catch{v.error("获取报表失败")}finally{y(!1)}},x=l=>{j(l?{startDate:l[0].format("YYYY-MM-DD"),endDate:l[1].format("YYYY-MM-DD")}:void 0)},m=[{title:b==="influencer"?"达人":b==="sample"?"样品":b==="staff"?"商务":"月份",dataIndex:"groupName",key:"groupName",width:150},{title:"合作数",dataIndex:"collaborationCount",key:"collaborationCount",width:80,align:"right"},{title:"总 GMV",dataIndex:"totalGmv",key:"totalGmv",width:120,align:"right",render:l=>`¥${P(l)}`},{title:"总成本",dataIndex:"totalCost",key:"totalCost",width:120,align:"right",render:l=>`¥${P(l)}`},{title:"ROI",dataIndex:"roi",key:"roi",width:80,align:"right",render:l=>e.jsx("span",{style:{color:l>=1?"#52c41a":"#ff4d4f"},children:te(l)})},{title:"回本率",key:"profitRate",width:100,align:"right",render:(l,h)=>`${h.collaborationCount>0?(h.profitCount/h.collaborationCount*100).toFixed(1):"0.0"}%`}];return e.jsx(ee,{title:"ROI 报表",open:a,onCancel:r,width:900,footer:null,children:e.jsxs(W,{spinning:u,children:[e.jsxs(G,{gutter:16,style:{marginBottom:16},children:[e.jsx(d,{span:8,children:e.jsx(Y,{value:b,onChange:R,style:{width:"100%"},options:Re})}),e.jsx(d,{span:16,children:e.jsx(be,{style:{width:"100%"},placeholder:["开始日期","结束日期"],onChange:x})})]}),o&&e.jsxs(G,{gutter:16,style:{marginBottom:16},children:[e.jsx(d,{span:6,children:e.jsx($,{size:"small",children:e.jsx(w,{title:"合作总数",value:o.summary.totalCollaborations,suffix:"个"})})}),e.jsx(d,{span:6,children:e.jsx($,{size:"small",children:e.jsx(w,{title:"总 GMV",value:o.summary.totalGmv/100,precision:2,prefix:"¥"})})}),e.jsx(d,{span:6,children:e.jsx($,{size:"small",children:e.jsx(w,{title:"整体 ROI",value:o.summary.overallRoi,precision:2,valueStyle:{color:o.summary.overallRoi>=1?"#52c41a":"#ff4d4f"}})})}),e.jsx(d,{span:6,children:e.jsx($,{size:"small",children:e.jsx(w,{title:"回本率",value:o.summary.profitRate,precision:1,suffix:"%",valueStyle:{color:o.summary.profitRate>=50?"#52c41a":"#ff4d4f"}})})})]}),e.jsx(ae,{columns:m,dataSource:(o==null?void 0:o.items)||[],rowKey:"groupKey",pagination:!1,scroll:{y:400},size:"small"})]})})},{Title:ve,Text:Ce}=de,{RangePicker:Ie}=U,bt=()=>{const{theme:a}=ne(),[r,u]=i.useState(!1),[y,b]=i.useState([]),[R,C]=i.useState(0),[j,o]=i.useState({page:1,pageSize:20}),[f,c]=i.useState({}),[x,m]=i.useState(null),[l,h]=i.useState(!1),[_,L]=i.useState(null),[N,B]=i.useState(!1),k=i.useCallback(async()=>{u(!0);try{const t=await he({...f,page:j.page,pageSize:j.pageSize});b(t.data),C(t.total)}catch{v.error("获取合作结果列表失败")}finally{u(!1)}},[f,j]),F=i.useCallback(async()=>{try{const t=f.startDate&&f.endDate?{startDate:f.startDate,endDate:f.endDate}:void 0,n=await ye(t);m(n)}catch(t){console.error("Failed to fetch stats:",t)}},[f.startDate,f.endDate]);i.useEffect(()=>{k()},[k]),i.useEffect(()=>{F()},[F]);const V=t=>{o({page:t.current||1,pageSize:t.pageSize||20})},s=t=>{c(t?n=>({...n,startDate:t[0].format("YYYY-MM-DD"),endDate:t[1].format("YYYY-MM-DD")}):n=>({...n,startDate:void 0,endDate:void 0})),o(n=>({...n,page:1}))},p=t=>{c(n=>({...n,profitStatus:t})),o(n=>({...n,page:1}))},I=t=>{c(n=>({...n,contentType:t})),o(n=>({...n,page:1}))},S=t=>{L(t),h(!0)},A=t=>{h(!1),L(null),t&&(k(),F())},re=[{title:"达人",key:"influencer",width:150,render:(t,n)=>{var M,J;return e.jsxs("div",{children:[e.jsx("div",{children:(M=n.collaboration)==null?void 0:M.influencer.nickname}),e.jsx(Ce,{type:"secondary",style:{fontSize:12},children:X[(J=n.collaboration)==null?void 0:J.influencer.platform]})]})}},{title:"内容类型",dataIndex:"contentType",key:"contentType",width:100,render:t=>Q[t]},{title:"发布时间",dataIndex:"publishedAt",key:"publishedAt",width:120,render:t=>Z(t).format("YYYY-MM-DD")},{title:"销售件数",dataIndex:"salesQuantity",key:"salesQuantity",width:100,align:"right"},{title:"销售GMV",dataIndex:"salesGmv",key:"salesGmv",width:120,align:"right",render:t=>`¥${P(t)}`},{title:"总成本",dataIndex:"totalCollaborationCost",key:"totalCollaborationCost",width:120,align:"right",render:t=>`¥${P(t)}`},{title:"ROI",dataIndex:"roi",key:"roi",width:80,align:"right",render:t=>te(t)},{title:"回本状态",dataIndex:"profitStatus",key:"profitStatus",width:100,render:t=>e.jsx(q,{color:se[t],children:K[t]})},{title:"复投",dataIndex:"willRepeat",key:"willRepeat",width:80,render:t=>e.jsx(q,{color:t?"green":"default",children:t?"是":"否"})},{title:"负责商务",key:"staff",width:100,render:(t,n)=>{var M;return(M=n.collaboration)==null?void 0:M.businessStaff.name}},{title:"操作",key:"action",width:80,fixed:"right",render:(t,n)=>e.jsx(H,{type:"link",size:"small",onClick:()=>S(n),children:"详情"})}];return e.jsxs("div",{style:{minHeight:"100vh",background:`linear-gradient(135deg, ${a.colors.background.secondary} 0%, ${a.colors.background.tertiary} 100%)`,position:"relative",padding:"24px",margin:"-24px"},children:[e.jsx("div",{style:{position:"absolute",top:"10%",left:"5%",width:"400px",height:"400px",background:"linear-gradient(135deg, rgba(90, 200, 250, 0.08), rgba(191, 90, 242, 0.08))",borderRadius:"50%",filter:"blur(80px)",pointerEvents:"none",zIndex:0}}),e.jsx("div",{style:{position:"absolute",top:"40%",right:"10%",width:"500px",height:"500px",background:"linear-gradient(135deg, rgba(255, 107, 107, 0.08), rgba(255, 217, 61, 0.08))",borderRadius:"50%",filter:"blur(100px)",pointerEvents:"none",zIndex:0}}),e.jsxs("div",{style:{position:"relative",zIndex:1},children:[e.jsxs(G,{justify:"space-between",align:"middle",style:{marginBottom:16},children:[e.jsx(d,{children:e.jsx(ve,{level:4,style:{margin:0},children:"合作结果"})}),e.jsx(d,{children:e.jsxs(ue,{children:[e.jsx(H,{icon:e.jsx(me,{}),onClick:()=>B(!0),children:"ROI 报表"}),e.jsx(H,{type:"primary",icon:e.jsx(pe,{}),onClick:()=>h(!0),children:"录入结果"})]})})]}),x&&e.jsxs(G,{gutter:16,style:{marginBottom:16},children:[e.jsx(d,{xs:12,sm:6,children:e.jsx(O,{variant:"elevated",hoverable:!0,children:e.jsx(E,{children:e.jsx(w,{title:"合作数量",value:x.totalCount,suffix:"个"})})})}),e.jsx(d,{xs:12,sm:6,children:e.jsx(O,{variant:"elevated",hoverable:!0,children:e.jsx(E,{children:e.jsx(w,{title:"总 GMV",value:x.totalGmv/100,precision:2,prefix:"¥"})})})}),e.jsx(d,{xs:12,sm:6,children:e.jsx(O,{variant:"elevated",hoverable:!0,children:e.jsx(E,{children:e.jsx(w,{title:"总成本",value:x.totalCost/100,precision:2,prefix:"¥"})})})}),e.jsx(d,{xs:12,sm:6,children:e.jsx(O,{variant:"elevated",hoverable:!0,children:e.jsx(E,{children:e.jsx(w,{title:"整体 ROI",value:x.overallRoi,precision:2,valueStyle:{color:x.overallRoi>=1?"#52c41a":"#ff4d4f"}})})})})]}),e.jsx(O,{variant:"elevated",style:{marginBottom:16},children:e.jsx(E,{children:e.jsxs(G,{gutter:[16,16],children:[e.jsx(d,{xs:24,sm:12,md:8,children:e.jsx(Ie,{style:{width:"100%"},placeholder:["开始日期","结束日期"],onChange:s})}),e.jsx(d,{xs:24,sm:12,md:8,children:e.jsx(Y,{placeholder:"回本状态",allowClear:!0,style:{width:"100%"},onChange:p,options:Object.entries(K).map(([t,n])=>({value:t,label:n}))})}),e.jsx(d,{xs:24,sm:12,md:8,children:e.jsx(Y,{placeholder:"内容类型",allowClear:!0,style:{width:"100%"},onChange:I,options:Object.entries(Q).map(([t,n])=>({value:t,label:n}))})})]})})}),e.jsx(ae,{columns:re,dataSource:y,rowKey:"id",loading:r,pagination:{current:j.page,pageSize:j.pageSize,total:R,showSizeChanger:!0,showQuickJumper:!0,showTotal:t=>`共 ${t} 条`},onChange:V,scroll:{x:1200}}),e.jsx(Se,{visible:l,result:_,onClose:A}),e.jsx(we,{visible:N,onClose:()=>B(!1)})]})]})};export{bt as default};
