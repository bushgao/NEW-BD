# è¾¾äººè¯¦æƒ…åŠŸèƒ½ - 500é”™è¯¯ä¿®å¤æŠ¥å‘Š(æœ€ç»ˆç‰ˆ)

**ä¿®å¤æ—¶é—´**: 2026å¹´1æœˆ7æ—¥  
**é—®é¢˜**: ç‚¹å‡»è¾¾äººè¯¦æƒ…æ—¶å‡ºç° "Request failed with status code 500" é”™è¯¯  
**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ› é—®é¢˜åˆ†æ

### é”™è¯¯ä¿¡æ¯
```
Unknown field `productCost` for select statement on model `CollaborationResult`.
Unknown field `shippingCost` for select statement on model `CollaborationResult`.
Unknown field `serviceFee` for select statement on model `CollaborationResult`.
```

### æ ¹æœ¬åŸå› 

ä»£ç å°è¯•ä» `CollaborationResult` æ¨¡å‹ä¸­è¯»å–ä¸å­˜åœ¨çš„å­—æ®µã€‚æ ¹æ®æ•°æ®åº“schema:

**âŒ é”™è¯¯çš„å­—æ®µè®¿é—®**:
```typescript
result: {
  select: {
    salesGmv: true,
    productCost: true,      // âŒ ä¸å­˜åœ¨
    shippingCost: true,     // âŒ ä¸å­˜åœ¨
    serviceFee: true,       // âŒ ä¸å­˜åœ¨
  }
}
```

**âœ… æ­£ç¡®çš„å­—æ®µ**:
```typescript
result: {
  select: {
    salesGmv: true,
    totalCollaborationCost: true,  // âœ… å­˜åœ¨
    roi: true,                      // âœ… å­˜åœ¨
  }
}
```

### Schemaè¯´æ˜

`CollaborationResult` æ¨¡å‹ä¸­çš„å®é™…å­—æ®µ:
- `salesGmv` - é”€å”®GMV
- `totalSampleCost` - æ ·å“æ€»æˆæœ¬
- `totalCollaborationCost` - åˆä½œæ€»æˆæœ¬(åŒ…å«æ ·å“+å‘ä½è´¹+ä½£é‡‘)
- `roi` - ROIå€¼
- `pitFee` - å‘ä½è´¹
- `actualCommission` - å®ä»˜ä½£é‡‘

æˆæœ¬æ˜ç»†æ•°æ®å­˜å‚¨åœ¨ `SampleDispatch` æ¨¡å‹ä¸­:
- `totalSampleCost` - æ ·å“æˆæœ¬
- `shippingCost` - å¿«é€’è´¹
- `totalCost` - æ€»æˆæœ¬

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤æ–‡ä»¶
`packages/backend/src/services/influencer.service.ts`

### ä¿®å¤å†…å®¹

#### 1. ä¿®å¤ `getCollaborationHistory` æ–¹æ³•

**ä¿®å¤å‰**:
```typescript
result: {
  select: {
    salesGmv: true,
    productCost: true,
    shippingCost: true,
    serviceFee: true,
  },
}

// è®¡ç®—æˆæœ¬
let totalCost = 0;
if (collab.result) {
  totalCost = (collab.result.productCost || 0) + 
              (collab.result.shippingCost || 0) + 
              (collab.result.serviceFee || 0);
}
```

**ä¿®å¤å**:
```typescript
result: {
  select: {
    salesGmv: true,
    totalCollaborationCost: true,
    roi: true,
  },
}

// ç›´æ¥ä½¿ç”¨æ±‡æ€»æˆæœ¬
const totalCost = collab.result?.totalCollaborationCost || 0;
```

#### 2. ä¿®å¤ `getROIStats` æ–¹æ³•

**ä¿®å¤å‰**:
```typescript
result: {
  select: {
    salesGmv: true,
    productCost: true,
    shippingCost: true,
    serviceFee: true,
  },
}

// è®¡ç®—æˆæœ¬
const cost = (collab.result.productCost || 0) + 
             (collab.result.shippingCost || 0) + 
             (collab.result.serviceFee || 0);
```

**ä¿®å¤å**:
```typescript
result: {
  select: {
    salesGmv: true,
    totalCollaborationCost: true,
    roi: true,
  },
}

// ç›´æ¥ä½¿ç”¨æ±‡æ€»æˆæœ¬
const cost = collab.result.totalCollaborationCost || 0;
```

---

## âœ… éªŒè¯ç»“æœ

### åç«¯æœåŠ¡çŠ¶æ€
- âœ… åç«¯è‡ªåŠ¨é‡å¯æˆåŠŸ
- âœ… æ— ç¼–è¯‘é”™è¯¯
- âœ… æ— 500é”™è¯¯æ—¥å¿—

### APIç«¯ç‚¹
1. `GET /api/influencers/:id/collaboration-history` - âœ… æ­£å¸¸
2. `GET /api/influencers/:id/roi-stats` - âœ… æ­£å¸¸

### å‰ç«¯åŠŸèƒ½
- âœ… ç‚¹å‡»è¾¾äººæ˜µç§°å¯æ‰“å¼€è¯¦æƒ…é¢æ¿
- âœ… ç‚¹å‡»"æŸ¥çœ‹"æŒ‰é’®å¯æ‰“å¼€è¯¦æƒ…é¢æ¿
- âœ… è¯¦æƒ…é¢æ¿æ˜¾ç¤º4ä¸ªæ ‡ç­¾é¡µ
- âœ… åˆä½œå†å²æ•°æ®æ­£å¸¸åŠ è½½
- âœ… ROIç»Ÿè®¡æ•°æ®æ­£å¸¸åŠ è½½

---

## ğŸ“Š åŠŸèƒ½è¯´æ˜

### è¾¾äººè¯¦æƒ…é¢æ¿åŒ…å«4ä¸ªæ ‡ç­¾é¡µ:

#### 1. åŸºæœ¬ä¿¡æ¯
- è¾¾äººæ˜µç§°ã€å¹³å°ã€è´¦å·ID
- æ‰‹æœºå·ã€ç±»ç›®ã€æ ‡ç­¾
- å¤‡æ³¨ä¿¡æ¯

#### 2. ROIæ•°æ®
- å¹³å‡ROI
- æ€»GMV
- æ€»æˆæœ¬
- åˆä½œæ¬¡æ•°
- æˆåŠŸç‡
- æœ€ä½³åˆä½œæ ·å“

#### 3. åˆä½œå†å²
- åˆä½œè®°å½•åˆ—è¡¨
- æ ·å“åç§°
- è´Ÿè´£å•†åŠ¡
- åˆä½œé˜¶æ®µ
- GMVã€æˆæœ¬ã€ROIæ•°æ®

#### 4. è”ç³»è®°å½•
- è·Ÿè¿›è®°å½•åˆ—è¡¨
- è·Ÿè¿›æ—¶é—´
- è·Ÿè¿›å†…å®¹

---

## ğŸ¯ æŠ€æœ¯è¦ç‚¹

### æ•°æ®æ¨¡å‹å…³ç³»

```
Collaboration (åˆä½œ)
  â”œâ”€â”€ result (CollaborationResult) - åˆä½œç»“æœ
  â”‚   â”œâ”€â”€ salesGmv - é”€å”®GMV
  â”‚   â”œâ”€â”€ totalCollaborationCost - æ€»æˆæœ¬
  â”‚   â””â”€â”€ roi - ROIå€¼
  â”‚
  â””â”€â”€ dispatches (SampleDispatch[]) - å¯„æ ·è®°å½•
      â”œâ”€â”€ totalSampleCost - æ ·å“æˆæœ¬
      â”œâ”€â”€ shippingCost - å¿«é€’è´¹
      â””â”€â”€ totalCost - æ€»æˆæœ¬
```

### æˆæœ¬è®¡ç®—é€»è¾‘

**CollaborationResult ä¸­çš„æˆæœ¬æ±‡æ€»**:
```
totalCollaborationCost = totalSampleCost + pitFee + actualCommission
```

**SampleDispatch ä¸­çš„æˆæœ¬æ˜ç»†**:
```
totalCost = totalSampleCost + shippingCost
```

---

## ğŸ“ ä½¿ç”¨æŒ‡å—

### æ‰“å¼€è¾¾äººè¯¦æƒ…çš„æ–¹å¼

1. **ç‚¹å‡»è¾¾äººæ˜µç§°**
   - åœ¨è¾¾äººåˆ—è¡¨ä¸­,ç‚¹å‡»ä»»æ„è¾¾äººçš„æ˜µç§°
   - è¯¦æƒ…é¢æ¿ä»å³ä¾§æ»‘å‡º

2. **ç‚¹å‡»"æŸ¥çœ‹"æŒ‰é’®**
   - åœ¨è¾¾äººåˆ—è¡¨çš„æ“ä½œåˆ—
   - ç‚¹å‡»"æŸ¥çœ‹"æŒ‰é’®
   - è¯¦æƒ…é¢æ¿ä»å³ä¾§æ»‘å‡º

### æŸ¥çœ‹æ•°æ®

- **åŸºæœ¬ä¿¡æ¯**: é»˜è®¤æ˜¾ç¤º
- **ROIæ•°æ®**: ç‚¹å‡»"ROIæ•°æ®"æ ‡ç­¾é¡µ
- **åˆä½œå†å²**: ç‚¹å‡»"åˆä½œå†å²"æ ‡ç­¾é¡µ
- **è”ç³»è®°å½•**: ç‚¹å‡»"è”ç³»è®°å½•"æ ‡ç­¾é¡µ

### å…³é—­è¯¦æƒ…é¢æ¿

- ç‚¹å‡»é¢æ¿å³ä¸Šè§’çš„"Ã—"æŒ‰é’®
- ç‚¹å‡»é¢æ¿å¤–çš„é®ç½©å±‚

---

## ğŸ” ç›¸å…³æ–‡ä»¶

### åç«¯æ–‡ä»¶
- `packages/backend/src/services/influencer.service.ts` - ä¿®å¤çš„æœåŠ¡æ–‡ä»¶
- `packages/backend/src/routes/influencer.routes.ts` - APIè·¯ç”±
- `packages/backend/prisma/schema.prisma` - æ•°æ®åº“schema

### å‰ç«¯æ–‡ä»¶
- `packages/frontend/src/pages/Influencers/InfluencerDetailPanel.tsx` - è¯¦æƒ…é¢æ¿ç»„ä»¶
- `packages/frontend/src/pages/Influencers/index.tsx` - è¾¾äººåˆ—è¡¨é¡µé¢
- `packages/frontend/src/services/influencer.service.ts` - å‰ç«¯APIæœåŠ¡

### æ–‡æ¡£æ–‡ä»¶
- `è¾¾äººè¯¦æƒ…å¢å¼º-ä½¿ç”¨æŒ‡å—.md` - åŠŸèƒ½ä½¿ç”¨æŒ‡å—
- `Day7-è¾¾äººè¯¦æƒ…å¢å¼ºåŠŸèƒ½å®ŒæˆæŠ¥å‘Š.md` - åŠŸèƒ½å®ŒæˆæŠ¥å‘Š
- `test-influencer-detail.js` - æµ‹è¯•è„šæœ¬

---

## âœ¨ æ€»ç»“

æœ¬æ¬¡ä¿®å¤è§£å†³äº†è¾¾äººè¯¦æƒ…åŠŸèƒ½çš„500é”™è¯¯é—®é¢˜ã€‚é—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ä»£ç å°è¯•è®¿é—®æ•°æ®åº“æ¨¡å‹ä¸­ä¸å­˜åœ¨çš„å­—æ®µã€‚

**ä¿®å¤è¦ç‚¹**:
1. ä½¿ç”¨ `totalCollaborationCost` å­—æ®µè·å–åˆä½œæ€»æˆæœ¬
2. é¿å…æ‰‹åŠ¨è®¡ç®—æˆæœ¬,ç›´æ¥ä½¿ç”¨æ•°æ®åº“ä¸­çš„æ±‡æ€»å­—æ®µ
3. ç¡®ä¿ä»£ç ä¸æ•°æ®åº“schemaä¿æŒä¸€è‡´

**åŠŸèƒ½çŠ¶æ€**: âœ… å®Œå…¨æ­£å¸¸,å¯ä»¥æŠ•å…¥ä½¿ç”¨

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2026å¹´1æœˆ7æ—¥ 15:45  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡  
**éƒ¨ç½²çŠ¶æ€**: âœ… å·²éƒ¨ç½²
