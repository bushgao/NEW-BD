# 开发规范 - 架构一致性原则

**创建时间**: 2026-01-08  
**重要性**: ⭐⭐⭐⭐⭐ 极其重要  
**适用范围**: 所有新功能开发

---

## 核心原则

### ⚠️ 架构一致性 > 任务描述

**在实现任何新功能时，保持与现有代码的架构一致性比机械遵循任务描述更重要。**

---

## 实施流程（强制执行）

### 步骤 1: 找参考（必须）
在开始编码前，**必须**在项目中找到一个类似的、工作正常的功能作为参考。

**示例**：
- 要实现新的报表页面 → 参考 `packages/frontend/src/pages/Reports/index.tsx`
- 要实现新的数据可视化 → 参考现有的图表组件
- 要实现新的API → 参考现有的service和route文件

### 步骤 2: 理解架构（必须）
仔细分析参考代码的：
- 文件组织结构
- 调用链路（Page → Service → API → Backend）
- 错误处理方式
- 状态管理方式
- UI组件使用方式

### 步骤 3: 遵循模式（必须）
严格按照参考代码的模式实现新功能，包括：
- 相同的文件组织
- 相同的调用链路
- 相同的错误处理
- 相同的UI风格

### 步骤 4: 质疑任务（允许）
如果任务描述与项目架构冲突：
- ✅ 优先遵循项目架构
- ✅ 可以调整任务描述
- ✅ 在完成报告中说明调整原因

---

## 本项目的架构模式

### 前端架构

#### 报表类页面标准模式
```
Page Component (pages/XXX/index.tsx)
    ↓ 调用
Service Layer (services/report.service.ts)
    ↓ 调用
API Utility (services/api.ts)
    ↓ 请求
Backend API
```

**关键点**：
1. **Page Component** 负责：
   - UI布局和交互
   - 使用 `useTheme()` 获取主题
   - 使用 `Card` 和 `CardContent` 组件
   - 使用 `message.error()` 处理错误
   - 调用 Service Layer 函数

2. **Service Layer** 负责：
   - 定义 TypeScript 类型
   - 封装 API 调用
   - 处理数据转换
   - 导出给 Page Component 使用

3. **不要**：
   - ❌ 在 Page Component 中直接调用 `api.get()`
   - ❌ 在 `components/charts/` 中创建完整的页面逻辑
   - ❌ 绕过 Service Layer

#### 参考文件
- **标准页面**: `packages/frontend/src/pages/Reports/index.tsx`
- **服务层**: `packages/frontend/src/services/report.service.ts`
- **API工具**: `packages/frontend/src/services/api.ts`

---

## 错误案例分析

### 案例：跟进分析功能（2026-01-08）

#### ❌ 错误做法
```typescript
// 在 components/charts/FollowUpAnalytics.tsx 中
const FollowUpAnalytics: React.FC = () => {
  // 直接调用 API
  const response = await api.get('/collaborations/follow-up-analytics');
  // ...
}
```

**问题**：
1. 绕过了 Service Layer
2. 组件承担了过多职责
3. 与项目其他页面架构不一致
4. 导致难以调试的问题

#### ✅ 正确做法
```typescript
// 1. 在 services/report.service.ts 中
export async function getFollowUpAnalytics(period, staffId) {
  const response = await api.get('/collaborations/follow-up-analytics', { params });
  return response.data.data;
}

// 2. 在 pages/FollowUpAnalytics/index.tsx 中
const FollowUpAnalyticsPage = () => {
  const data = await getFollowUpAnalytics(selectedPeriod);
  // ...
}
```

**优点**：
1. 遵循项目架构
2. 职责清晰
3. 易于维护和调试
4. 与其他页面一致

---

## 调试原则

### 快速失败，快速调整

如果一个方向尝试 **3次** 还不行：
1. ❌ 不要继续在同一方向上深挖
2. ✅ 立即停下来
3. ✅ 对比一个工作正常的类似功能
4. ✅ 检查架构差异
5. ✅ 考虑重构

### 调试优先级
1. **架构层面** - 是否遵循了项目架构？
2. **参考对比** - 与工作正常的功能有什么不同？
3. **具体问题** - token、配置等具体问题

---

## 检查清单

在提交代码前，确认：

- [ ] 我找到了类似功能作为参考
- [ ] 我理解了参考代码的架构模式
- [ ] 我的实现遵循了相同的架构模式
- [ ] 文件组织与参考代码一致
- [ ] 调用链路与参考代码一致
- [ ] 错误处理与参考代码一致
- [ ] UI风格与参考代码一致
- [ ] 如果调整了任务描述，我在报告中说明了原因

---

## 总结

**记住这句话**：

> 当任务描述与项目架构冲突时，永远选择架构一致性。
> 
> 机械执行任务 = 制造技术债务
> 
> 理解架构后执行 = 高质量代码

---

**最后更新**: 2026-01-08  
**教训来源**: Task 26 跟进分析功能实现
