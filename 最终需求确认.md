# 最终需求确认文档

## ✅ 核心商业逻辑（已明确）

### 目标客户群体扩展

**当前问题**：
- 只有工厂购买 → 个人商务无法使用 → 流失潜在客户

**解决方案**：
- 支持个人商务独立注册购买
- 支持工厂团队购买
- 两种模式并存，互不冲突

---

## 📋 独立商务账号详细设计

### 1. 独立商务的完整权限

**核心原则**：独立商务 = 单人版的完整系统

**可以使用的功能**：
- ✅ 达人管理（添加、编辑、删除达人）
- ✅ 合作管道（创建合作、跟进、推进阶段）
- ✅ 样品管理（创建样品、记录寄样）
- ✅ 合作结果（录入结果、查看 ROI）
- ✅ 数据报表（查看自己的数据统计）
- ✅ 通知消息（接收系统通知）

**不能使用的功能**：
- ❌ 团队协作（没有其他成员）
- ❌ 查看其他人的数据
- ❌ 共享样品库（样品只属于自己）

**数据隔离**：
- 独立商务只能看到自己创建的达人和合作
- 加入工厂后，数据迁移到工厂（与团队共享）

### 2. 用户体验设计

**注册流程**：
```
访问注册页 
→ 选择角色：
   - 工厂老板（创建工厂团队）
   - 商务人员（个人使用）
→ 填写信息
→ 注册成功
```

**独立商务登录后**：
```
Dashboard 显示：
┌─────────────────────────────────────┐
│ 欢迎，张三                           │
│ 您正在使用个人版                     │
│                                     │
│ 💡 提示：加入工厂团队，享受协作功能   │
│ [输入邀请码] [浏览工厂]              │
└─────────────────────────────────────┘

正常的工作台内容...
```

**工厂商务登录后**：
```
Dashboard 显示：
┌─────────────────────────────────────┐
│ 欢迎，李四                           │
│ 所属工厂：ABC 工厂                   │
│ 团队成员：5 人                       │
└─────────────────────────────────────┘

正常的工作台内容...
```

---

## 🔗 工厂加入机制

### 方式 1：邀请码机制（优先实现）

**流程**：
```
工厂老板端：
1. 进入"团队管理"
2. 点击"生成邀请码"
3. 系统生成：ABC123（有效期 7 天）
4. 复制邀请码发给商务

商务端：
1. 登录后看到"输入邀请码"入口
2. 输入：ABC123
3. 系统验证 → 显示工厂信息
4. 确认加入 → 数据迁移 → 加入成功
```

**技术实现**：
- 邀请码：6 位随机字符串
- 有效期：7 天
- 使用次数：可配置（1 次或多次）
- 存储：InviteCode 表

### 方式 2：主动申请机制（后续实现）

**流程**：
```
商务端：
1. 点击"浏览工厂"
2. 搜索/浏览工厂列表
3. 选择工厂 → 申请加入
4. 填写申请理由
5. 等待审批

工厂老板端：
1. 收到申请通知
2. 查看申请人信息
3. 批准/拒绝
4. 商务收到通知
```

**实施建议**：
- 第一阶段：只做邀请码（简单快速）
- 第二阶段：加入申请机制（更灵活）

---

## 💾 数据迁移逻辑

### 加入工厂时的数据处理

**迁移的数据**：
- 达人信息 → 归属到工厂（factoryId 更新）
- 合作记录 → 归属到工厂（factoryId 更新）
- 样品寄送记录 → 归属到工厂
- 合作结果 → 归属到工厂

**保留的数据**：
- 用户个人信息（姓名、邮箱）
- 用户个人设置

**重要提示**：
```
⚠️ 加入工厂后的变化：

✅ 您的达人和合作数据将与工厂团队共享
✅ 您可以使用工厂的样品库
✅ 您可以查看团队的数据报表

❌ 此操作不可撤销
❌ 加入后无法恢复为独立账号

确定要加入"ABC 工厂"吗？
[取消] [确认加入]
```

### 离开工厂的处理

**是否支持离开工厂？**

**方案 A：不支持离开**（推荐）
- 加入工厂是单向操作
- 数据已与团队共享，无法分离
- 如需离开，只能由工厂老板删除账号

**方案 B：支持离开**（复杂）
- 离开时数据如何处理？
  - 选项 1：数据留在工厂（商务失去访问权）
  - 选项 2：数据跟随商务（工厂失去数据）
- 容易产生纠纷

**建议**：采用方案 A，不支持离开工厂

---

## 💰 套餐体系调整

### 新的套餐结构

#### 个人版（独立商务）

**基础版**：¥99/月
- 1 个商务账号
- 50 个达人
- 无限合作记录
- 数据保留 30 天
- 基础报表

**专业版**：¥199/月
- 1 个商务账号
- 200 个达人
- 无限合作记录
- 数据保留 90 天
- 高级报表

#### 团队版（工厂）

**免费版**：¥0/月
- 3 个商务账号
- 50 个达人
- 无限合作记录
- 数据保留 30 天
- 基础报表

**专业版**：¥299/月
- 10 个商务账号
- 200 个达人
- 无限合作记录
- 数据保留 90 天
- 高级报表
- 样品管理

**企业版**：¥999/月
- 无限商务账号
- 无限达人
- 无限合作记录
- 数据保留 365 天
- 高级报表
- 样品管理
- 专属客服

### 升级路径

```
独立商务（基础版）
  ↓ 升级
独立商务（专业版）
  ↓ 加入工厂
工厂商务（团队版）
  ↓ 工厂升级套餐
工厂商务（更高配额）
```

---

## 🗄️ 数据库 Schema 调整

### User 表调整

```prisma
model User {
  id              String    @id @default(uuid()) @db.Uuid
  email           String    @unique
  passwordHash    String
  name            String
  role            UserRole  // PLATFORM_ADMIN, FACTORY_OWNER, BUSINESS_STAFF
  
  // 工厂关联（可为空）
  factoryId       String?   @db.Uuid
  factory         Factory?  @relation("FactoryStaff", fields: [factoryId], references: [id])
  
  // 加入工厂的时间
  factoryJoinedAt DateTime?
  
  // 个人套餐（独立商务使用）
  personalPlan    PlanType? // FREE, PROFESSIONAL, ENTERPRISE
  
  // 配额（独立商务使用）
  influencerLimit Int       @default(50)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // 关联
  ownedFactory    Factory?  @relation("FactoryOwner")
  influencers     Influencer[]
  collaborations  Collaboration[]
  
  @@index([factoryId])
  @@index([email])
}
```

### InviteCode 表（新增）

```prisma
model InviteCode {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique // 6位随机码
  factoryId   String   @db.Uuid
  factory     Factory  @relation(fields: [factoryId], references: [id])
  
  createdBy   String   @db.Uuid // 创建人（工厂老板）
  creator     User     @relation(fields: [createdBy], references: [id])
  
  expiresAt   DateTime // 过期时间
  maxUses     Int      @default(1) // 最大使用次数
  usedCount   Int      @default(0) // 已使用次数
  
  status      String   @default("ACTIVE") // ACTIVE, EXPIRED, DISABLED
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // 使用记录
  uses        InviteCodeUse[]
  
  @@index([code])
  @@index([factoryId])
}

model InviteCodeUse {
  id           String     @id @default(uuid()) @db.Uuid
  inviteCodeId String     @db.Uuid
  inviteCode   InviteCode @relation(fields: [inviteCodeId], references: [id])
  
  userId       String     @db.Uuid
  user         User       @relation(fields: [userId], references: [id])
  
  usedAt       DateTime   @default(now())
  
  @@index([inviteCodeId])
  @@index([userId])
}
```

### FactoryApplication 表（新增，可选）

```prisma
model FactoryApplication {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @db.Uuid
  user        User     @relation(fields: [userId], references: [id])
  
  factoryId   String   @db.Uuid
  factory     Factory  @relation(fields: [factoryId], references: [id])
  
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  message     String?  // 申请留言
  replyMessage String? // 回复留言
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  reviewedAt  DateTime?
  reviewedBy  String?  @db.Uuid
  
  @@unique([userId, factoryId])
  @@index([factoryId, status])
}
```

---

## 🎯 实施优先级（最终版）

### P0 - 立即修复（1-2 天）
1. ✅ 工厂审核状态显示
2. ✅ 后端配额检查（防止超限）
3. ✅ 前端配额显示

### P1 - 高优先级（2-3 天）
4. ✅ 商务账号配额管理页面
5. ✅ 独立商务注册流程
6. ✅ 邀请码机制

### P2 - 中优先级（3-5 天）
7. ✅ 数据迁移逻辑
8. ✅ 独立商务 Dashboard 调整
9. ✅ 套餐体系调整

### P3 - 低优先级（后续迭代）
10. 工厂申请机制
11. 工厂浏览页面
12. 套餐购买流程

---

## 📝 开发任务清单

### 阶段 1：核心修复（问题 1-2）

**前端**：
- [ ] Dashboard 添加工厂状态横幅
- [ ] 侧边栏显示工厂状态和套餐
- [ ] Dashboard 显示配额使用情况
- [ ] 添加达人/商务按钮禁用逻辑

**后端**：
- [ ] 创建商务账号时检查配额
- [ ] 创建达人时检查配额
- [ ] 返回配额信息 API

### 阶段 2：商务账号管理（问题 3）

**前端**：
- [ ] 新增团队管理页面
- [ ] 显示商务账号列表
- [ ] 添加/禁用/删除商务账号

**后端**：
- [ ] 获取工厂商务列表 API
- [ ] 创建商务账号 API（工厂老板权限）
- [ ] 禁用/启用商务账号 API
- [ ] 删除商务账号 API

### 阶段 3：独立商务与邀请码（问题 4）

**数据库**：
- [ ] User 表添加 personalPlan, influencerLimit 字段
- [ ] 创建 InviteCode 表
- [ ] 创建 InviteCodeUse 表
- [ ] 数据迁移脚本

**后端**：
- [ ] 修改注册逻辑（支持独立商务）
- [ ] 生成邀请码 API
- [ ] 验证邀请码 API
- [ ] 使用邀请码加入工厂 API
- [ ] 数据迁移逻辑

**前端**：
- [ ] 注册页面调整（不强制选工厂）
- [ ] 独立商务 Dashboard
- [ ] 邀请码输入界面
- [ ] 工厂老板生成邀请码界面
- [ ] 加入工厂确认弹窗

---

## ✅ 最终确认

- ✅ 独立商务拥有完整功能（除样品管理）
- ✅ 支持邀请码加入工厂
- ✅ 后续可选支持申请机制
- ✅ 加入工厂后数据迁移
- ✅ 不支持离开工厂
- ✅ 个人版和团队版套餐并存

准备开始实施！
