# 商务权限模板识别问题修复报告

## 问题描述

用户报告：选择权限模板（如"高级商务"）并保存后，再次打开权限设置弹窗时，显示的模板变成了"自定义"。

## 问题原因

`identifyTemplate` 函数使用 `JSON.stringify` 比较权限对象：

```typescript
// 原始代码（有问题）
if (JSON.stringify(permissions) === JSON.stringify(template.permissions)) {
  return templateId as PermissionTemplateId;
}
```

**问题**：JavaScript 对象的属性顺序可能不一致，导致相同的权限被识别为"自定义"。

例如：
- 保存时：`{"a": 1, "b": 2}`
- 读取时：`{"b": 2, "a": 1}`
- JSON.stringify 结果不同，但实际权限相同

## 修复方案

改为深度比较每个字段，而不是依赖 JSON 序列化：

```typescript
/**
 * 深度比较两个权限对象是否相等
 */
function deepEqualPermissions(a: StaffPermissions, b: StaffPermissions): boolean {
  // 比较 dataVisibility
  if (
    a.dataVisibility.viewOthersInfluencers !== b.dataVisibility.viewOthersInfluencers ||
    a.dataVisibility.viewOthersCollaborations !== b.dataVisibility.viewOthersCollaborations ||
    a.dataVisibility.viewOthersPerformance !== b.dataVisibility.viewOthersPerformance ||
    a.dataVisibility.viewTeamData !== b.dataVisibility.viewTeamData ||
    a.dataVisibility.viewRanking !== b.dataVisibility.viewRanking
  ) {
    return false;
  }

  // 比较 operations
  if (
    a.operations.manageInfluencers !== b.operations.manageInfluencers ||
    a.operations.manageSamples !== b.operations.manageSamples ||
    a.operations.manageCollaborations !== b.operations.manageCollaborations ||
    a.operations.deleteCollaborations !== b.operations.deleteCollaborations ||
    a.operations.exportData !== b.operations.exportData ||
    a.operations.batchOperations !== b.operations.batchOperations
  ) {
    return false;
  }

  // 比较 advanced
  if (
    a.advanced.viewCostData !== b.advanced.viewCostData ||
    a.advanced.viewROIData !== b.advanced.viewROIData ||
    a.advanced.modifyOthersData !== b.advanced.modifyOthersData
  ) {
    return false;
  }

  return true;
}

/**
 * 识别权限模板
 */
export function identifyTemplate(permissions: StaffPermissions): PermissionTemplateId {
  // 检查是否匹配预设模板
  for (const [templateId, template] of Object.entries(PERMISSION_TEMPLATES)) {
    if (templateId === 'custom') continue;
    
    if (deepEqualPermissions(permissions, template.permissions)) {
      return templateId as PermissionTemplateId;
    }
  }
  
  return 'custom';
}
```

## 修复文件

- `packages/backend/src/types/permissions.ts` - 修复 `identifyTemplate` 函数

## 测试验证

创建了专门的测试脚本 `test-template-recognition.js`，测试以下场景：

### 测试场景

1. **基础商务模板识别**
   - 应用基础商务模板
   - 重新获取权限
   - 验证识别为 `basic`

2. **高级商务模板识别**
   - 应用高级商务模板
   - 重新获取权限
   - 验证识别为 `advanced`

3. **团队主管模板识别**
   - 应用团队主管模板
   - 重新获取权限
   - 验证识别为 `supervisor`

4. **自定义权限识别**
   - 应用自定义权限（修改一个字段）
   - 验证识别为 `custom`

5. **字段顺序不影响识别**
   - 应用字段顺序不同的基础商务权限
   - 验证仍然识别为 `basic`

### 测试结果

```
=== 权限模板识别测试 ===

1. 工厂老板登录...
✓ 工厂老板登录成功

2. 获取商务人员ID...
✓ 商务ID: 385298fb-1b8e-4843-a083-5e086a84b61c

--- 测试模板: basic ---
  模板名称: 基础商务
  模板描述: 只能管理自己的数据，不能查看其他商务详情，不能管理样品
  应用模板权限...
  ✓ 权限更新成功，返回模板: basic
  重新获取权限...
  ✓ 获取权限成功，识别模板: basic
  ✓ 模板 basic 识别正确

--- 测试模板: advanced ---
  模板名称: 高级商务
  模板描述: 可以管理样品，可以查看其他商务业绩（学习用）
  应用模板权限...
  ✓ 权限更新成功，返回模板: advanced
  重新获取权限...
  ✓ 获取权限成功，识别模板: advanced
  ✓ 模板 advanced 识别正确

--- 测试模板: supervisor ---
  模板名称: 团队主管
  模板描述: 可以查看所有数据，拥有最高权限（仅次于工厂老板）
  应用模板权限...
  ✓ 权限更新成功，返回模板: supervisor
  重新获取权限...
  ✓ 获取权限成功，识别模板: supervisor
  ✓ 模板 supervisor 识别正确

--- 测试自定义权限 ---
  应用自定义权限...
  ✓ 权限更新成功，返回模板: custom
  ✓ 自定义权限识别正确

--- 测试字段顺序不同的情况 ---
  应用字段顺序不同的基础商务权限...
  ✓ 权限更新成功，返回模板: basic
  ✓ 字段顺序不同时仍能正确识别模板

=== 所有测试通过 ✓ ===

功能验证：
✓ 基础商务模板识别正确
✓ 高级商务模板识别正确
✓ 团队主管模板识别正确
✓ 自定义权限识别正确
✓ 字段顺序不影响模板识别
✓ 保存后重新打开能正确显示模板
```

## 修复效果

✅ **问题已解决**

- 选择"基础商务"模板并保存后，重新打开显示"基础商务"
- 选择"高级商务"模板并保存后，重新打开显示"高级商务"
- 选择"团队主管"模板并保存后，重新打开显示"团队主管"
- 自定义权限正确识别为"自定义"
- 字段顺序不影响模板识别

## 用户体验改进

1. **模板识别准确**：保存后重新打开，模板选择正确显示
2. **字段顺序无关**：无论数据库中字段顺序如何，都能正确识别
3. **自定义识别**：修改任何一个权限后，自动识别为"自定义"

## 测试命令

```bash
# 运行权限功能测试
node test-permissions.js

# 运行模板识别专项测试
node test-template-recognition.js
```

## 总结

通过将 JSON 字符串比较改为深度字段比较，彻底解决了模板识别问题。现在用户可以放心地选择权限模板，保存后重新打开时会正确显示所选的模板。
