# 商务列表API修复完成报告

**修复时间**: 2026-01-10  
**问题**: 获取商务账号列表失败 (400错误)  
**根本原因**: 服务层代码仍使用旧角色名 `BUSINESS_STAFF`，与数据库schema不匹配

---

## 🔍 问题诊断

### 错误现象
- 前端"团队管理"页面显示"获取商务账号列表失败"
- API返回400错误

### 根本原因
数据库schema已更新为新角色名，但多个服务文件仍使用旧名称：
- ✅ Schema: `BUSINESS` (正确)
- ❌ Service层: `BUSINESS_STAFF` (错误)

---

## 🔧 修复内容

### 1. staff-management.service.ts (7处修复)
```typescript
// 修复前: role: 'BUSINESS_STAFF'
// 修复后: role: 'BUSINESS'
```

修复的函数:
- `getStaffPermissions()` - 获取商务权限
- `updateStaffPermissions()` - 更新商务权限
- `listStaff()` - 获取商务列表 (2处)
- `getStaffDetail()` - 获取商务详情
- `updateStaffStatus()` - 更新商务状态
- `deleteStaff()` - 删除商务账号
- `createStaff()` - 创建商务账号

### 2. platform.service.ts (2处修复)
- 获取工厂商务列表查询
- 商务角色验证

### 3. collaboration.service.ts (3处修复)
- `listCollaborations()` - 合作列表权限过滤
- `getPipelineView()` - 管道视图权限过滤
- `getFollowUpTasks()` - 跟进任务权限过滤

### 4. platform.routes.ts (1处修复)
- 用户列表API的角色验证规则
- 从 `['PLATFORM_ADMIN', 'FACTORY_OWNER', 'BUSINESS_STAFF']`
- 改为 `['PLATFORM_ADMIN', 'BRAND', 'BUSINESS']`

---

## ✅ 验证结果

### 测试执行
```bash
node test-staff-list.js
```

### 测试结果 ✅ 通过
```
1️⃣ 登录品牌账号...
✅ 登录成功
   用户ID: d59d05d8-4065-4bb6-90e6-7194c1ca9640
   角色: BRAND
   工厂ID: 5e51a9ad-6903-4c48-a635-3399e89ff9a4

2️⃣ 获取商务账号列表...
   状态码: 200
✅ 获取商务列表成功
   总数: 0
   当前页: 1
   每页数量: 10
   总页数: 0

3️⃣ 获取配额信息...
✅ 配额信息:
   商务账号: 1 / 3
   达人数量: 5 / 100

✅ 所有测试通过！
```

**说明**:
- API返回200状态码，修复成功
- 当前工厂暂无商务账号 (total: 0)
- 配额显示1/3是因为包含了品牌老板账号本身
- 可以通过"团队管理"页面添加商务账号

---

## ✅ 验证步骤

### 1. 重启后端服务
```bash
cd packages/backend
npm run dev
```

### 2. 运行测试脚本
```bash
node test-staff-list.js
```

### 3. 浏览器测试
1. 清除浏览器localStorage (重要!)
2. 使用 `pinpai001@gmail.com` / `password123` 登录
3. 访问"团队管理"页面
4. 验证商务列表正常显示

---

## 📊 修复统计

| 文件 | 修复数量 | 类型 |
|------|---------|------|
| staff-management.service.ts | 7处 | 核心服务 |
| platform.service.ts | 2处 | 平台服务 |
| collaboration.service.ts | 3处 | 合作服务 |
| platform.routes.ts | 1处 | 路由验证 |
| **总计** | **13处** | |

---

## ⚠️ 重要提醒

### 必须清除浏览器缓存
修复后端后，**必须清除浏览器localStorage**，否则旧token会导致问题：

1. 打开浏览器开发者工具 (F12)
2. Application → Local Storage
3. 删除所有存储项
4. 刷新页面重新登录

### 测试账号
- **品牌账号**: pinpai001@gmail.com / password123
- **角色**: BRAND (原FACTORY_OWNER)

---

## 🎯 下一步

所有角色名称已统一为:
- ✅ `PLATFORM_ADMIN` - 平台管理员
- ✅ `BRAND` - 品牌方/工厂老板
- ✅ `BUSINESS` - 商务人员

如遇到其他API错误，请检查是否还有遗漏的旧角色名引用。
