# 问题验证报告

## 问题 1：工厂老板看不到审核状态

### 当前状态
✅ **后端已实现** - 工厂状态字段存在（PENDING/APPROVED/REJECTED/SUSPENDED）
❌ **前端未显示** - Dashboard 和 MainLayout 都没有显示工厂审核状态

### 问题分析
1. 工厂老板登录后，无法看到自己工厂的审核状态
2. 如果工厂状态为 PENDING（待审核），老板应该看到提示信息
3. 如果工厂状态为 REJECTED（已拒绝），老板应该看到拒绝原因
4. 如果工厂状态为 SUSPENDED（已暂停），老板应该看到暂停提示

### 影响范围
- 工厂老板无法知道自己的工厂是否通过审核
- 待审核状态下，老板可能尝试使用功能但不知道为什么受限
- 用户体验差，缺少必要的状态反馈

### 解决方案
需要在以下位置添加工厂状态显示：

1. **Dashboard 顶部横幅**
   - PENDING: 显示橙色提示"您的工厂正在审核中，请耐心等待"
   - REJECTED: 显示红色提示"您的工厂申请未通过审核"
   - SUSPENDED: 显示灰色提示"您的工厂已被暂停"
   - APPROVED: 不显示（正常状态）

2. **MainLayout 侧边栏底部**
   - 显示工厂状态标签
   - 显示当前套餐类型

---

## 问题 2：套餐限制没有准确隔离

### 当前状态
✅ **后端已实现** - `validateQuota()` 函数检查配额
❌ **前端未限制** - 前端没有根据套餐限制禁用功能
❌ **后端未全面应用** - 并非所有创建操作都调用了配额检查

### 问题分析

#### 套餐配置（来自 schema.prisma）
```
FREE 版：
- staffLimit: 3 个商务账号
- influencerLimit: 50 个达人
- dataRetentionDays: 30 天

PROFESSIONAL 版：
- staffLimit: 10 个商务账号
- influencerLimit: 200 个达人
- dataRetentionDays: 90 天

ENTERPRISE 版：
- staffLimit: 无限制（9999）
- influencerLimit: 无限制（9999）
- dataRetentionDays: 365 天
```

#### 当前实现情况

**后端配额检查：**
- ✅ `platform.service.ts` 有 `validateQuota()` 函数
- ❌ 创建商务账号时未调用配额检查
- ❌ 创建达人时未调用配额检查
- ❌ 数据保留期限未实现

**前端限制：**
- ❌ 添加商务账号按钮未根据配额禁用
- ❌ 添加达人按钮未根据配额禁用
- ❌ 没有显示当前使用量/配额上限

### 影响范围
1. 工厂可以超出套餐限制添加商务账号和达人
2. 套餐升级没有实际意义（限制不生效）
3. 平台无法通过套餐差异化实现商业模式

### 解决方案

#### 后端修改
1. **在创建商务账号时添加配额检查**
   - 文件：`packages/backend/src/routes/auth.routes.ts`
   - 在注册商务账号前调用 `validateQuota(factoryId, 'staff')`

2. **在创建达人时添加配额检查**
   - 文件：`packages/backend/src/services/influencer.service.ts`
   - 在创建达人前调用 `validateQuota(factoryId, 'influencer')`

3. **实现数据保留期限**
   - 添加定时任务清理超期数据
   - 或在查询时过滤超期数据

#### 前端修改
1. **获取工厂配额信息**
   - 在登录后获取工厂详情（包含配额信息）
   - 存储到 authStore 中

2. **Dashboard 显示配额使用情况**
   - 显示"商务账号：3/10"
   - 显示"达人数量：45/200"
   - 使用进度条可视化

3. **按钮禁用逻辑**
   - 达到上限时禁用"添加商务账号"按钮
   - 达到上限时禁用"添加达人"按钮
   - 显示提示"已达上限，请升级套餐"

4. **套餐升级入口**
   - 在 Dashboard 添加"升级套餐"按钮
   - 点击后显示套餐对比和升级流程

---

## 验证步骤

### 问题 1 验证
1. 注册一个新工厂老板账号
2. 登录后查看 Dashboard
3. 检查是否显示"待审核"状态提示
4. 使用平台管理员账号审核通过
5. 工厂老板刷新页面，提示应该消失

### 问题 2 验证
1. 使用 FREE 版工厂账号登录
2. 尝试添加第 4 个商务账号（应该被拒绝）
3. 尝试添加第 51 个达人（应该被拒绝）
4. 检查前端是否显示配额使用情况
5. 检查按钮是否在达到上限时禁用

---

## 优先级建议

### 高优先级（影响用户体验）
1. ✅ 问题 1 - 工厂审核状态显示
2. ✅ 问题 2 - 后端配额检查

### 中优先级（完善功能）
3. 前端配额显示和按钮禁用
4. 套餐升级流程

### 低优先级（长期优化）
5. 数据保留期限实现
6. 配额预警通知

---

## 下一步行动

建议按以下顺序修复：

1. **立即修复**：添加工厂状态显示（前端）
2. **立即修复**：添加后端配额检查（后端）
3. **后续完善**：前端配额显示和限制
4. **后续完善**：套餐升级流程
